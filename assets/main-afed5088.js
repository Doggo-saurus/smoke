(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();var De=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class Nr{constructor(e){this.messageBus=e}get id(){if(!this.messageBus.userId)throw Error("Unable to get user ID: not ready");return this.messageBus.userId}getSelection(){return De(this,void 0,void 0,function*(){const{selection:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_SELECTION",{});return e})}select(e,t){return De(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:e,replace:t})})}deselect(e){return De(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_DESELECt",{items:e})})}getName(){return De(this,void 0,void 0,function*(){const{name:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_NAME",{});return e})}setName(e){return De(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_NAME",{name:e})})}getColor(){return De(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_COLOR",{});return e})}setColor(e){return De(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_COLOR",{color:e})})}getSyncView(){return De(this,void 0,void 0,function*(){const{syncView:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_SYNC_VIEW",{});return e})}setSyncView(e){return De(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_SYNC_VIEW",{syncView:e})})}getId(){return De(this,void 0,void 0,function*(){const{id:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_ID",{});return e})}getRole(){return De(this,void 0,void 0,function*(){const{role:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_ROLE",{});return e})}getMetadata(){return De(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_METADATA",{});return e})}setMetadata(e){return De(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_METADATA",{update:e})})}hasPermission(e){return De(this,void 0,void 0,function*(){if((yield this.getRole())==="GM")return!0;const{permissions:i}=yield this.messageBus.sendAsync("OBR_ROOM_GET_PERMISSIONS",{});return i.indexOf(e)===-1})}getConnectionId(){return De(this,void 0,void 0,function*(){const{connectionId:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_CONNECTION_ID",{});return e})}onChange(e){const t=i=>{e(i.player)};return this.messageBus.send("OBR_PLAYER_SUBSCRIBE",{}),this.messageBus.on("OBR_PLAYER_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_PLAYER_UNSUBSCRIBE",{}),this.messageBus.off("OBR_PLAYER_EVENT_CHANGE",t)}}}var qe=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class xr{constructor(e){this.messageBus=e}reset(){return qe(this,void 0,void 0,function*(){const{transform:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_RESET",{});return e})}animateTo(e){return qe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_ANIMATE_TO",{transform:e})})}animateToBounds(e){return qe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_ANIMATE_TO_BOUNDS",{bounds:e})})}getPosition(){return qe(this,void 0,void 0,function*(){const{position:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_POSITION",{});return e})}setPosition(e){return qe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_SET_POSITION",{position:e})})}getScale(){return qe(this,void 0,void 0,function*(){const{scale:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_SCALE",{});return e})}setScale(e){return qe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_SET_SCALE",{scale:e})})}getWidth(){return qe(this,void 0,void 0,function*(){const{width:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_WIDTH",{});return e})}getHeight(){return qe(this,void 0,void 0,function*(){const{height:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_HEIGHT",{});return e})}transformPoint(e){return qe(this,void 0,void 0,function*(){const{point:t}=yield this.messageBus.sendAsync("OBR_VIEWPORT_TRANSFORM_POINT",{point:e});return t})}inverseTransformPoint(e){return qe(this,void 0,void 0,function*(){const{point:t}=yield this.messageBus.sendAsync("OBR_VIEWPORT_INVERSE_TRANSFORM_POINT",{point:e});return t})}}function kr(n){return typeof n.id=="string"}var Qn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ls(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function Dr(n){if(n.__esModule)return n;var e=n.default;if(typeof e=="function"){var t=function i(){return this instanceof i?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(n).forEach(function(i){var r=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(t,i,r.get?r:{enumerable:!0,get:function(){return n[i]}})}),t}var bi={exports:{}},St=typeof Reflect=="object"?Reflect:null,is=St&&typeof St.apply=="function"?St.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)},cn;St&&typeof St.ownKeys=="function"?cn=St.ownKeys:Object.getOwnPropertySymbols?cn=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:cn=function(e){return Object.getOwnPropertyNames(e)};function Lr(n){console&&console.warn&&console.warn(n)}var Ps=Number.isNaN||function(e){return e!==e};function pe(){pe.init.call(this)}bi.exports=pe;bi.exports.once=Fr;pe.EventEmitter=pe;pe.prototype._events=void 0;pe.prototype._eventsCount=0;pe.prototype._maxListeners=void 0;var ss=10;function Bn(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(pe,"defaultMaxListeners",{enumerable:!0,get:function(){return ss},set:function(n){if(typeof n!="number"||n<0||Ps(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");ss=n}});pe.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};pe.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Ps(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Ms(n){return n._maxListeners===void 0?pe.defaultMaxListeners:n._maxListeners}pe.prototype.getMaxListeners=function(){return Ms(this)};pe.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r=e==="error",s=this._events;if(s!==void 0)r=r&&s.error===void 0;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var f=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw f.context=o,f}var y=s[e];if(y===void 0)return!1;if(typeof y=="function")is(y,this,t);else for(var g=y.length,d=js(y,g),i=0;i<g;++i)is(d[i],this,t);return!0};function $s(n,e,t,i){var r,s,o;if(Bn(t),s=n._events,s===void 0?(s=n._events=Object.create(null),n._eventsCount=0):(s.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),s=n._events),o=s[e]),o===void 0)o=s[e]=t,++n._eventsCount;else if(typeof o=="function"?o=s[e]=i?[t,o]:[o,t]:i?o.unshift(t):o.push(t),r=Ms(n),r>0&&o.length>r&&!o.warned){o.warned=!0;var f=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");f.name="MaxListenersExceededWarning",f.emitter=n,f.type=e,f.count=o.length,Lr(f)}return n}pe.prototype.addListener=function(e,t){return $s(this,e,t,!1)};pe.prototype.on=pe.prototype.addListener;pe.prototype.prependListener=function(e,t){return $s(this,e,t,!0)};function Pr(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Fs(n,e,t){var i={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},r=Pr.bind(i);return r.listener=t,i.wrapFn=r,r}pe.prototype.once=function(e,t){return Bn(t),this.on(e,Fs(this,e,t)),this};pe.prototype.prependOnceListener=function(e,t){return Bn(t),this.prependListener(e,Fs(this,e,t)),this};pe.prototype.removeListener=function(e,t){var i,r,s,o,f;if(Bn(t),r=this._events,r===void 0)return this;if(i=r[e],i===void 0)return this;if(i===t||i.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if(typeof i!="function"){for(s=-1,o=i.length-1;o>=0;o--)if(i[o]===t||i[o].listener===t){f=i[o].listener,s=o;break}if(s<0)return this;s===0?i.shift():Mr(i,s),i.length===1&&(r[e]=i[0]),r.removeListener!==void 0&&this.emit("removeListener",e,f||t)}return this};pe.prototype.off=pe.prototype.removeListener;pe.prototype.removeAllListeners=function(e){var t,i,r;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[e]),this;if(arguments.length===0){var s=Object.keys(i),o;for(r=0;r<s.length;++r)o=s[r],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=i[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this};function Vs(n,e,t){var i=n._events;if(i===void 0)return[];var r=i[e];return r===void 0?[]:typeof r=="function"?t?[r.listener||r]:[r]:t?$r(r):js(r,r.length)}pe.prototype.listeners=function(e){return Vs(this,e,!0)};pe.prototype.rawListeners=function(e){return Vs(this,e,!1)};pe.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):Us.call(n,e)};pe.prototype.listenerCount=Us;function Us(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}pe.prototype.eventNames=function(){return this._eventsCount>0?cn(this._events):[]};function js(n,e){for(var t=new Array(e),i=0;i<e;++i)t[i]=n[i];return t}function Mr(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function $r(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function Fr(n,e){return new Promise(function(t,i){function r(o){n.removeListener(e,s),i(o)}function s(){typeof n.removeListener=="function"&&n.removeListener("error",r),t([].slice.call(arguments))}Gs(n,e,s,{once:!0}),e!=="error"&&Vr(n,r,{once:!0})})}function Vr(n,e,t){typeof n.on=="function"&&Gs(n,"error",e,t)}function Gs(n,e,t,i){if(typeof n.on=="function")i.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function r(s){i.once&&n.removeEventListener(e,r),t(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}var Ur=bi.exports;let en;const jr=new Uint8Array(16);function Gr(){if(!en&&(en=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!en))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return en(jr)}const be=[];for(let n=0;n<256;++n)be.push((n+256).toString(16).slice(1));function Hr(n,e=0){return(be[n[e+0]]+be[n[e+1]]+be[n[e+2]]+be[n[e+3]]+"-"+be[n[e+4]]+be[n[e+5]]+"-"+be[n[e+6]]+be[n[e+7]]+"-"+be[n[e+8]]+be[n[e+9]]+"-"+be[n[e+10]]+be[n[e+11]]+be[n[e+12]]+be[n[e+13]]+be[n[e+14]]+be[n[e+15]]).toLowerCase()}const Wr=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),rs={randomUUID:Wr};function Hs(n,e,t){if(rs.randomUUID&&!e&&!n)return rs.randomUUID();n=n||{};const i=n.random||(n.rng||Gr)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,e){t=t||0;for(let r=0;r<16;++r)e[t+r]=i[r];return e}return Hr(i)}class Yr extends Ur.EventEmitter{constructor(e,t){super(),this.ready=!1,this.userId=null,this.ref=null,this.handleMessage=i=>{const r=i.data;if(i.origin===this.targetOrigin&&kr(r)){if(r.id==="OBR_READY"){this.ready=!0;const s=r.data;this.ref=s.ref,this.userId=s.userId}this.emit(r.id,r.data)}},this.send=(i,r,s)=>{var o;if(!this.ref)throw Error("Unable to send message: not ready");(o=window.parent)===null||o===void 0||o.postMessage({id:i,data:r,ref:this.ref,nonce:s},this.targetOrigin)},this.sendAsync=(i,r,s=5e3)=>{const o=`_${Hs()}`;return this.send(i,r,o),Promise.race([new Promise((f,y)=>{const g=this;function d(N){g.off(`${i}_RESPONSE${o}`,d),g.off(`${i}_ERROR${o}`,E),f(N)}function E(N){g.off(`${i}_RESPONSE${o}`,d),g.off(`${i}_ERROR${o}`,E),y(N)}this.on(`${i}_RESPONSE${o}`,d),this.on(`${i}_ERROR${o}`,E)}),new Promise((f,y)=>window.setTimeout(()=>y(new Error(`Message ${i} took longer than ${s}ms to get a result`)),s))])},this.roomId=t,this.targetOrigin=e,window.addEventListener("message",this.handleMessage),this.setMaxListeners(100)}destroy(){window.removeEventListener("message",this.handleMessage)}}var os=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class Xr{constructor(e){this.messageBus=e}show(e,t){return os(this,void 0,void 0,function*(){const{id:i}=yield this.messageBus.sendAsync("OBR_NOTIFICATION_SHOW",{message:e,variant:t});return i})}close(e){return os(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_NOTIFICATION_CLOSE",{id:e})})}}var Ot=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class Kr{constructor(e){this.messageBus=e}getColor(){return Ot(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_COLOR",{});return e})}setColor(e){return Ot(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_COLOR",{color:e})})}getStrokeWidth(){return Ot(this,void 0,void 0,function*(){const{strokeWidth:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_STROKE_WIDTH",{});return e})}setStrokeWidth(e){return Ot(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_STROKE_WIDTH",{strokeWidth:e})})}getFilled(){return Ot(this,void 0,void 0,function*(){const{filled:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_FILLED",{});return e})}setFilled(e){return Ot(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_FILLED",{filled:e})})}onChange(e){const t=i=>{e(i.fog)};return this.messageBus.send("OBR_SCENE_FOG_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_FOG_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_FOG_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_FOG_EVENT_CHANGE",t)}}}var Le=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class zr{constructor(e){this.messageBus=e}getDpi(){return Le(this,void 0,void 0,function*(){const{dpi:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_DPI",{});return e})}getScale(){return Le(this,void 0,void 0,function*(){return yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_SCALE",{})})}setScale(e){return Le(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_SCALE",{scale:e})})}getColor(){return Le(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_COLOR",{});return e})}setColor(e){return Le(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_COLOR",{color:e})})}getOpacity(){return Le(this,void 0,void 0,function*(){const{opacity:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_OPACITY",{});return e})}setOpacity(e){return Le(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_OPACITY",{opacity:e})})}getType(){return Le(this,void 0,void 0,function*(){const{type:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_TYPE",{});return e})}setType(e){return Le(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_TYPE",{type:e})})}getLineType(){return Le(this,void 0,void 0,function*(){const{lineType:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_LINE_TYPE",{});return e})}setLineType(e){return Le(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_LINE_TYPE",{lineType:e})})}getMeasurement(){return Le(this,void 0,void 0,function*(){const{measurement:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_MEASUREMENT",{});return e})}setMeasurement(e){return Le(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_MEASUREMENT",{measurement:e})})}snapPosition(e,t,i){return Le(this,void 0,void 0,function*(){const{position:r}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_SNAP_POSITION",{position:e,snappingSensitivity:t,useCorners:i});return r})}getDistance(e,t){return Le(this,void 0,void 0,function*(){const{distance:i}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_DISTANCE",{from:e,to:t});return i})}onChange(e){const t=i=>{e(i.grid)};return this.messageBus.send("OBR_SCENE_GRID_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_GRID_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_GRID_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_GRID_EVENT_CHANGE",t)}}}var tn=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class qr{constructor(e){this.messageBus=e}undo(){return tn(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_UNDO",{})})}redo(){return tn(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_REDO",{})})}canUndo(){return tn(this,void 0,void 0,function*(){const{canUndo:e}=yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_CAN_UNDO",{});return e})}canRedo(){return tn(this,void 0,void 0,function*(){const{canRedo:e}=yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_CAN_REDO",{});return e})}}function Re(n){for(var e=arguments.length,t=Array(e>1?e-1:0),i=1;i<e;i++)t[i-1]=arguments[i];throw Error("[Immer] minified error nr: "+n+(t.length?" "+t.map(function(r){return"'"+r+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function vt(n){return!!n&&!!n[Ge]}function ut(n){var e;return!!n&&(function(t){if(!t||typeof t!="object")return!1;var i=Object.getPrototypeOf(t);if(i===null)return!0;var r=Object.hasOwnProperty.call(i,"constructor")&&i.constructor;return r===Object||typeof r=="function"&&Function.toString.call(r)===so}(n)||Array.isArray(n)||!!n[Mt]||!!(!((e=n.constructor)===null||e===void 0)&&e[Mt])||Nn(n)||xn(n))}function Ct(n,e,t){t===void 0&&(t=!1),ct(n)===0?(t?Object.keys:ki)(n).forEach(function(i){t&&typeof i=="symbol"||e(i,n[i],n)}):n.forEach(function(i,r){return e(r,i,n)})}function ct(n){var e=n[Ge];return e?e.i>3?e.i-4:e.i:Array.isArray(n)?1:Nn(n)?2:xn(n)?3:0}function Ut(n,e){return ct(n)===2?n.has(e):Object.prototype.hasOwnProperty.call(n,e)}function dn(n,e){return ct(n)===2?n.get(e):n[e]}function Ws(n,e,t){var i=ct(n);i===2?n.set(e,t):i===3?n.add(t):n[e]=t}function Zr(n,e){return n===e?n!==0||1/n==1/e:n!=n&&e!=e}function Nn(n){return no&&n instanceof Map}function xn(n){return io&&n instanceof Set}function gt(n){return n.o||n.t}function Si(n){if(Array.isArray(n))return Array.prototype.slice.call(n);var e=ro(n);delete e[Ge];for(var t=ki(e),i=0;i<t.length;i++){var r=t[i],s=e[r];s.writable===!1&&(s.writable=!0,s.configurable=!0),(s.get||s.set)&&(e[r]={configurable:!0,writable:!0,enumerable:s.enumerable,value:n[r]})}return Object.create(Object.getPrototypeOf(n),e)}function Ci(n,e){return e===void 0&&(e=!1),Ri(n)||vt(n)||!ut(n)||(ct(n)>1&&(n.set=n.add=n.clear=n.delete=Qr),Object.freeze(n),e&&Ct(n,function(t,i){return Ci(i,!0)},!0)),n}function Qr(){Re(2)}function Ri(n){return n==null||typeof n!="object"||Object.isFrozen(n)}function tt(n){var e=_i[n];return e||Re(18,n),e}function Jr(n,e){_i[n]||(_i[n]=e)}function as(){return jt}function Jn(n,e){e&&(tt("Patches"),n.u=[],n.s=[],n.v=e)}function mn(n){mi(n),n.p.forEach(eo),n.p=null}function mi(n){n===jt&&(jt=n.l)}function ls(n){return jt={p:[],l:jt,h:n,m:!0,_:0}}function eo(n){var e=n[Ge];e.i===0||e.i===1?e.j():e.g=!0}function ei(n,e){e._=e.p.length;var t=e.p[0],i=n!==void 0&&n!==t;return e.h.O||tt("ES5").S(e,n,i),i?(t[Ge].P&&(mn(e),Re(4)),ut(n)&&(n=yn(e,n),e.l||vn(e,n)),e.u&&tt("Patches").M(t[Ge].t,n,e.u,e.s)):n=yn(e,t,[]),mn(e),e.u&&e.v(e.u,e.s),n!==xi?n:void 0}function yn(n,e,t){if(Ri(e))return e;var i=e[Ge];if(!i)return Ct(e,function(f,y){return us(n,i,e,f,y,t)},!0),e;if(i.A!==n)return e;if(!i.P)return vn(n,i.t,!0),i.t;if(!i.I){i.I=!0,i.A._--;var r=i.i===4||i.i===5?i.o=Si(i.k):i.o,s=r,o=!1;i.i===3&&(s=new Set(r),r.clear(),o=!0),Ct(s,function(f,y){return us(n,i,r,f,y,t,o)}),vn(n,r,!1),t&&n.u&&tt("Patches").N(i,t,n.u,n.s)}return i.o}function us(n,e,t,i,r,s,o){if(vt(r)){var f=yn(n,r,s&&e&&e.i!==3&&!Ut(e.R,i)?s.concat(i):void 0);if(Ws(t,i,f),!vt(f))return;n.m=!1}else o&&t.add(r);if(ut(r)&&!Ri(r)){if(!n.h.D&&n._<1)return;yn(n,r),e&&e.A.l||vn(n,r)}}function vn(n,e,t){t===void 0&&(t=!1),!n.l&&n.h.D&&n.m&&Ci(e,t)}function ti(n,e){var t=n[Ge];return(t?gt(t):n)[e]}function cs(n,e){if(e in n)for(var t=Object.getPrototypeOf(n);t;){var i=Object.getOwnPropertyDescriptor(t,e);if(i)return i;t=Object.getPrototypeOf(t)}}function yi(n){n.P||(n.P=!0,n.l&&yi(n.l))}function ni(n){n.o||(n.o=Si(n.t))}function vi(n,e,t){var i=Nn(e)?tt("MapSet").F(e,t):xn(e)?tt("MapSet").T(e,t):n.O?function(r,s){var o=Array.isArray(r),f={i:o?1:0,A:s?s.A:as(),P:!1,I:!1,R:{},l:s,t:r,k:null,o:null,j:null,C:!1},y=f,g=Ei;o&&(y=[f],g=Pt);var d=Proxy.revocable(y,g),E=d.revoke,N=d.proxy;return f.k=N,f.j=E,N}(e,t):tt("ES5").J(e,t);return(t?t.A:as()).p.push(i),i}function to(n){return vt(n)||Re(22,n),function e(t){if(!ut(t))return t;var i,r=t[Ge],s=ct(t);if(r){if(!r.P&&(r.i<4||!tt("ES5").K(r)))return r.t;r.I=!0,i=ds(t,s),r.I=!1}else i=ds(t,s);return Ct(i,function(o,f){r&&dn(r.t,o)===f||Ws(i,o,e(f))}),s===3?new Set(i):i}(n)}function ds(n,e){switch(e){case 2:return new Map(n);case 3:return Array.from(n)}return Si(n)}function Bi(){function n(i){if(!ut(i))return i;if(Array.isArray(i))return i.map(n);if(Nn(i))return new Map(Array.from(i.entries()).map(function(o){return[o[0],n(o[1])]}));if(xn(i))return new Set(Array.from(i).map(n));var r=Object.create(Object.getPrototypeOf(i));for(var s in i)r[s]=n(i[s]);return Ut(i,Mt)&&(r[Mt]=i[Mt]),r}function e(i){return vt(i)?n(i):i}var t="add";Jr("Patches",{$:function(i,r){return r.forEach(function(s){for(var o=s.path,f=s.op,y=i,g=0;g<o.length-1;g++){var d=ct(y),E=o[g];typeof E!="string"&&typeof E!="number"&&(E=""+E),d!==0&&d!==1||E!=="__proto__"&&E!=="constructor"||Re(24),typeof y=="function"&&E==="prototype"&&Re(24),typeof(y=dn(y,E))!="object"&&Re(15,o.join("/"))}var N=ct(y),W=n(s.value),T=o[o.length-1];switch(f){case"replace":switch(N){case 2:return y.set(T,W);case 3:Re(16);default:return y[T]=W}case t:switch(N){case 1:return T==="-"?y.push(W):y.splice(T,0,W);case 2:return y.set(T,W);case 3:return y.add(W);default:return y[T]=W}case"remove":switch(N){case 1:return y.splice(T,1);case 2:return y.delete(T);case 3:return y.delete(s.value);default:return delete y[T]}default:Re(17,f)}}),i},N:function(i,r,s,o){switch(i.i){case 0:case 4:case 2:return function(f,y,g,d){var E=f.t,N=f.o;Ct(f.R,function(W,T){var M=dn(E,W),A=dn(N,W),x=T?Ut(E,W)?"replace":t:"remove";if(M!==A||x!=="replace"){var R=y.concat(W);g.push(x==="remove"?{op:x,path:R}:{op:x,path:R,value:A}),d.push(x===t?{op:"remove",path:R}:x==="remove"?{op:t,path:R,value:e(M)}:{op:"replace",path:R,value:e(M)})}})}(i,r,s,o);case 5:case 1:return function(f,y,g,d){var E=f.t,N=f.R,W=f.o;if(W.length<E.length){var T=[W,E];E=T[0],W=T[1];var M=[d,g];g=M[0],d=M[1]}for(var A=0;A<E.length;A++)if(N[A]&&W[A]!==E[A]){var x=y.concat([A]);g.push({op:"replace",path:x,value:e(W[A])}),d.push({op:"replace",path:x,value:e(E[A])})}for(var R=E.length;R<W.length;R++){var D=y.concat([R]);g.push({op:t,path:D,value:e(W[R])})}E.length<W.length&&d.push({op:"replace",path:y.concat(["length"]),value:E.length})}(i,r,s,o);case 3:return function(f,y,g,d){var E=f.t,N=f.o,W=0;E.forEach(function(T){if(!N.has(T)){var M=y.concat([W]);g.push({op:"remove",path:M,value:T}),d.unshift({op:t,path:M,value:T})}W++}),W=0,N.forEach(function(T){if(!E.has(T)){var M=y.concat([W]);g.push({op:t,path:M,value:T}),d.unshift({op:"remove",path:M,value:T})}W++})}(i,r,s,o)}},M:function(i,r,s,o){s.push({op:"replace",path:[],value:r===xi?void 0:r}),o.push({op:"replace",path:[],value:i})}})}var fs,jt,Ni=typeof Symbol<"u"&&typeof Symbol("x")=="symbol",no=typeof Map<"u",io=typeof Set<"u",hs=typeof Proxy<"u"&&Proxy.revocable!==void 0&&typeof Reflect<"u",xi=Ni?Symbol.for("immer-nothing"):((fs={})["immer-nothing"]=!0,fs),Mt=Ni?Symbol.for("immer-draftable"):"__$immer_draftable",Ge=Ni?Symbol.for("immer-state"):"__$immer_state",so=""+Object.prototype.constructor,ki=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(n){return Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n))}:Object.getOwnPropertyNames,ro=Object.getOwnPropertyDescriptors||function(n){var e={};return ki(n).forEach(function(t){e[t]=Object.getOwnPropertyDescriptor(n,t)}),e},_i={},Ei={get:function(n,e){if(e===Ge)return n;var t=gt(n);if(!Ut(t,e))return function(r,s,o){var f,y=cs(s,o);return y?"value"in y?y.value:(f=y.get)===null||f===void 0?void 0:f.call(r.k):void 0}(n,t,e);var i=t[e];return n.I||!ut(i)?i:i===ti(n.t,e)?(ni(n),n.o[e]=vi(n.A.h,i,n)):i},has:function(n,e){return e in gt(n)},ownKeys:function(n){return Reflect.ownKeys(gt(n))},set:function(n,e,t){var i=cs(gt(n),e);if(i?.set)return i.set.call(n.k,t),!0;if(!n.P){var r=ti(gt(n),e),s=r?.[Ge];if(s&&s.t===t)return n.o[e]=t,n.R[e]=!1,!0;if(Zr(t,r)&&(t!==void 0||Ut(n.t,e)))return!0;ni(n),yi(n)}return n.o[e]===t&&(t!==void 0||e in n.o)||Number.isNaN(t)&&Number.isNaN(n.o[e])||(n.o[e]=t,n.R[e]=!0),!0},deleteProperty:function(n,e){return ti(n.t,e)!==void 0||e in n.t?(n.R[e]=!1,ni(n),yi(n)):delete n.R[e],n.o&&delete n.o[e],!0},getOwnPropertyDescriptor:function(n,e){var t=gt(n),i=Reflect.getOwnPropertyDescriptor(t,e);return i&&{writable:!0,configurable:n.i!==1||e!=="length",enumerable:i.enumerable,value:t[e]}},defineProperty:function(){Re(11)},getPrototypeOf:function(n){return Object.getPrototypeOf(n.t)},setPrototypeOf:function(){Re(12)}},Pt={};Ct(Ei,function(n,e){Pt[n]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}}),Pt.deleteProperty=function(n,e){return Pt.set.call(this,n,e,void 0)},Pt.set=function(n,e,t){return Ei.set.call(this,n[0],e,t,n[0])};var oo=function(){function n(t){var i=this;this.O=hs,this.D=!0,this.produce=function(r,s,o){if(typeof r=="function"&&typeof s!="function"){var f=s;s=r;var y=i;return function(M){var A=this;M===void 0&&(M=f);for(var x=arguments.length,R=Array(x>1?x-1:0),D=1;D<x;D++)R[D-1]=arguments[D];return y.produce(M,function(P){var Q;return(Q=s).call.apply(Q,[A,P].concat(R))})}}var g;if(typeof s!="function"&&Re(6),o!==void 0&&typeof o!="function"&&Re(7),ut(r)){var d=ls(i),E=vi(i,r,void 0),N=!0;try{g=s(E),N=!1}finally{N?mn(d):mi(d)}return typeof Promise<"u"&&g instanceof Promise?g.then(function(M){return Jn(d,o),ei(M,d)},function(M){throw mn(d),M}):(Jn(d,o),ei(g,d))}if(!r||typeof r!="object"){if((g=s(r))===void 0&&(g=r),g===xi&&(g=void 0),i.D&&Ci(g,!0),o){var W=[],T=[];tt("Patches").M(r,g,W,T),o(W,T)}return g}Re(21,r)},this.produceWithPatches=function(r,s){if(typeof r=="function")return function(g){for(var d=arguments.length,E=Array(d>1?d-1:0),N=1;N<d;N++)E[N-1]=arguments[N];return i.produceWithPatches(g,function(W){return r.apply(void 0,[W].concat(E))})};var o,f,y=i.produce(r,s,function(g,d){o=g,f=d});return typeof Promise<"u"&&y instanceof Promise?y.then(function(g){return[g,o,f]}):[y,o,f]},typeof t?.useProxies=="boolean"&&this.setUseProxies(t.useProxies),typeof t?.autoFreeze=="boolean"&&this.setAutoFreeze(t.autoFreeze)}var e=n.prototype;return e.createDraft=function(t){ut(t)||Re(8),vt(t)&&(t=to(t));var i=ls(this),r=vi(this,t,void 0);return r[Ge].C=!0,mi(i),r},e.finishDraft=function(t,i){var r=t&&t[Ge],s=r.A;return Jn(s,i),ei(void 0,s)},e.setAutoFreeze=function(t){this.D=t},e.setUseProxies=function(t){t&&!hs&&Re(20),this.O=t},e.applyPatches=function(t,i){var r;for(r=i.length-1;r>=0;r--){var s=i[r];if(s.path.length===0&&s.op==="replace"){t=s.value;break}}r>-1&&(i=i.slice(r+1));var o=tt("Patches").$;return vt(t)?o(t,i):this.produce(t,function(f){return o(f,i)})},n}(),He=new oo;He.produce;var Di=He.produceWithPatches.bind(He);He.setAutoFreeze.bind(He);He.setUseProxies.bind(He);He.applyPatches.bind(He);He.createDraft.bind(He);He.finishDraft.bind(He);var wt=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};Bi();class ao{constructor(e){this.messageBus=e}getItems(e){return wt(this,void 0,void 0,function*(){if(Array.isArray(e)){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEMS",{ids:e});return t}else if(e){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ALL_ITEMS",{});return t.filter(e)}else{const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ALL_ITEMS",{});return t}})}isItemArray(e){return Array.isArray(e)&&e.every(t=>typeof t!="string")}updateItems(e,t){return wt(this,void 0,void 0,function*(){let i;this.isItemArray(e)?i=e:i=yield this.getItems(e);const[r,s]=Di(i,t),o=r.map(f=>({id:f.id,type:f.type}));for(const f of s){const[y,g]=f.path;typeof y=="number"&&typeof g=="string"&&(o[y][g]=r[y][g])}yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_UPDATE_ITEMS",{updates:o})})}addItems(e){return wt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_ADD_ITEMS",{items:e})})}deleteItems(e){return wt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_DELETE_ITEMS",{ids:e})})}getItemAttachments(e){return wt(this,void 0,void 0,function*(){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEM_ATTACHMENTS",{ids:e});return t})}getItemBounds(e){return wt(this,void 0,void 0,function*(){const{bounds:t}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEM_BOUNDS",{ids:e});return t})}onChange(e){const t=i=>{e(i.items)};return this.messageBus.send("OBR_SCENE_ITEMS_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_ITEMS_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_ITEMS_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_ITEMS_EVENT_CHANGE",t)}}}var It=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};Bi();class lo{constructor(e){this.messageBus=e}getItems(e){return It(this,void 0,void 0,function*(){if(Array.isArray(e)){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEMS",{ids:e});return t}else if(e){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ALL_ITEMS",{});return t.filter(e)}else{const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ALL_ITEMS",{});return t}})}updateItems(e,t,i){return It(this,void 0,void 0,function*(){const r=yield this.getItems(e),[s,o]=Di(r,t),f=s.map(y=>({id:y.id,type:y.type}));for(const y of o){const[g,d]=y.path;typeof g=="number"&&typeof d=="string"&&(f[g][d]=s[g][d])}yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_UPDATE_ITEMS",{updates:f,fastUpdate:i})})}addItems(e){return It(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_ADD_ITEMS",{items:e})})}deleteItems(e){return It(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_DELETE_ITEMS",{ids:e})})}getItemAttachments(e){return It(this,void 0,void 0,function*(){const{items:t}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEM_ATTACHMENTS",{ids:e});return t})}getItemBounds(e){return It(this,void 0,void 0,function*(){const{bounds:t}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEM_BOUNDS",{ids:e});return t})}onChange(e){const t=i=>{e(i.items)};return this.messageBus.send("OBR_SCENE_LOCAL_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_LOCAL_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_LOCAL_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_LOCAL_EVENT_CHANGE",t)}}}var ii=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class uo{constructor(e){this.messageBus=e,this.grid=new zr(e),this.fog=new Kr(e),this.history=new qr(e),this.items=new ao(e),this.local=new lo(e)}isReady(){return ii(this,void 0,void 0,function*(){const{ready:e}=yield this.messageBus.sendAsync("OBR_SCENE_IS_READY",{});return e})}onReadyChange(e){const t=i=>{e(i.ready)};return this.messageBus.send("OBR_SCENE_READY_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_EVENT_READY_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_READY_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_EVENT_READY_CHANGE",t)}}getMetadata(){return ii(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_SCENE_GET_METADATA",{});return e})}setMetadata(e){return ii(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_SET_METADATA",{update:e})})}onMetadataChange(e){const t=i=>{e(i.metadata)};return this.messageBus.send("OBR_SCENE_METADATA_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_METADATA_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_SCENE_METADATA_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_METADATA_EVENT_CHANGE",t)}}}function $t(n){return n.map(e=>Object.assign(Object.assign({},e),{icon:e.icon.startsWith("http")?e.icon:`${window.location.origin}${e.icon}`}))}function Ys(n){return Object.assign(Object.assign({},n),{url:n.url.startsWith("http")?n.url:`${window.location.origin}${n.url}`})}var ps=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class co{constructor(e){this.contextMenus={},this.handleClick=t=>{const i=this.contextMenus[t.id];i&&i.onClick(t.context,t.elementId)},this.messageBus=e,e.on("OBR_CONTEXT_MENU_EVENT_CLICK",this.handleClick)}create(e){return ps(this,void 0,void 0,function*(){this.messageBus.sendAsync("OBR_CONTEXT_MENU_CREATE",{id:e.id,shortcut:e.shortcut,icons:$t(e.icons)}),this.contextMenus[e.id]=e})}remove(e){return ps(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_CONTEXT_MENU_REMOVE",{id:e}),delete this.contextMenus[e]})}}var et=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class fo{constructor(e){this.tools={},this.toolActions={},this.toolModes={},this.handleToolClick=t=>{const i=this.tools[t.id];if(i)if(i.onClick){const r=i.onClick(t.context,t.elementId);Promise.resolve(r).then(s=>{s&&this.messageBus.send("OBR_TOOL_ACTIVATE",{id:t.id})})}else this.messageBus.send("OBR_TOOL_ACTIVATE",{id:t.id})},this.handleToolActionClick=t=>{var i;const r=this.toolActions[t.id];r&&((i=r.onClick)===null||i===void 0||i.call(r,t.context,t.elementId))},this.handleToolModeClick=t=>{const i=this.toolModes[t.id];if(i)if(i.onClick){const r=i.onClick(t.context,t.elementId);Promise.resolve(r).then(s=>{s&&this.messageBus.send("OBR_TOOL_MODE_ACTIVATE",{toolId:t.context.activeTool,modeId:t.id})})}else this.messageBus.send("OBR_TOOL_MODE_ACTIVATE",{toolId:t.context.activeTool,modeId:t.id})},this.handleToolModeToolClick=t=>{const i=this.toolModes[t.id];if(i)if(i.onToolClick){const r=i.onToolClick(t.context,t.event);Promise.resolve(r).then(s=>{s&&t.event.target&&!t.event.target.locked&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[t.event.target.id]})})}else t.event.target&&!t.event.target.locked&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[t.event.target.id]})},this.handleToolModeToolDoubleClick=t=>{const i=this.toolModes[t.id];if(i)if(i.onToolDoubleClick){const r=i.onToolDoubleClick(t.context,t.event);Promise.resolve(r).then(s=>{s&&t.event.target&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[t.event.target.id]})})}else t.event.target&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[t.event.target.id]})},this.handleToolModeToolDown=t=>{var i;const r=this.toolModes[t.id];r&&((i=r.onToolDown)===null||i===void 0||i.call(r,t.context,t.event))},this.handleToolModeToolMove=t=>{var i;const r=this.toolModes[t.id];r&&((i=r.onToolMove)===null||i===void 0||i.call(r,t.context,t.event))},this.handleToolModeToolUp=t=>{var i;const r=this.toolModes[t.id];r&&((i=r.onToolUp)===null||i===void 0||i.call(r,t.context,t.event))},this.handleToolModeToolDragStart=t=>{var i;const r=this.toolModes[t.id];r&&((i=r.onToolDragStart)===null||i===void 0||i.call(r,t.context,t.event))},this.handleToolModeToolDragMove=t=>{var i;const r=this.toolModes[t.id];r&&((i=r.onToolDragMove)===null||i===void 0||i.call(r,t.context,t.event))},this.handleToolModeToolDragEnd=t=>{var i;const r=this.toolModes[t.id];r&&((i=r.onToolDragEnd)===null||i===void 0||i.call(r,t.context,t.event))},this.handleToolModeToolDragCancel=t=>{var i;const r=this.toolModes[t.id];r&&((i=r.onToolDragCancel)===null||i===void 0||i.call(r,t.context,t.event))},this.handleToolModeKeyDown=t=>{var i;const r=this.toolModes[t.id];r&&((i=r.onKeyDown)===null||i===void 0||i.call(r,t.context,t.event))},this.handleToolModeKeyUp=t=>{var i;const r=this.toolModes[t.id];r&&((i=r.onKeyUp)===null||i===void 0||i.call(r,t.context,t.event))},this.handleToolModeActivate=t=>{var i;const r=this.toolModes[t.id];r&&((i=r.onActivate)===null||i===void 0||i.call(r,t.context))},this.handleToolModeDeactivate=t=>{var i;const r=this.toolModes[t.id];r&&((i=r.onDeactivate)===null||i===void 0||i.call(r,t.context))},this.messageBus=e,e.on("OBR_TOOL_EVENT_CLICK",this.handleToolClick),e.on("OBR_TOOL_ACTION_EVENT_CLICK",this.handleToolActionClick),e.on("OBR_TOOL_MODE_EVENT_CLICK",this.handleToolModeClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_CLICK",this.handleToolModeToolClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_DOUBLE_CLICK",this.handleToolModeToolDoubleClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_DOWN",this.handleToolModeToolDown),e.on("OBR_TOOL_MODE_EVENT_TOOL_MOVE",this.handleToolModeToolMove),e.on("OBR_TOOL_MODE_EVENT_TOOL_UP",this.handleToolModeToolUp),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_START",this.handleToolModeToolDragStart),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_MOVE",this.handleToolModeToolDragMove),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_END",this.handleToolModeToolDragEnd),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_CANCEL",this.handleToolModeToolDragCancel),e.on("OBR_TOOL_MODE_EVENT_KEY_DOWN",this.handleToolModeKeyDown),e.on("OBR_TOOL_MODE_EVENT_KEY_UP",this.handleToolModeKeyUp),e.on("OBR_TOOL_MODE_EVENT_ACTIVATE",this.handleToolModeActivate),e.on("OBR_TOOL_MODE_EVENT_DEACTIVATE",this.handleToolModeDeactivate)}create(e){return et(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_CREATE",{id:e.id,shortcut:e.shortcut,defaultMode:e.defaultMode,defaultMetadata:e.defaultMetadata,icons:$t(e.icons),disabled:e.disabled}),this.tools[e.id]=e})}remove(e){return et(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_REMOVE",{id:e}),delete this.tools[e]})}activateTool(e){return et(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTIVATE",{id:e})})}getMetadata(e){return et(this,void 0,void 0,function*(){const{metadata:t}=yield this.messageBus.sendAsync("OBR_TOOL_GET_METADATA",{id:e});return t})}setMetadata(e,t){return et(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_SET_METADATA",{toolId:e,update:t})})}createAction(e){return et(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTION_CREATE",{id:e.id,shortcut:e.shortcut,icons:$t(e.icons),disabled:e.disabled}),this.toolActions[e.id]=e})}removeAction(e){return et(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTION_REMOVE",{id:e}),delete this.tools[e]})}createMode(e){return et(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_CREATE",{id:e.id,shortcut:e.shortcut,icons:$t(e.icons),preventDrag:e.preventDrag,disabled:e.disabled,cursors:e.cursors}),this.toolModes[e.id]=e})}removeMode(e){return et(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_REMOVE",{id:e}),delete this.tools[e]})}activateMode(e,t){return et(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_ACTIVATE",{toolId:e,modeId:t})})}}var Tt=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class ho{constructor(e){this.messageBus=e}open(e){return Tt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_OPEN",Object.assign({},Ys(e)))})}close(e){return Tt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_CLOSE",{id:e})})}getWidth(e){return Tt(this,void 0,void 0,function*(){const{width:t}=yield this.messageBus.sendAsync("OBR_POPOVER_GET_WIDTH",{id:e});return t})}setWidth(e,t){return Tt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_SET_WIDTH",{id:e,width:t})})}getHeight(e){return Tt(this,void 0,void 0,function*(){const{height:t}=yield this.messageBus.sendAsync("OBR_POPOVER_GET_HEIGHT",{id:e});return t})}setHeight(e,t){return Tt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_SET_HEIGHT",{id:e,height:t})})}}var gs=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class po{constructor(e){this.messageBus=e}open(e){return gs(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_MODAL_OPEN",Object.assign({},Ys(e)))})}close(e){return gs(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_MODAL_CLOSE",{id:e})})}}var Pe=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class go{constructor(e){this.messageBus=e}getWidth(){return Pe(this,void 0,void 0,function*(){const{width:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_WIDTH",{});return e})}setWidth(e){return Pe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_WIDTH",{width:e})})}getHeight(){return Pe(this,void 0,void 0,function*(){const{height:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_HEIGHT",{});return e})}setHeight(e){return Pe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_HEIGHT",{height:e})})}getBadgeText(){return Pe(this,void 0,void 0,function*(){const{badgeText:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_BADGE_TEXT",{});return e})}setBadgeText(e){return Pe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_BADGE_TEXT",{badgeText:e})})}getBadgeBackgroundColor(){return Pe(this,void 0,void 0,function*(){const{badgeBackgroundColor:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_BADGE_BACKGROUND_COLOR",{});return e})}setBadgeBackgroundColor(e){return Pe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_BADGE_BACKGROUND_COLOR",{badgeBackgroundColor:e})})}getIcon(){return Pe(this,void 0,void 0,function*(){const{icon:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_ICON",{});return e})}setIcon(e){return Pe(this,void 0,void 0,function*(){const t=$t([{icon:e}]);yield this.messageBus.sendAsync("OBR_ACTION_SET_ICON",{icon:t[0].icon})})}getTitle(){return Pe(this,void 0,void 0,function*(){const{title:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_TITLE",{});return e})}setTitle(e){return Pe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_TITLE",{title:e})})}isOpen(){return Pe(this,void 0,void 0,function*(){const{isOpen:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_IS_OPEN",{});return e})}open(){return Pe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_OPEN",{})})}close(){return Pe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_CLOSE",{})})}onOpenChange(e){const t=i=>{e(i.isOpen)};return this.messageBus.send("OBR_ACTION_IS_OPEN_SUBSCRIBE",{}),this.messageBus.on("OBR_ACTION_IS_OPEN_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_IS_OPEN_ACTION_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ACTION_IS_OPEN_EVENT_CHANGE",t)}}}var mo=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};Bi();class yo{constructor(e){this.messageBus=e}startItemInteraction(e){return mo(this,void 0,void 0,function*(){const{id:t}=yield this.messageBus.sendAsync("OBR_INTERACTION_START_ITEM_INTERACTION",{baseState:e});let i=e;return[o=>{const[f,y]=Di(i,o);return i=f,this.messageBus.send("OBR_INTERACTION_UPDATE_ITEM_INTERACTION",{id:t,patches:y}),f},()=>{this.messageBus.send("OBR_INTERACTION_STOP_ITEM_INTERACTION",{id:t})}]})}}var vo=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class _o{constructor(e){this.messageBus=e}getPlayers(){return vo(this,void 0,void 0,function*(){const{players:e}=yield this.messageBus.sendAsync("OBR_PARTY_GET_PLAYERS",{});return e})}onChange(e){const t=i=>{e(i.players)};return this.messageBus.send("OBR_PARTY_SUBSCRIBE",{}),this.messageBus.on("OBR_PARTY_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_PARTY_UNSUBSCRIBE",{}),this.messageBus.off("OBR_PARTY_EVENT_CHANGE",t)}}}var si=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class Eo{constructor(e){this.messageBus=e}get id(){return this.messageBus.roomId}getPermissions(){return si(this,void 0,void 0,function*(){const{permissions:e}=yield this.messageBus.sendAsync("OBR_ROOM_GET_PERMISSIONS",{});return e})}getMetadata(){return si(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_ROOM_GET_METADATA",{});return e})}setMetadata(e){return si(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ROOM_SET_METADATA",{update:e})})}onMetadataChange(e){const t=i=>{e(i.metadata)};return this.messageBus.send("OBR_ROOM_METADATA_SUBSCRIBE",{}),this.messageBus.on("OBR_ROOM_METADATA_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_METADATA_ROOM_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ROOM_METADATA_EVENT_CHANGE",t)}}onPermissionsChange(e){const t=i=>{e(i.permissions)};return this.messageBus.send("OBR_ROOM_PERMISSIONS_SUBSCRIBE",{}),this.messageBus.on("OBR_ROOM_PERMISSIONS_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_PERMISSIONS_ROOM_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ROOM_PERMISSIONS_EVENT_CHANGE",t)}}}var Oo=globalThis&&globalThis.__awaiter||function(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function f(d){try{g(i.next(d))}catch(E){o(E)}}function y(d){try{g(i.throw(d))}catch(E){o(E)}}function g(d){d.done?s(d.value):r(d.value).then(f,y)}g((i=i.apply(n,e||[])).next())})};class wo{constructor(e){this.messageBus=e}getTheme(){return Oo(this,void 0,void 0,function*(){const{theme:e}=yield this.messageBus.sendAsync("OBR_THEME_GET_THEME",{});return e})}onChange(e){const t=i=>{e(i.theme)};return this.messageBus.send("OBR_THEME_SUBSCRIBE",{}),this.messageBus.on("OBR_THEME_EVENT_CHANGE",t),()=>{this.messageBus.send("OBR_THEME_UNSUBSCRIBE",{}),this.messageBus.off("OBR_THEME_EVENT_CHANGE",t)}}}class kn{constructor(e){this._item={createdUserId:e.id,id:Hs(),name:"Item",zIndex:Date.now(),lastModified:new Date().toISOString(),lastModifiedUserId:e.id,locked:!1,metadata:{},position:{x:0,y:0},rotation:0,scale:{x:1,y:1},type:"ITEM",visible:!0,layer:"POPOVER"}}createdUserId(e){return this._item.createdUserId=e,this.self()}id(e){return this._item.id=e,this.self()}name(e){return this._item.name=e,this.self()}lastModified(e){return this._item.lastModified=e,this.self()}zIndex(e){return this._item.zIndex=e,this.self()}lastModifiedUserId(e){return this._item.lastModifiedUserId=e,this.self()}locked(e){return this._item.locked=e,this.self()}metadata(e){return this._item.metadata=e,this.self()}position(e){return this._item.position=e,this.self()}rotation(e){return this._item.rotation=e,this.self()}scale(e){return this._item.scale=e,this.self()}visible(e){return this._item.visible=e,this.self()}attachedTo(e){return this._item.attachedTo=e,this.self()}layer(e){return this._item.layer=e,this.self()}disableHit(e){return this._item.disableHit=e,this.self()}disableAutoZIndex(e){return this._item.disableAutoZIndex=e,this.self()}disableAttachmentBehavior(e){return this._item.disableAttachmentBehavior=e,this.self()}self(){return this}}class Io extends kn{constructor(e){super(e),this._points=[],this._style={fillColor:"black",fillOpacity:1,strokeColor:"white",strokeOpacity:1,strokeWidth:5,strokeDash:[],tension:.5},this._item.name="Curve",this._item.layer="DRAWING"}points(e){return this._points=e,this.self()}style(e){return this._style=e,this.self()}fillColor(e){return this._style.fillColor=e,this.self()}fillOpacity(e){return this._style.fillOpacity=e,this.self()}strokeColor(e){return this._style.strokeColor=e,this.self()}strokeOpacity(e){return this._style.strokeOpacity=e,this.self()}strokeWidth(e){return this._style.strokeWidth=e,this.self()}strokeDash(e){return this._style.strokeDash=e,this.self()}tension(e){return this._style.tension=e,this.self()}closed(e){return this._style.closed=e,this.self()}build(){return Object.assign(Object.assign({},this._item),{type:"CURVE",points:this._points,style:this._style})}}class To extends kn{constructor(e){super(e),this._text={richText:[{type:"paragraph",children:[{text:""}]}],plainText:"",style:{padding:8,fontFamily:"Roboto",fontSize:16,fontWeight:400,textAlign:"CENTER",textAlignVertical:"MIDDLE",fillColor:"white",fillOpacity:1,strokeColor:"white",strokeOpacity:1,strokeWidth:0,lineHeight:1.5},type:"PLAIN",width:"AUTO",height:"AUTO"},this._style={backgroundColor:"#3D4051",backgroundOpacity:1,cornerRadius:8,pointerDirection:"DOWN",pointerWidth:4,pointerHeight:4},this._item.layer="TEXT",this._item.name="Label"}text(e){return this._text=e,this.self()}width(e){return this._text.width=e,this.self()}height(e){return this._text.height=e,this.self()}plainText(e){return this._text.plainText=e,this.self()}padding(e){return this._text.style.padding=e,this.self()}fontFamily(e){return this._text.style.fontFamily=e,this.self()}fontSize(e){return this._text.style.fontSize=e,this.self()}fontWeight(e){return this._text.style.fontWeight=e,this.self()}textAlign(e){return this._text.style.textAlign=e,this.self()}textAlignVertical(e){return this._text.style.textAlignVertical=e,this.self()}fillColor(e){return this._text.style.fillColor=e,this.self()}fillOpacity(e){return this._text.style.fillOpacity=e,this.self()}strokeColor(e){return this._text.style.strokeColor=e,this.self()}strokeOpacity(e){return this._text.style.strokeOpacity=e,this.self()}strokeWidth(e){return this._text.style.strokeWidth=e,this.self()}lineHeight(e){return this._text.style.lineHeight=e,this.self()}style(e){return this._style=e,this.self()}backgroundColor(e){return this._style.backgroundColor=e,this.self()}backgroundOpacity(e){return this._style.backgroundOpacity=e,this.self()}cornerRadius(e){return this._style.cornerRadius=e,this.self()}pointerWidth(e){return this._style.pointerWidth=e,this.self()}pointerHeight(e){return this._style.pointerHeight=e,this.self()}pointerDirection(e){return this._style.pointerDirection=e,this.self()}build(){return Object.assign(Object.assign({},this._item),{type:"LABEL",text:this._text,style:this._style})}}class Ao extends kn{constructor(e){super(e),this._width=0,this._height=0,this._shapeType="RECTANGLE",this._style={fillColor:"black",fillOpacity:1,strokeColor:"white",strokeOpacity:1,strokeWidth:5,strokeDash:[]},this._item.layer="DRAWING",this._item.name="Shape"}width(e){return this._width=e,this.self()}height(e){return this._height=e,this.self()}shapeType(e){return this._shapeType=e,this.self()}style(e){return this._style=e,this.self()}fillColor(e){return this._style.fillColor=e,this.self()}fillOpacity(e){return this._style.fillOpacity=e,this.self()}strokeColor(e){return this._style.strokeColor=e,this.self()}strokeOpacity(e){return this._style.strokeOpacity=e,this.self()}strokeWidth(e){return this._style.strokeWidth=e,this.self()}strokeDash(e){return this._style.strokeDash=e,this.self()}build(){return Object.assign(Object.assign({},this._item),{type:"SHAPE",width:this._width,height:this._height,shapeType:this._shapeType,style:this._style})}}class bo extends kn{constructor(e){super(e),this._commands=[],this._fillRule="nonzero",this._style={fillColor:"black",fillOpacity:1,strokeColor:"white",strokeOpacity:1,strokeWidth:5,strokeDash:[]},this._item.name="Path",this._item.layer="DRAWING"}commands(e){return this._commands=e,this.self()}fillRule(e){return this._fillRule=e,this.self()}style(e){return this._style=e,this.self()}fillColor(e){return this._style.fillColor=e,this.self()}fillOpacity(e){return this._style.fillOpacity=e,this.self()}strokeColor(e){return this._style.strokeColor=e,this.self()}strokeOpacity(e){return this._style.strokeOpacity=e,this.self()}strokeWidth(e){return this._style.strokeWidth=e,this.self()}strokeDash(e){return this._style.strokeDash=e,this.self()}build(){return Object.assign(Object.assign({},this._item),{type:"PATH",commands:this._commands,fillRule:this._fillRule,style:this._style})}}const So=typeof atob=="function",Li=typeof Buffer=="function",ms=typeof TextDecoder=="function"?new TextDecoder:void 0;typeof TextEncoder=="function"&&new TextEncoder;const Co="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Ro=Array.prototype.slice.call(Co),nn=(n=>{let e={};return n.forEach((t,i)=>e[t]=i),e})(Ro),Bo=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,yt=String.fromCharCode.bind(String),ys=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):n=>new Uint8Array(Array.prototype.slice.call(n,0)),Xs=n=>n.replace(/[^A-Za-z0-9\+\/]/g,""),No=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,xo=n=>{switch(n.length){case 4:var e=(7&n.charCodeAt(0))<<18|(63&n.charCodeAt(1))<<12|(63&n.charCodeAt(2))<<6|63&n.charCodeAt(3),t=e-65536;return yt((t>>>10)+55296)+yt((t&1023)+56320);case 3:return yt((15&n.charCodeAt(0))<<12|(63&n.charCodeAt(1))<<6|63&n.charCodeAt(2));default:return yt((31&n.charCodeAt(0))<<6|63&n.charCodeAt(1))}},ko=n=>n.replace(No,xo),Do=n=>{if(n=n.replace(/\s+/g,""),!Bo.test(n))throw new TypeError("malformed base64.");n+="==".slice(2-(n.length&3));let e,t="",i,r;for(let s=0;s<n.length;)e=nn[n.charAt(s++)]<<18|nn[n.charAt(s++)]<<12|(i=nn[n.charAt(s++)])<<6|(r=nn[n.charAt(s++)]),t+=i===64?yt(e>>16&255):r===64?yt(e>>16&255,e>>8&255):yt(e>>16&255,e>>8&255,e&255);return t},Ks=So?n=>atob(Xs(n)):Li?n=>Buffer.from(n,"base64").toString("binary"):Do,Lo=Li?n=>ys(Buffer.from(n,"base64")):n=>ys(Ks(n).split("").map(e=>e.charCodeAt(0))),Po=Li?n=>Buffer.from(n,"base64").toString("utf8"):ms?n=>ms.decode(Lo(n)):n=>ko(Ks(n)),Mo=n=>Xs(n.replace(/[-_]/g,e=>e=="-"?"+":"/")),$o=n=>Po(Mo(n));function Fo(){const e=new URLSearchParams(window.location.search).get("obrref");let t="",i="";if(e){const s=$o(e).split(" ");s.length===2&&(t=s[0],i=s[1])}return{origin:t,roomId:i}}var vs;(function(n){n[n.MOVE=0]="MOVE",n[n.LINE=1]="LINE",n[n.QUAD=2]="QUAD",n[n.CONIC=3]="CONIC",n[n.CUBIC=4]="CUBIC",n[n.CLOSE=5]="CLOSE"})(vs||(vs={}));const Oi=Fo(),Be=new Yr(Oi.origin,Oi.roomId),Vo=new xr(Be),Ht=new Nr(Be),Uo=new _o(Be),jo=new Xr(Be),Go=new uo(Be),Ho=new co(Be),Wo=new fo(Be),Yo=new ho(Be),Xo=new po(Be),Ko=new go(Be),zo=new yo(Be),qo=new Eo(Be),Zo=new wo(Be),q={onReady:n=>{Be.ready?n():Be.once("OBR_READY",()=>n())},get isReady(){return Be.ready},viewport:Vo,player:Ht,party:Uo,notification:jo,scene:Go,contextMenu:Ho,tool:Wo,popover:Yo,modal:Xo,action:Ko,interaction:zo,room:qo,theme:Zo,isAvailable:!!Oi.origin};function zs(){return new Io(Ht)}function _n(){return new To(Ht)}function Rt(){return new Ao(Ht)}function Qo(){return new bo(Ht)}class Jo{userId;role;items;ghosts;players;metadata;gridDpi;gridScale;gridSnap;fog;ready;constructor(){this.userId="",this.role="PLAYER",this.items=[],this.players=[],this.ghosts=[],this.metadata={},this.gridDpi=0,this.gridScale=0,this.gridSnap=10,this.fog={filled:!1,style:{color:"white",strokeWidth:0}},this.ready=!1}}const Z=new Jo;class L{static EXTENSIONID="com.battle-system.smoke";static LINETOOLID="com.battle-system.linetool";static POLYTOOLID="com.battle-system.polytool";static ARMINDOID="com.armindoflores.fogofwar";static VISIONDEFAULT="30";static LABELSID="com.battle-system.labels";static DICENOTATION=/(\d+)[dD](\d+)(.*)$/i;static DICEMODIFIER=/([+-])(\d+)/;static PARENTHESESMATCH=/\((\d*d\d+\s*([+-]\s*\d+)?)\)/g;static PLUSMATCH=/\s(\+\d+)\s/g;static GRIDID="d9953ba1-f417-431c-8a39-3c3376e3caf0"}function ea(n){return n.layer=="MAP"&&(n.metadata[`${L.EXTENSIONID}/isBackgroundImage`]||n.metadata[`${L.ARMINDOID}/isBackgroundImage`])}function wi(n){return n.metadata[`${L.EXTENSIONID}/isVisionFog`]||n.metadata[`${L.ARMINDOID}/isVisionFog`]}function ta(n){return n.metadata[`${L.EXTENSIONID}/isIndicatorRing`]||n.metadata[`${L.ARMINDOID}/isIndicatorRing`]}function na(n){return n.metadata[`${L.EXTENSIONID}/isVisionLine`]&&!n.metadata[`${L.EXTENSIONID}/disabled`]||n.metadata[`${L.ARMINDOID}/isVisionLine`]&&!n.metadata[`${L.ARMINDOID}/disabled`]}function qs(n){return n.layer=="CHARACTER"&&(n.metadata[`${L.EXTENSIONID}/hasVision`]||n.metadata[`${L.ARMINDOID}/hasVision`])}function ia(n){return n.layer=="CHARACTER"&&n.createdUserId==Z.userId&&(n.metadata[`${L.EXTENSIONID}/hasVision`]||n.metadata[`${L.ARMINDOID}/hasVision`])}function Zs(n){return n.layer=="DRAWING"&&(n.metadata[`${L.EXTENSIONID}/isBackgroundImage`]||n.metadata[`${L.ARMINDOID}/isBackgroundImage`])}var Qs={exports:{}};const sa={},ra=Object.freeze(Object.defineProperty({__proto__:null,default:sa},Symbol.toStringTag,{value:"Module"})),ri=Dr(ra);(function(n,e){var t=(()=>{var i=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(i=i||__filename),function(r){r=r||{};var s;s||(s=typeof r<"u"?r:{});var o=Object.assign,f,y;s.ready=new Promise(function(l,a){f=l,y=a}),function(l){var a={};l.loadCmdsTypedArray=function(k){for(var G=0,X=0;X<k.length;X++)G+=k[X].length;if(a[G])var z=a[G];else z=new Float32Array(G),a[G]=z;var ee=0;for(X=0;X<k.length;X++)for(var ce=0;ce<k[X].length;ce++){var ye=k[X][ce];typeof ye=="string"&&(ye=l.SkBits2FloatUnsigned(parseInt(ye))),z[ee]=ye,ee++}return k=l._malloc(z.length*z.BYTES_PER_ELEMENT),l.HEAPF32.set(z,k/z.BYTES_PER_ELEMENT),[k,G]},l.FromCmds=function(k){k=l.loadCmdsTypedArray(k);var G=l._FromCmds(k[0],k[1]);return l._free(k[0]),G};var u,m,I,C,j;l.cubicYFromX=function(k,G,X,z,ee){return u&&m===k&&I===G&&C===X&&j===z||(u&&u.delete(),u=new l._SkCubicMap([k,G],[X,z]),m=k,I=G,C=X,j=z),u.computeYFromX(ee)},l.cubicPtFromT=function(k,G,X,z,ee){return u&&m===k&&I===G&&C===X&&j===z||(u&&u.delete(),u=new l._SkCubicMap([k,G],[X,z]),m=k,I=G,C=X,j=z),u.computePtFromT(ee)}}(s),function(l){l.onRuntimeInitialized=function(){l.SkPath.prototype.addPath=function(){var a=arguments[0];if(arguments.length===1)this._addPath(a,1,0,0,0,1,0,0,0,1);else if(arguments.length===2){var u=arguments[1];this._addPath(a,u.a,u.c,u.e,u.b,u.d,u.f,0,0,1)}else if(arguments.length===7)u=arguments,this._addPath(a,u[1],u[3],u[5],u[2],u[4],u[6],0,0,1);else if(arguments.length===10)u=arguments,this._addPath(a,u[1],u[2],u[3],u[4],u[5],u[6],u[7],u[8],u[9]);else return console.Ma("addPath expected to take 1, 2, 7, or 10 args. Got "+arguments.length),null;return this},l.SkPath.prototype.arc=function(a,u,m,I,C,j){return this._arc(a,u,m,I,C,!!j),this},l.SkPath.prototype.arcTo=function(a,u,m,I,C){return this._arcTo(a,u,m,I,C),this},l.SkPath.prototype.bezierCurveTo=function(a,u,m,I,C,j){return this._cubicTo(a,u,m,I,C,j),this},l.SkPath.prototype.close=function(){return this._close(),this},l.SkPath.prototype.closePath=function(){return this._close(),this},l.SkPath.prototype.conicTo=function(a,u,m,I,C){return this._conicTo(a,u,m,I,C),this},l.SkPath.prototype.cubicTo=function(a,u,m,I,C,j){return this._cubicTo(a,u,m,I,C,j),this},l.SkPath.prototype.dash=function(a,u,m){return this._dash(a,u,m)?this:null},l.SkPath.prototype.ellipse=function(a,u,m,I,C,j,k,G){return this._ellipse(a,u,m,I,C,j,k,!!G),this},l.SkPath.prototype.lineTo=function(a,u){return this._lineTo(a,u),this},l.SkPath.prototype.moveTo=function(a,u){return this._moveTo(a,u),this},l.SkPath.prototype.op=function(a,u){return this._op(a,u)?this:null},l.SkPath.prototype.quadraticCurveTo=function(a,u,m,I){return this._quadTo(a,u,m,I),this},l.SkPath.prototype.quadTo=function(a,u,m,I){return this._quadTo(a,u,m,I),this},l.SkPath.prototype.rect=function(a,u,m,I){return this._rect(a,u,m,I),this},l.SkPath.prototype.simplify=function(){return this._simplify()?this:null},l.SkPath.prototype.stroke=function(a){return a=a||{},a.width=a.width||1,a.miter_limit=a.miter_limit||4,a.cap=a.cap||l.StrokeCap.BUTT,a.join=a.join||l.StrokeJoin.MITER,this._stroke(a)?this:null},l.SkPath.prototype.transform=function(){if(arguments.length===1)this._transform(arguments[0]);else if(arguments.length===9){var a=arguments;this._transform(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])}else return console.Ma("transform expected to take 1 or 9 arguments. Got "+arguments.length),null;return this},l.SkPath.prototype.trim=function(a,u,m){return this._trim(a,u,!!m)?this:null}}}(s);var g=o({},s),d=typeof window=="object",E=typeof importScripts=="function",N="",W,T,M,A,x,R;typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"?(N=E?ri.dirname(N)+"/":__dirname+"/",R=()=>{x||(A=ri,x=ri)},W=function(l,a){return R(),l=x.normalize(l),A.readFileSync(l,a?null:"utf8")},M=l=>(l=W(l,!0),l.buffer||(l=new Uint8Array(l)),l),T=(l,a,u)=>{R(),l=x.normalize(l),A.readFile(l,function(m,I){m?u(m):a(I.buffer)})},1<process.argv.length&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(l){throw l}),process.on("unhandledRejection",function(l){throw l}),s.inspect=function(){return"[Emscripten Module object]"}):(d||E)&&(E?N=self.location.href:typeof document<"u"&&document.currentScript&&(N=document.currentScript.src),i&&(N=i),N.indexOf("blob:")!==0?N=N.substr(0,N.replace(/[?#].*/,"").lastIndexOf("/")+1):N="",W=l=>{var a=new XMLHttpRequest;return a.open("GET",l,!1),a.send(null),a.responseText},E&&(M=l=>{var a=new XMLHttpRequest;return a.open("GET",l,!1),a.responseType="arraybuffer",a.send(null),new Uint8Array(a.response)}),T=(l,a,u)=>{var m=new XMLHttpRequest;m.open("GET",l,!0),m.responseType="arraybuffer",m.onload=()=>{m.status==200||m.status==0&&m.response?a(m.response):u()},m.onerror=u,m.send(null)});var D=s.print||console.log.bind(console),P=s.printErr||console.warn.bind(console);o(s,g),g=null;var Q;s.wasmBinary&&(Q=s.wasmBinary),s.noExitRuntime,typeof WebAssembly!="object"&&re("no native wasm support detected");var w,S=!1,p=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function _(l,a,u){var m=a+u;for(u=a;l[u]&&!(u>=m);)++u;if(16<u-a&&l.subarray&&p)return p.decode(l.subarray(a,u));for(m="";a<u;){var I=l[a++];if(I&128){var C=l[a++]&63;if((I&224)==192)m+=String.fromCharCode((I&31)<<6|C);else{var j=l[a++]&63;I=(I&240)==224?(I&15)<<12|C<<6|j:(I&7)<<18|C<<12|j<<6|l[a++]&63,65536>I?m+=String.fromCharCode(I):(I-=65536,m+=String.fromCharCode(55296|I>>10,56320|I&1023))}}else m+=String.fromCharCode(I)}return m}function h(l,a,u){var m=te;if(0<u){u=a+u-1;for(var I=0;I<l.length;++I){var C=l.charCodeAt(I);if(55296<=C&&57343>=C){var j=l.charCodeAt(++I);C=65536+((C&1023)<<10)|j&1023}if(127>=C){if(a>=u)break;m[a++]=C}else{if(2047>=C){if(a+1>=u)break;m[a++]=192|C>>6}else{if(65535>=C){if(a+2>=u)break;m[a++]=224|C>>12}else{if(a+3>=u)break;m[a++]=240|C>>18,m[a++]=128|C>>12&63}m[a++]=128|C>>6&63}m[a++]=128|C&63}}m[a]=0}}var b=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function B(l,a){for(var u=l>>1,m=u+a/2;!(u>=m)&&fe[u];)++u;if(u<<=1,32<u-l&&b)return b.decode(te.subarray(l,u));for(u="",m=0;!(m>=a/2);++m){var I=ae[l+2*m>>1];if(I==0)break;u+=String.fromCharCode(I)}return u}function ie(l,a,u){if(u===void 0&&(u=2147483647),2>u)return 0;u-=2;var m=a;u=u<2*l.length?u/2:l.length;for(var I=0;I<u;++I)ae[a>>1]=l.charCodeAt(I),a+=2;return ae[a>>1]=0,a-m}function ne(l){return 2*l.length}function F(l,a){for(var u=0,m="";!(u>=a/4);){var I=se[l+4*u>>2];if(I==0)break;++u,65536<=I?(I-=65536,m+=String.fromCharCode(55296|I>>10,56320|I&1023)):m+=String.fromCharCode(I)}return m}function H(l,a,u){if(u===void 0&&(u=2147483647),4>u)return 0;var m=a;u=m+u-4;for(var I=0;I<l.length;++I){var C=l.charCodeAt(I);if(55296<=C&&57343>=C){var j=l.charCodeAt(++I);C=65536+((C&1023)<<10)|j&1023}if(se[a>>2]=C,a+=4,a+4>u)break}return se[a>>2]=0,a-m}function oe(l){for(var a=0,u=0;u<l.length;++u){var m=l.charCodeAt(u);55296<=m&&57343>=m&&++u,a+=4}return a}var ge,J,te,ae,fe,se,me,Ie,Ue;function je(){var l=w.buffer;ge=l,s.HEAP8=J=new Int8Array(l),s.HEAP16=ae=new Int16Array(l),s.HEAP32=se=new Int32Array(l),s.HEAPU8=te=new Uint8Array(l),s.HEAPU16=fe=new Uint16Array(l),s.HEAPU32=me=new Uint32Array(l),s.HEAPF32=Ie=new Float32Array(l),s.HEAPF64=Ue=new Float64Array(l)}var Y,c=[],v=[],O=[];function V(){var l=s.preRun.shift();c.unshift(l)}var U=0,K=null;s.preloadedImages={},s.preloadedAudios={};function re(l){throw s.onAbort&&s.onAbort(l),l="Aborted("+l+")",P(l),S=!0,l=new WebAssembly.RuntimeError(l+". Build with -s ASSERTIONS=1 for more info."),y(l),l}function ve(){return ue.startsWith("data:application/octet-stream;base64,")}var ue;if(ue="pathkit.wasm",!ve()){var Ve=ue;ue=s.locateFile?s.locateFile(Ve,N):N+Ve}function Ae(){var l=ue;try{if(l==ue&&Q)return new Uint8Array(Q);if(M)return M(l);throw"both async and sync fetching of the wasm failed"}catch(a){re(a)}}function Ce(){if(!Q&&(d||E)){if(typeof fetch=="function"&&!ue.startsWith("file://"))return fetch(ue,{credentials:"same-origin"}).then(function(l){if(!l.ok)throw"failed to load wasm binary file at '"+ue+"'";return l.arrayBuffer()}).catch(function(){return Ae()});if(T)return new Promise(function(l,a){T(ue,function(u){l(new Uint8Array(u))},a)})}return Promise.resolve().then(function(){return Ae()})}function we(l){for(;0<l.length;){var a=l.shift();if(typeof a=="function")a(s);else{var u=a.Wa;typeof u=="number"?a.xa===void 0?Y.get(u)():Y.get(u)(a.xa):u(a.xa===void 0?null:a.xa)}}}var _e={};function Qe(l){for(;l.length;){var a=l.pop();l.pop()(a)}}function nt(l){return this.fromWireType(me[l>>2])}var _t={},dt={},Wt={};function $i(l){if(l===void 0)return"_unknown";l=l.replace(/[^a-zA-Z0-9_]/g,"$");var a=l.charCodeAt(0);return 48<=a&&57>=a?"_"+l:l}function Pn(l,a){return l=$i(l),function(){return a.apply(this,arguments)}}function Mn(l){var a=Error,u=Pn(l,function(m){this.name=l,this.message=m,m=Error(m).stack,m!==void 0&&(this.stack=this.toString()+`
`+m.replace(/^Error(:[^\n]*)?\n/,""))});return u.prototype=Object.create(a.prototype),u.prototype.constructor=u,u.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},u}var Fi=void 0;function Yt(l){throw new Fi(l)}function it(l,a,u){function m(k){k=u(k),k.length!==l.length&&Yt("Mismatched type converter count");for(var G=0;G<l.length;++G)Je(l[G],k[G])}l.forEach(function(k){Wt[k]=a});var I=Array(a.length),C=[],j=0;a.forEach(function(k,G){dt.hasOwnProperty(k)?I[G]=dt[k]:(C.push(k),_t.hasOwnProperty(k)||(_t[k]=[]),_t[k].push(function(){I[G]=dt[k],++j,j===C.length&&m(I)}))}),C.length===0&&m(I)}var Xt={};function Kt(l){switch(l){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+l)}}var Vi=void 0;function Te(l){for(var a="";te[l];)a+=Vi[te[l++]];return a}var Et=void 0;function le(l){throw new Et(l)}function Je(l,a,u={}){if(!("argPackAdvance"in a))throw new TypeError("registerType registeredInstance requires argPackAdvance");var m=a.name;if(l||le('type "'+m+'" must have a positive integer typeid pointer'),dt.hasOwnProperty(l)){if(u.Qa)return;le("Cannot register type '"+m+"' twice")}dt[l]=a,delete Wt[l],_t.hasOwnProperty(l)&&(a=_t[l],delete _t[l],a.forEach(function(I){I()}))}function $n(l){le(l.ea.ha.fa.name+" instance already deleted")}var Fn=!1;function Ui(){}function ji(l){--l.count.value,l.count.value===0&&(l.ka?l.ma.la(l.ka):l.ha.fa.la(l.ga))}function Bt(l){return typeof FinalizationGroup>"u"?(Bt=a=>a,l):(Fn=new FinalizationGroup(function(a){for(var u=a.next();!u.done;u=a.next())u=u.value,u.ga?ji(u):console.warn("object already deleted: "+u.ga)}),Bt=a=>(Fn.register(a,a.ea,a.ea),a),Ui=a=>{Fn.unregister(a.ea)},Bt(l))}var Nt=void 0,xt=[];function Vn(){for(;xt.length;){var l=xt.pop();l.ea.pa=!1,l.delete()}}function at(){}var Gi={};function Hi(l,a,u){if(l[a].ia===void 0){var m=l[a];l[a]=function(){return l[a].ia.hasOwnProperty(arguments.length)||le("Function '"+u+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+l[a].ia+")!"),l[a].ia[arguments.length].apply(this,arguments)},l[a].ia=[],l[a].ia[m.ua]=m}}function Un(l,a,u){s.hasOwnProperty(l)?((u===void 0||s[l].ia!==void 0&&s[l].ia[u]!==void 0)&&le("Cannot register public name '"+l+"' twice"),Hi(s,l,l),s.hasOwnProperty(u)&&le("Cannot register multiple overloads of a function with the same number of arguments ("+u+")!"),s[l].ia[u]=a):(s[l]=a,u!==void 0&&(s[l].Xa=u))}function mr(l,a,u,m,I,C,j,k){this.name=l,this.constructor=a,this.qa=u,this.la=m,this.na=I,this.Oa=C,this.ta=j,this.La=k,this.Ta=[]}function jn(l,a,u){for(;a!==u;)a.ta||le("Expected null or instance of "+u.name+", got an instance of "+a.name),l=a.ta(l),a=a.na;return l}function yr(l,a){return a===null?(this.Ba&&le("null is not a valid "+this.name),0):(a.ea||le('Cannot pass "'+Xn(a)+'" as a '+this.name),a.ea.ga||le("Cannot pass deleted object as a pointer of type "+this.name),jn(a.ea.ga,a.ea.ha.fa,this.fa))}function vr(l,a){if(a===null){if(this.Ba&&le("null is not a valid "+this.name),this.wa){var u=this.sa();return l!==null&&l.push(this.la,u),u}return 0}if(a.ea||le('Cannot pass "'+Xn(a)+'" as a '+this.name),a.ea.ga||le("Cannot pass deleted object as a pointer of type "+this.name),!this.va&&a.ea.ha.va&&le("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name),u=jn(a.ea.ga,a.ea.ha.fa,this.fa),this.wa)switch(a.ea.ka===void 0&&le("Passing raw pointer to smart pointer is illegal"),this.Va){case 0:a.ea.ma===this?u=a.ea.ka:le("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name);break;case 1:u=a.ea.ka;break;case 2:if(a.ea.ma===this)u=a.ea.ka;else{var m=a.clone();u=this.Ua(u,lt(function(){m.delete()})),l!==null&&l.push(this.la,u)}break;default:le("Unsupporting sharing policy")}return u}function _r(l,a){return a===null?(this.Ba&&le("null is not a valid "+this.name),0):(a.ea||le('Cannot pass "'+Xn(a)+'" as a '+this.name),a.ea.ga||le("Cannot pass deleted object as a pointer of type "+this.name),a.ea.ha.va&&le("Cannot convert argument of type "+a.ea.ha.name+" to parameter type "+this.name),jn(a.ea.ga,a.ea.ha.fa,this.fa))}function Wi(l,a,u){return a===u?l:u.na===void 0?null:(l=Wi(l,a,u.na),l===null?null:u.La(l))}var kt={};function Er(l,a){for(a===void 0&&le("ptr should not be undefined");l.na;)a=l.ta(a),l=l.na;return kt[a]}function zt(l,a){return a.ha&&a.ga||Yt("makeClassHandle requires ptr and ptrType"),!!a.ma!=!!a.ka&&Yt("Both smartPtrType and smartPtr must be specified"),a.count={value:1},Bt(Object.create(l,{ea:{value:a}}))}function st(l,a,u,m){this.name=l,this.fa=a,this.Ba=u,this.va=m,this.wa=!1,this.la=this.Ua=this.sa=this.Ia=this.Va=this.Sa=void 0,a.na!==void 0?this.toWireType=vr:(this.toWireType=m?yr:_r,this.ja=null)}function Yi(l,a,u){s.hasOwnProperty(l)||Yt("Replacing nonexistant public symbol"),s[l].ia!==void 0&&u!==void 0?s[l].ia[u]=a:(s[l]=a,s[l].ua=u)}function Or(l,a){var u=[];return function(){u.length=arguments.length;for(var m=0;m<arguments.length;m++)u[m]=arguments[m];return l.includes("j")?(m=s["dynCall_"+l],m=u&&u.length?m.apply(null,[a].concat(u)):m.call(null,a)):m=Y.get(a).apply(null,u),m}}function Ne(l,a){l=Te(l);var u=l.includes("j")?Or(l,a):Y.get(a);return typeof u!="function"&&le("unknown function pointer with signature "+l+": "+a),u}var Xi=void 0;function Ki(l){l=es(l);var a=Te(l);return rt(l),a}function qt(l,a){function u(C){I[C]||dt[C]||(Wt[C]?Wt[C].forEach(u):(m.push(C),I[C]=!0))}var m=[],I={};throw a.forEach(u),new Xi(l+": "+m.map(Ki).join([", "]))}function Gn(l,a){for(var u=[],m=0;m<l;m++)u.push(se[(a>>2)+m]);return u}function Hn(l,a,u,m,I){var C=a.length;2>C&&le("argTypes array size mismatch! Must at least get return value and 'this' types!");var j=a[1]!==null&&u!==null,k=!1;for(u=1;u<a.length;++u)if(a[u]!==null&&a[u].ja===void 0){k=!0;break}var G=a[0].name!=="void",X=C-2,z=Array(X),ee=[],ce=[];return function(){if(arguments.length!==X&&le("function "+l+" called with "+arguments.length+" arguments, expected "+X+" args!"),ce.length=0,ee.length=j?2:1,ee[0]=I,j){var ye=a[1].toWireType(ce,this);ee[1]=ye}for(var de=0;de<X;++de)z[de]=a[de+2].toWireType(ce,arguments[de]),ee.push(z[de]);if(de=m.apply(null,ee),k)Qe(ce);else for(var xe=j?1:2;xe<a.length;xe++){var ke=xe===1?ye:z[xe-2];a[xe].ja!==null&&a[xe].ja(ke)}return ye=G?a[0].fromWireType(de):void 0,ye}}var Wn=[],ze=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function zi(l){4<l&&--ze[l].Ca===0&&(ze[l]=void 0,Wn.push(l))}function Yn(l){return l||le("Cannot use deleted val. handle = "+l),ze[l].value}function lt(l){switch(l){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var a=Wn.length?Wn.pop():ze.length;return ze[a]={Ca:1,value:l},a}}function wr(l,a,u){switch(a){case 0:return function(m){return this.fromWireType((u?J:te)[m])};case 1:return function(m){return this.fromWireType((u?ae:fe)[m>>1])};case 2:return function(m){return this.fromWireType((u?se:me)[m>>2])};default:throw new TypeError("Unknown integer type: "+l)}}function Zt(l,a){var u=dt[l];return u===void 0&&le(a+" has unknown type "+Ki(l)),u}function Xn(l){if(l===null)return"null";var a=typeof l;return a==="object"||a==="array"||a==="function"?l.toString():""+l}function Ir(l,a){switch(a){case 2:return function(u){return this.fromWireType(Ie[u>>2])};case 3:return function(u){return this.fromWireType(Ue[u>>3])};default:throw new TypeError("Unknown float type: "+l)}}function Tr(l,a,u){switch(a){case 0:return u?function(m){return J[m]}:function(m){return te[m]};case 1:return u?function(m){return ae[m>>1]}:function(m){return fe[m>>1]};case 2:return u?function(m){return se[m>>2]}:function(m){return me[m>>2]};default:throw new TypeError("Unknown integer type: "+l)}}var Ar={};function Kn(l){var a=Ar[l];return a===void 0?Te(l):a}var zn=[];function qi(){function l(a){a.$$$embind_global$$$=a;var u=typeof $$$embind_global$$$=="object"&&a.$$$embind_global$$$===a;return u||delete a.$$$embind_global$$$,u}if(typeof globalThis=="object")return globalThis;if(typeof $$$embind_global$$$=="object"||(typeof Qn=="object"&&l(Qn)?$$$embind_global$$$=Qn:typeof self=="object"&&l(self)&&($$$embind_global$$$=self),typeof $$$embind_global$$$=="object"))return $$$embind_global$$$;throw Error("unable to get global object.")}function br(l){var a=zn.length;return zn.push(l),a}function Sr(l,a){for(var u=Array(l),m=0;m<l;++m)u[m]=Zt(se[(a>>2)+m],"parameter "+m);return u}var Zi=[];function Cr(l){var a=Array(l+1);return function(u,m,I){a[0]=u;for(var C=0;C<l;++C){var j=Zt(se[(m>>2)+C],"parameter "+C);a[C+1]=j.readValueFromPointer(I),I+=j.argPackAdvance}return u=new(u.bind.apply(u,a)),lt(u)}}var Qi={},Rr=[null,[],[]];Fi=s.InternalError=Mn("InternalError");for(var Ji=Array(256),Qt=0;256>Qt;++Qt)Ji[Qt]=String.fromCharCode(Qt);Vi=Ji,Et=s.BindingError=Mn("BindingError"),at.prototype.isAliasOf=function(l){if(!(this instanceof at&&l instanceof at))return!1;var a=this.ea.ha.fa,u=this.ea.ga,m=l.ea.ha.fa;for(l=l.ea.ga;a.na;)u=a.ta(u),a=a.na;for(;m.na;)l=m.ta(l),m=m.na;return a===m&&u===l},at.prototype.clone=function(){if(this.ea.ga||$n(this),this.ea.ra)return this.ea.count.value+=1,this;var l=Bt,a=Object,u=a.create,m=Object.getPrototypeOf(this),I=this.ea;return l=l(u.call(a,m,{ea:{value:{count:I.count,pa:I.pa,ra:I.ra,ga:I.ga,ha:I.ha,ka:I.ka,ma:I.ma}}})),l.ea.count.value+=1,l.ea.pa=!1,l},at.prototype.delete=function(){this.ea.ga||$n(this),this.ea.pa&&!this.ea.ra&&le("Object already scheduled for deletion"),Ui(this),ji(this.ea),this.ea.ra||(this.ea.ka=void 0,this.ea.ga=void 0)},at.prototype.isDeleted=function(){return!this.ea.ga},at.prototype.deleteLater=function(){return this.ea.ga||$n(this),this.ea.pa&&!this.ea.ra&&le("Object already scheduled for deletion"),xt.push(this),xt.length===1&&Nt&&Nt(Vn),this.ea.pa=!0,this},st.prototype.Pa=function(l){return this.Ia&&(l=this.Ia(l)),l},st.prototype.Ga=function(l){this.la&&this.la(l)},st.prototype.argPackAdvance=8,st.prototype.readValueFromPointer=nt,st.prototype.deleteObject=function(l){l!==null&&l.delete()},st.prototype.fromWireType=function(l){function a(){return this.wa?zt(this.fa.qa,{ha:this.Sa,ga:u,ma:this,ka:l}):zt(this.fa.qa,{ha:this,ga:l})}var u=this.Pa(l);if(!u)return this.Ga(l),null;var m=Er(this.fa,u);if(m!==void 0)return m.ea.count.value===0?(m.ea.ga=u,m.ea.ka=l,m.clone()):(m=m.clone(),this.Ga(l),m);if(m=this.fa.Oa(u),m=Gi[m],!m)return a.call(this);m=this.va?m.Ja:m.pointerType;var I=Wi(u,this.fa,m.fa);return I===null?a.call(this):this.wa?zt(m.fa.qa,{ha:m,ga:I,ma:this,ka:l}):zt(m.fa.qa,{ha:m,ga:I})},s.getInheritedInstanceCount=function(){return Object.keys(kt).length},s.getLiveInheritedInstances=function(){var l=[],a;for(a in kt)kt.hasOwnProperty(a)&&l.push(kt[a]);return l},s.flushPendingDeletes=Vn,s.setDelayFunction=function(l){Nt=l,xt.length&&Nt&&Nt(Vn)},Xi=s.UnboundTypeError=Mn("UnboundTypeError"),s.count_emval_handles=function(){for(var l=0,a=5;a<ze.length;++a)ze[a]!==void 0&&++l;return l},s.get_first_emval=function(){for(var l=5;l<ze.length;++l)if(ze[l]!==void 0)return ze[l];return null};var Br={r:function(l){var a=_e[l];delete _e[l];var u=a.elements,m=u.length,I=u.map(function(k){return k.Aa}).concat(u.map(function(k){return k.Ea})),C=a.sa,j=a.la;it([l],I,function(k){return u.forEach(function(G,X){var z=k[X],ee=G.ya,ce=G.za,ye=k[X+m],de=G.Da,xe=G.Fa;G.read=ke=>z.fromWireType(ee(ce,ke)),G.write=(ke,ft)=>{var We=[];de(xe,ke,ye.toWireType(We,ft)),Qe(We)}}),[{name:a.name,fromWireType:function(G){for(var X=Array(m),z=0;z<m;++z)X[z]=u[z].read(G);return j(G),X},toWireType:function(G,X){if(m!==X.length)throw new TypeError("Incorrect number of tuple elements for "+a.name+": expected="+m+", actual="+X.length);for(var z=C(),ee=0;ee<m;++ee)u[ee].write(z,X[ee]);return G!==null&&G.push(j,z),z},argPackAdvance:8,readValueFromPointer:nt,ja:j}]})},u:function(l){var a=Xt[l];delete Xt[l];var u=a.sa,m=a.la,I=a.Ha,C=I.map(function(j){return j.Aa}).concat(I.map(function(j){return j.Ea}));it([l],C,function(j){var k={};return I.forEach(function(G,X){var z=j[X],ee=G.ya,ce=G.za,ye=j[X+I.length],de=G.Da,xe=G.Fa;k[G.Na]={read:function(ke){return z.fromWireType(ee(ce,ke))},write:function(ke,ft){var We=[];de(xe,ke,ye.toWireType(We,ft)),Qe(We)}}}),[{name:a.name,fromWireType:function(G){var X={},z;for(z in k)X[z]=k[z].read(G);return m(G),X},toWireType:function(G,X){for(var z in k)if(!(z in X))throw new TypeError('Missing field:  "'+z+'"');var ee=u();for(z in k)k[z].write(ee,X[z]);return G!==null&&G.push(m,ee),ee},argPackAdvance:8,readValueFromPointer:nt,ja:m}]})},z:function(){},F:function(l,a,u,m,I){var C=Kt(u);a=Te(a),Je(l,{name:a,fromWireType:function(j){return!!j},toWireType:function(j,k){return k?m:I},argPackAdvance:8,readValueFromPointer:function(j){if(u===1)var k=J;else if(u===2)k=ae;else if(u===4)k=se;else throw new TypeError("Unknown boolean type size: "+a);return this.fromWireType(k[j>>C])},ja:null})},l:function(l,a,u,m,I,C,j,k,G,X,z,ee,ce){z=Te(z),C=Ne(I,C),k&&(k=Ne(j,k)),X&&(X=Ne(G,X)),ce=Ne(ee,ce);var ye=$i(z);Un(ye,function(){qt("Cannot construct "+z+" due to unbound types",[m])}),it([l,a,u],m?[m]:[],function(de){if(de=de[0],m)var xe=de.fa,ke=xe.qa;else ke=at.prototype;de=Pn(ye,function(){if(Object.getPrototypeOf(this)!==ft)throw new Et("Use 'new' to construct "+z);if(We.oa===void 0)throw new Et(z+" has no accessible constructor");var ns=We.oa[arguments.length];if(ns===void 0)throw new Et("Tried to invoke ctor of "+z+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(We.oa).toString()+") parameters instead!");return ns.apply(this,arguments)});var ft=Object.create(ke,{constructor:{value:de}});de.prototype=ft;var We=new mr(z,de,ft,ce,xe,C,k,X);xe=new st(z,We,!0,!1),ke=new st(z+"*",We,!1,!1);var ts=new st(z+" const*",We,!1,!0);return Gi[l]={pointerType:ke,Ja:ts},Yi(ye,de),[xe,ke,ts]})},i:function(l,a,u,m,I,C){0<a||re(void 0);var j=Gn(a,u);I=Ne(m,I),it([],[l],function(k){k=k[0];var G="constructor "+k.name;if(k.fa.oa===void 0&&(k.fa.oa=[]),k.fa.oa[a-1]!==void 0)throw new Et("Cannot register multiple constructors with identical number of parameters ("+(a-1)+") for class '"+k.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return k.fa.oa[a-1]=()=>{qt("Cannot construct "+k.name+" due to unbound types",j)},it([],j,function(X){return X.splice(1,0,null),k.fa.oa[a-1]=Hn(G,X,null,I,C),[]}),[]})},a:function(l,a,u,m,I,C,j,k){var G=Gn(u,m);a=Te(a),C=Ne(I,C),it([],[l],function(X){function z(){qt("Cannot call "+ee+" due to unbound types",G)}X=X[0];var ee=X.name+"."+a;a.startsWith("@@")&&(a=Symbol[a.substring(2)]),k&&X.fa.Ta.push(a);var ce=X.fa.qa,ye=ce[a];return ye===void 0||ye.ia===void 0&&ye.className!==X.name&&ye.ua===u-2?(z.ua=u-2,z.className=X.name,ce[a]=z):(Hi(ce,a,ee),ce[a].ia[u-2]=z),it([],G,function(de){return de=Hn(ee,de,X,C,j),ce[a].ia===void 0?(de.ua=u-2,ce[a]=de):ce[a].ia[u-2]=de,[]}),[]})},I:function(l,a,u){l=Te(l),it([],[a],function(m){return m=m[0],s[l]=m.fromWireType(u),[]})},E:function(l,a){a=Te(a),Je(l,{name:a,fromWireType:function(u){var m=Yn(u);return zi(u),m},toWireType:function(u,m){return lt(m)},argPackAdvance:8,readValueFromPointer:nt,ja:null})},h:function(l,a,u,m){function I(){}u=Kt(u),a=Te(a),I.values={},Je(l,{name:a,constructor:I,fromWireType:function(C){return this.constructor.values[C]},toWireType:function(C,j){return j.value},argPackAdvance:8,readValueFromPointer:wr(a,u,m),ja:null}),Un(a,I)},k:function(l,a,u){var m=Zt(l,"enum");a=Te(a),l=m.constructor,m=Object.create(m.constructor.prototype,{value:{value:u},constructor:{value:Pn(m.name+"_"+a,function(){})}}),l.values[u]=m,l[a]=m},q:function(l,a,u){u=Kt(u),a=Te(a),Je(l,{name:a,fromWireType:function(m){return m},toWireType:function(m,I){return I},argPackAdvance:8,readValueFromPointer:Ir(a,u),ja:null})},f:function(l,a,u,m,I,C){var j=Gn(a,u);l=Te(l),I=Ne(m,I),Un(l,function(){qt("Cannot call "+l+" due to unbound types",j)},a-1),it([],j,function(k){return k=[k[0],null].concat(k.slice(1)),Yi(l,Hn(l,k,null,I,C),a-1),[]})},e:function(l,a,u,m,I){a=Te(a),I===-1&&(I=4294967295),I=Kt(u);var C=k=>k;if(m===0){var j=32-8*u;C=k=>k<<j>>>j}u=a.includes("unsigned")?function(k,G){return G>>>0}:function(k,G){return G},Je(l,{name:a,fromWireType:C,toWireType:u,argPackAdvance:8,readValueFromPointer:Tr(a,I,m!==0),ja:null})},b:function(l,a,u){function m(C){C>>=2;var j=me;return new I(ge,j[C+1],j[C])}var I=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][a];u=Te(u),Je(l,{name:u,fromWireType:m,argPackAdvance:8,readValueFromPointer:m},{Qa:!0})},p:function(l,a){a=Te(a);var u=a==="std::string";Je(l,{name:a,fromWireType:function(m){var I=me[m>>2];if(u)for(var C=m+4,j=0;j<=I;++j){var k=m+4+j;if(j==I||te[k]==0){if(C=C?_(te,C,k-C):"",G===void 0)var G=C;else G+=String.fromCharCode(0),G+=C;C=k+1}}else{for(G=Array(I),j=0;j<I;++j)G[j]=String.fromCharCode(te[m+4+j]);G=G.join("")}return rt(m),G},toWireType:function(m,I){I instanceof ArrayBuffer&&(I=new Uint8Array(I));var C=typeof I=="string";C||I instanceof Uint8Array||I instanceof Uint8ClampedArray||I instanceof Int8Array||le("Cannot pass non-string to std::string");var j=(u&&C?()=>{for(var X=0,z=0;z<I.length;++z){var ee=I.charCodeAt(z);55296<=ee&&57343>=ee&&(ee=65536+((ee&1023)<<10)|I.charCodeAt(++z)&1023),127>=ee?++X:X=2047>=ee?X+2:65535>=ee?X+3:X+4}return X}:()=>I.length)(),k=qn(4+j+1);if(me[k>>2]=j,u&&C)h(I,k+4,j+1);else if(C)for(C=0;C<j;++C){var G=I.charCodeAt(C);255<G&&(rt(k),le("String has UTF-16 code units that do not fit in 8 bits")),te[k+4+C]=G}else for(C=0;C<j;++C)te[k+4+C]=I[C];return m!==null&&m.push(rt,k),k},argPackAdvance:8,readValueFromPointer:nt,ja:function(m){rt(m)}})},m:function(l,a,u){if(u=Te(u),a===2)var m=B,I=ie,C=ne,j=()=>fe,k=1;else a===4&&(m=F,I=H,C=oe,j=()=>me,k=2);Je(l,{name:u,fromWireType:function(G){for(var X=me[G>>2],z=j(),ee,ce=G+4,ye=0;ye<=X;++ye){var de=G+4+ye*a;(ye==X||z[de>>k]==0)&&(ce=m(ce,de-ce),ee===void 0?ee=ce:(ee+=String.fromCharCode(0),ee+=ce),ce=de+a)}return rt(G),ee},toWireType:function(G,X){typeof X!="string"&&le("Cannot pass non-string to C++ string type "+u);var z=C(X),ee=qn(4+z+a);return me[ee>>2]=z>>k,I(X,ee+4,z+a),G!==null&&G.push(rt,ee),ee},argPackAdvance:8,readValueFromPointer:nt,ja:function(G){rt(G)}})},t:function(l,a,u,m,I,C){_e[l]={name:Te(a),sa:Ne(u,m),la:Ne(I,C),elements:[]}},s:function(l,a,u,m,I,C,j,k,G){_e[l].elements.push({Aa:a,ya:Ne(u,m),za:I,Ea:C,Da:Ne(j,k),Fa:G})},v:function(l,a,u,m,I,C){Xt[l]={name:Te(a),sa:Ne(u,m),la:Ne(I,C),Ha:[]}},j:function(l,a,u,m,I,C,j,k,G,X){Xt[l].Ha.push({Na:Te(a),Aa:u,ya:Ne(m,I),za:C,Ea:j,Da:Ne(k,G),Fa:X})},G:function(l,a){a=Te(a),Je(l,{Ra:!0,name:a,argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},d:function(l,a,u,m){l=zn[l],a=Yn(a),u=Kn(u),l(a,u,null,m)},J:zi,x:function(l){return l===0?lt(qi()):(l=Kn(l),lt(qi()[l]))},c:function(l,a){var u=Sr(l,a),m=u[0];a=m.name+"_$"+u.slice(1).map(function(j){return j.name}).join("_")+"$";var I=Zi[a];if(I!==void 0)return I;var C=Array(l-1);return I=br((j,k,G,X)=>{for(var z=0,ee=0;ee<l-1;++ee)C[ee]=u[ee+1].readValueFromPointer(X+z),z+=u[ee+1].argPackAdvance;for(j=j[k].apply(j,C),ee=0;ee<l-1;++ee)u[ee+1].Ka&&u[ee+1].Ka(C[ee]);if(!m.Ra)return m.toWireType(G,j)}),Zi[a]=I},n:function(l){4<l&&(ze[l].Ca+=1)},w:function(l,a,u,m){l=Yn(l);var I=Qi[a];return I||(I=Cr(a),Qi[a]=I),I(l,u,m)},K:function(){return lt([])},D:function(l){return lt(Kn(l))},H:function(l,a){return l=Zt(l,"_emval_take_value"),l=l.readValueFromPointer(a),lt(l)},g:function(){re("")},B:function(l){var a=te.length;if(l>>>=0,2147483648<l)return!1;for(var u=1;4>=u;u*=2){var m=a*(1+.2/u);m=Math.min(m,l+100663296),m=Math.max(l,m),0<m%65536&&(m+=65536-m%65536);e:{try{w.grow(Math.min(2147483648,m)-ge.byteLength+65535>>>16),je();var I=1;break e}catch{}I=void 0}if(I)return!0}return!1},C:function(){return 0},y:function(){},o:function(l,a,u,m){for(var I=0,C=0;C<u;C++){var j=se[a>>2],k=se[a+4>>2];a+=8;for(var G=0;G<k;G++){var X=te[j+G],z=Rr[l];X===0||X===10?((l===1?D:P)(_(z,0)),z.length=0):z.push(X)}I+=k}return se[m>>2]=I,0},A:function(){}};(function(){function l(I){s.asm=I.exports,w=s.asm.L,je(),Y=s.asm._,v.unshift(s.asm.M),U--,s.monitorRunDependencies&&s.monitorRunDependencies(U),U==0&&K&&(I=K,K=null,I())}function a(I){l(I.instance)}function u(I){return Ce().then(function(C){return WebAssembly.instantiate(C,m)}).then(function(C){return C}).then(I,function(C){P("failed to asynchronously prepare wasm: "+C),re(C)})}var m={a:Br};if(U++,s.monitorRunDependencies&&s.monitorRunDependencies(U),s.instantiateWasm)try{return s.instantiateWasm(m,l)}catch(I){return P("Module.instantiateWasm callback failed with error: "+I),!1}return function(){return Q||typeof WebAssembly.instantiateStreaming!="function"||ve()||ue.startsWith("file://")||typeof fetch!="function"?u(a):fetch(ue,{credentials:"same-origin"}).then(function(I){return WebAssembly.instantiateStreaming(I,m).then(a,function(C){return P("wasm streaming compile failed: "+C),P("falling back to ArrayBuffer instantiation"),u(a)})})}().catch(y),{}})(),s.___wasm_call_ctors=function(){return(s.___wasm_call_ctors=s.asm.M).apply(null,arguments)},s.__Z6ToCmdsRK6SkPath=function(){return(s.__Z6ToCmdsRK6SkPath=s.asm.N).apply(null,arguments)},s.__Z8FromCmdsmi=function(){return(s.__Z8FromCmdsmi=s.asm.O).apply(null,arguments)},s.__Z7NewPathv=function(){return(s.__Z7NewPathv=s.asm.P).apply(null,arguments)},s.__Z8CopyPathRK6SkPath=function(){return(s.__Z8CopyPathRK6SkPath=s.asm.Q).apply(null,arguments)},s.__Z6EqualsRK6SkPathS1_=function(){return(s.__Z6EqualsRK6SkPathS1_=s.asm.R).apply(null,arguments)},s.__Z11ToSVGStringRK6SkPath=function(){return(s.__Z11ToSVGStringRK6SkPath=s.asm.S).apply(null,arguments)},s.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=function(){return(s.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=s.asm.T).apply(null,arguments)},s.__Z13ApplySimplifyR6SkPath=function(){return(s.__Z13ApplySimplifyR6SkPath=s.asm.U).apply(null,arguments)},s.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=function(){return(s.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=s.asm.V).apply(null,arguments)},s.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=function(){return(s.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=s.asm.W).apply(null,arguments)},s.__Z14ResolveBuilderR11SkOpBuilder=function(){return(s.__Z14ResolveBuilderR11SkOpBuilder=s.asm.X).apply(null,arguments)},s.__Z8ToCanvasRK6SkPathN10emscripten3valE=function(){return(s.__Z8ToCanvasRK6SkPathN10emscripten3valE=s.asm.Y).apply(null,arguments)},s.__Z8ToPath2DRK6SkPath=function(){return(s.__Z8ToPath2DRK6SkPath=s.asm.Z).apply(null,arguments)};var rt=s._free=function(){return(rt=s._free=s.asm.$).apply(null,arguments)},qn=s._malloc=function(){return(qn=s._malloc=s.asm.aa).apply(null,arguments)},es=s.___getTypeName=function(){return(es=s.___getTypeName=s.asm.ba).apply(null,arguments)};s.___embind_register_native_and_builtin_types=function(){return(s.___embind_register_native_and_builtin_types=s.asm.ca).apply(null,arguments)},s.dynCall_jiji=function(){return(s.dynCall_jiji=s.asm.da).apply(null,arguments)};var Jt;K=function l(){Jt||Zn(),Jt||(K=l)};function Zn(){function l(){if(!Jt&&(Jt=!0,s.calledRun=!0,!S)){if(we(v),f(s),s.onRuntimeInitialized&&s.onRuntimeInitialized(),s.postRun)for(typeof s.postRun=="function"&&(s.postRun=[s.postRun]);s.postRun.length;){var a=s.postRun.shift();O.unshift(a)}we(O)}}if(!(0<U)){if(s.preRun)for(typeof s.preRun=="function"&&(s.preRun=[s.preRun]);s.preRun.length;)V();we(c),0<U||(s.setStatus?(s.setStatus("Running..."),setTimeout(function(){setTimeout(function(){s.setStatus("")},1),l()},1)):l())}}if(s.run=Zn,s.preInit)for(typeof s.preInit=="function"&&(s.preInit=[s.preInit]);0<s.preInit.length;)s.preInit.pop()();return Zn(),r.ready}})();n.exports=t})(Qs);var oa=Qs.exports;const aa=Ls(oa),la="/assets/pathkit-1356ccfa.wasm";let Xe=null,En="",On="",wn="",In="";async function Js(){await q.scene.local.deleteItems([In,En,On,wn]),En="",On="",In="",wn="",await q.popover.close(L.POLYTOOLID)}async function er(){if(!Xe)return;const[n,e]=Xe;e(),Xe=null,Js()}async function tr(){if(!Xe)return;const[n,e]=Xe,t=n(i=>{i.visible=!1,i.metadata[`${L.EXTENSIONID}/isVisionLine`]=!0,i.points.pop(),i.points.push(i.points[0])});t.points.length>=4&&q.scene.items.addItems([t]),e(),Xe=null,Js()}async function ua(n,e){if(!e.transformer)if(Xe)if(e.target&&(e.target.id===En||e.target.id===On))tr();else if(e.target&&(e.target.id===In||e.target.id===wn))er();else{const[t]=Xe;t(i=>{i.points.push(e.pointerPosition)})}else{const t=_n().plainText("Finish [Enter]").position({x:e.pointerPosition.x,y:e.pointerPosition.y-50}).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").build(),i=zs().tension(0).points([e.pointerPosition,e.pointerPosition]).fillColor("#000000").fillOpacity(.5).strokeColor("#000000").layer("DRAWING").name("Vision Line (Polygon)").build();Xe=await q.interaction.startItemInteraction(i);const r=Rt().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").build(),s=Rt().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").visible(!1).build(),o=_n().plainText("Cancel [Escape]").position(e.pointerPosition).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").pointerDirection("UP").build();await q.scene.local.addItems([t,r,s,o]),En=t.id,On=r.id,In=o.id,wn=s.id,await q.popover.open({id:L.POLYTOOLID,url:"/pages/polygon.html",height:40,width:400,disableClickAway:!0})}}function ca(n,e){if(!Xe||e.transformer)return;const[t]=Xe;t(i=>{i.points[i.points.length-1]=e.pointerPosition})}function da(n,e){Xe&&(e.key=="Escape"?er():e.key=="Enter"&&tr())}const oi={onToolClick:ua,onToolMove:ca,onKeyDown:da};let Ke=null,Ft="",Vt="",Tn="",An="";async function nr(){await q.scene.local.deleteItems([An,Ft,Vt,Tn]),Ft="",Vt="",An="",Tn="",await q.popover.close(L.LINETOOLID)}async function ir(){if(!Ke)return;const[n,e]=Ke;e(),Ke=null,await nr()}async function sr(){if(!Ke)return;const[n,e]=Ke,t=n(i=>{i.visible=!1,i.metadata[`${L.EXTENSIONID}/isVisionLine`]=!0,i.points.pop()});t.points.length>=2&&await q.scene.items.addItems([t]),e(),Ke=null,await nr()}async function fa(n,e){if(!e.transformer)if(Ke)if(e.target&&(e.target.id===Ft||e.target.id===Vt))await sr();else if(e.target&&(e.target.id===An||e.target.id===Tn))await ir();else{const[t]=Ke;t(i=>{i.points.push(e.pointerPosition)}),await q.scene.local.updateItems(i=>i.id==Vt||i.id==Ft,i=>{for(const r of i)r.position=e.pointerPosition})}else{const t=_n().plainText("Finish [Enter]").position({x:e.pointerPosition.x,y:e.pointerPosition.y-50}).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").build(),i=zs().tension(0).points([e.pointerPosition,e.pointerPosition]).fillColor("#000000").fillOpacity(0).layer("DRAWING").name("Vision Line (Line)").closed(!1).build();Ke=await q.interaction.startItemInteraction(i);const r=Rt().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").build(),s=Rt().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").visible(!1).build(),o=_n().plainText("Cancel [Escape]").position(e.pointerPosition).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").pointerDirection("UP").build();await q.scene.local.addItems([t,r,s,o]),Ft=t.id,Vt=r.id,An=o.id,Tn=s.id,await q.popover.open({id:L.LINETOOLID,url:"/pages/line.html",height:40,width:400,disableClickAway:!0})}}function ha(n,e){if(!Ke||e.transformer)return;const[t]=Ke,i=Math.round(Z.gridDpi/Z.gridSnap),r=Math.round(e.pointerPosition.x/Z.gridDpi)*Z.gridDpi,s=Math.round(e.pointerPosition.y/Z.gridDpi)*Z.gridDpi,o=Math.abs(r-e.pointerPosition.x),f=Math.abs(s-e.pointerPosition.y);let y,g;o<=i?y=r:y=e.pointerPosition.x,f<=i?g=s:g=e.pointerPosition.y,t(d=>{d.points[d.points.length-1]={x:y,y:g}})}function pa(n,e){Ke&&(e.key=="Escape"?ir():e.key=="Enter"&&sr())}const ai={onToolClick:fa,onToolMove:ha,onKeyDown:pa};class _s{startTime;accumulatedTime;constructor(){this.startTime=-1,this.accumulatedTime=-1}start(){this.startTime=performance.now(),this.accumulatedTime=0}resume(){this.startTime=performance.now()}pause(){return this.accumulatedTime+=performance.now()-this.startTime,this.startTime=-1,this.accumulatedTime}stop(){if(this.startTime!=-1){const e=performance.now()-this.startTime+this.accumulatedTime;return this.accumulatedTime=0,e}else{const e=this.accumulatedTime;return this.accumulatedTime=0,e}}}function sn(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var rr={exports:{}};(function(n,e){(function(t){n.exports=t()})(function(){return function t(i,r,s){function o(g,d){if(!r[g]){if(!i[g]){var E=typeof sn=="function"&&sn;if(!d&&E)return E(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}d=r[g]={exports:{}},i[g][0].call(d.exports,function(N){var W=i[g][1][N];return o(W||N)},d,d.exports,t,i,r,s)}return r[g].exports}for(var f=typeof sn=="function"&&sn,y=0;y<s.length;y++)o(s[y]);return o}({1:[function(t,i,r){(function(s,o,f,y,g,d,E,N,W){var T=t("crypto");function M(w,S){S=R(w,S);var p;return(p=S.algorithm!=="passthrough"?T.createHash(S.algorithm):new Q).write===void 0&&(p.write=p.update,p.end=p.update),P(S,p).dispatch(w),p.update||p.end(""),p.digest?p.digest(S.encoding==="buffer"?void 0:S.encoding):(w=p.read(),S.encoding!=="buffer"?w.toString(S.encoding):w)}(r=i.exports=M).sha1=function(w){return M(w)},r.keys=function(w){return M(w,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},r.MD5=function(w){return M(w,{algorithm:"md5",encoding:"hex"})},r.keysMD5=function(w){return M(w,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var A=T.getHashes?T.getHashes().slice():["sha1","md5"],x=(A.push("passthrough"),["buffer","hex","binary","base64"]);function R(w,S){var p={};if(p.algorithm=(S=S||{}).algorithm||"sha1",p.encoding=S.encoding||"hex",p.excludeValues=!!S.excludeValues,p.algorithm=p.algorithm.toLowerCase(),p.encoding=p.encoding.toLowerCase(),p.ignoreUnknown=S.ignoreUnknown===!0,p.respectType=S.respectType!==!1,p.respectFunctionNames=S.respectFunctionNames!==!1,p.respectFunctionProperties=S.respectFunctionProperties!==!1,p.unorderedArrays=S.unorderedArrays===!0,p.unorderedSets=S.unorderedSets!==!1,p.unorderedObjects=S.unorderedObjects!==!1,p.replacer=S.replacer||void 0,p.excludeKeys=S.excludeKeys||void 0,w===void 0)throw new Error("Object argument required.");for(var _=0;_<A.length;++_)A[_].toLowerCase()===p.algorithm.toLowerCase()&&(p.algorithm=A[_]);if(A.indexOf(p.algorithm)===-1)throw new Error('Algorithm "'+p.algorithm+'"  not supported. supported values: '+A.join(", "));if(x.indexOf(p.encoding)===-1&&p.algorithm!=="passthrough")throw new Error('Encoding "'+p.encoding+'"  not supported. supported values: '+x.join(", "));return p}function D(w){if(typeof w=="function")return/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(w))!=null}function P(w,S,p){p=p||[];function _(h){return S.update?S.update(h,"utf8"):S.write(h,"utf8")}return{dispatch:function(h){return this["_"+((h=w.replacer?w.replacer(h):h)===null?"null":typeof h)](h)},_object:function(h){var b,B=Object.prototype.toString.call(h),ie=/\[object (.*)\]/i.exec(B);if(ie=(ie=ie?ie[1]:"unknown:["+B+"]").toLowerCase(),0<=(B=p.indexOf(h)))return this.dispatch("[CIRCULAR:"+B+"]");if(p.push(h),f!==void 0&&f.isBuffer&&f.isBuffer(h))return _("buffer:"),_(h);if(ie==="object"||ie==="function"||ie==="asyncfunction")return B=Object.keys(h),w.unorderedObjects&&(B=B.sort()),w.respectType===!1||D(h)||B.splice(0,0,"prototype","__proto__","constructor"),w.excludeKeys&&(B=B.filter(function(ne){return!w.excludeKeys(ne)})),_("object:"+B.length+":"),b=this,B.forEach(function(ne){b.dispatch(ne),_(":"),w.excludeValues||b.dispatch(h[ne]),_(",")});if(!this["_"+ie]){if(w.ignoreUnknown)return _("["+ie+"]");throw new Error('Unknown object type "'+ie+'"')}this["_"+ie](h)},_array:function(h,ne){ne=ne!==void 0?ne:w.unorderedArrays!==!1;var B=this;if(_("array:"+h.length+":"),!ne||h.length<=1)return h.forEach(function(F){return B.dispatch(F)});var ie=[],ne=h.map(function(F){var H=new Q,oe=p.slice();return P(w,H,oe).dispatch(F),ie=ie.concat(oe.slice(p.length)),H.read().toString()});return p=p.concat(ie),ne.sort(),this._array(ne,!1)},_date:function(h){return _("date:"+h.toJSON())},_symbol:function(h){return _("symbol:"+h.toString())},_error:function(h){return _("error:"+h.toString())},_boolean:function(h){return _("bool:"+h.toString())},_string:function(h){_("string:"+h.length+":"),_(h.toString())},_function:function(h){_("fn:"),D(h)?this.dispatch("[native]"):this.dispatch(h.toString()),w.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(h.name)),w.respectFunctionProperties&&this._object(h)},_number:function(h){return _("number:"+h.toString())},_xml:function(h){return _("xml:"+h.toString())},_null:function(){return _("Null")},_undefined:function(){return _("Undefined")},_regexp:function(h){return _("regex:"+h.toString())},_uint8array:function(h){return _("uint8array:"),this.dispatch(Array.prototype.slice.call(h))},_uint8clampedarray:function(h){return _("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(h))},_int8array:function(h){return _("int8array:"),this.dispatch(Array.prototype.slice.call(h))},_uint16array:function(h){return _("uint16array:"),this.dispatch(Array.prototype.slice.call(h))},_int16array:function(h){return _("int16array:"),this.dispatch(Array.prototype.slice.call(h))},_uint32array:function(h){return _("uint32array:"),this.dispatch(Array.prototype.slice.call(h))},_int32array:function(h){return _("int32array:"),this.dispatch(Array.prototype.slice.call(h))},_float32array:function(h){return _("float32array:"),this.dispatch(Array.prototype.slice.call(h))},_float64array:function(h){return _("float64array:"),this.dispatch(Array.prototype.slice.call(h))},_arraybuffer:function(h){return _("arraybuffer:"),this.dispatch(new Uint8Array(h))},_url:function(h){return _("url:"+h.toString())},_map:function(h){return _("map:"),h=Array.from(h),this._array(h,w.unorderedSets!==!1)},_set:function(h){return _("set:"),h=Array.from(h),this._array(h,w.unorderedSets!==!1)},_file:function(h){return _("file:"),this.dispatch([h.name,h.size,h.type,h.lastModfied])},_blob:function(){if(w.ignoreUnknown)return _("[blob]");throw Error(`Hashing Blob objects is currently not supported
(see https://github.com/puleos/object-hash/issues/26)
Use "options.replacer" or "options.ignoreUnknown"
`)},_domwindow:function(){return _("domwindow")},_bigint:function(h){return _("bigint:"+h.toString())},_process:function(){return _("process")},_timer:function(){return _("timer")},_pipe:function(){return _("pipe")},_tcp:function(){return _("tcp")},_udp:function(){return _("udp")},_tty:function(){return _("tty")},_statwatcher:function(){return _("statwatcher")},_securecontext:function(){return _("securecontext")},_connection:function(){return _("connection")},_zlib:function(){return _("zlib")},_context:function(){return _("context")},_nodescript:function(){return _("nodescript")},_httpparser:function(){return _("httpparser")},_dataview:function(){return _("dataview")},_signal:function(){return _("signal")},_fsevent:function(){return _("fsevent")},_tlswrap:function(){return _("tlswrap")}}}function Q(){return{buf:"",write:function(w){this.buf+=w},end:function(w){this.buf+=w},read:function(){return this.buf}}}r.writeToStream=function(w,S,p){return p===void 0&&(p=S,S={}),P(S=R(w,S),p).dispatch(w)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_9a5aa49d.js","/")},{buffer:3,crypto:5,lYpoI2:11}],2:[function(t,i,r){(function(s,o,f,y,g,d,E,N,W){(function(T){var M=typeof Uint8Array<"u"?Uint8Array:Array,A="+".charCodeAt(0),x="/".charCodeAt(0),R="0".charCodeAt(0),D="a".charCodeAt(0),P="A".charCodeAt(0),Q="-".charCodeAt(0),w="_".charCodeAt(0);function S(p){return p=p.charCodeAt(0),p===A||p===Q?62:p===x||p===w?63:p<R?-1:p<R+10?p-R+26+26:p<P+26?p-P:p<D+26?p-D+26:void 0}T.toByteArray=function(p){var _,h;if(0<p.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var b=p.length,b=p.charAt(b-2)==="="?2:p.charAt(b-1)==="="?1:0,B=new M(3*p.length/4-b),ie=0<b?p.length-4:p.length,ne=0;function F(H){B[ne++]=H}for(_=0;_<ie;_+=4,0)F((16711680&(h=S(p.charAt(_))<<18|S(p.charAt(_+1))<<12|S(p.charAt(_+2))<<6|S(p.charAt(_+3))))>>16),F((65280&h)>>8),F(255&h);return b==2?F(255&(h=S(p.charAt(_))<<2|S(p.charAt(_+1))>>4)):b==1&&(F((h=S(p.charAt(_))<<10|S(p.charAt(_+1))<<4|S(p.charAt(_+2))>>2)>>8&255),F(255&h)),B},T.fromByteArray=function(p){var _,h,b,B,ie=p.length%3,ne="";function F(H){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(H)}for(_=0,b=p.length-ie;_<b;_+=3)h=(p[_]<<16)+(p[_+1]<<8)+p[_+2],ne+=F((B=h)>>18&63)+F(B>>12&63)+F(B>>6&63)+F(63&B);switch(ie){case 1:ne=(ne+=F((h=p[p.length-1])>>2))+F(h<<4&63)+"==";break;case 2:ne=(ne=(ne+=F((h=(p[p.length-2]<<8)+p[p.length-1])>>10))+F(h>>4&63))+F(h<<2&63)+"="}return ne}})(r===void 0?this.base64js={}:r)}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:11}],3:[function(t,i,r){(function(s,o,A,y,g,d,E,N,W){var T=t("base64-js"),M=t("ieee754");function A(c,v,O){if(!(this instanceof A))return new A(c,v,O);var V,U,K,re,ve=typeof c;if(v==="base64"&&ve=="string")for(c=(re=c).trim?re.trim():re.replace(/^\s+|\s+$/g,"");c.length%4!=0;)c+="=";if(ve=="number")V=ge(c);else if(ve=="string")V=A.byteLength(c,v);else{if(ve!="object")throw new Error("First argument needs to be a number, array or string.");V=ge(c.length)}if(A._useTypedArrays?U=A._augment(new Uint8Array(V)):((U=this).length=V,U._isBuffer=!0),A._useTypedArrays&&typeof c.byteLength=="number")U._set(c);else if(J(re=c)||A.isBuffer(re)||re&&typeof re=="object"&&typeof re.length=="number")for(K=0;K<V;K++)A.isBuffer(c)?U[K]=c.readUInt8(K):U[K]=c[K];else if(ve=="string")U.write(c,0,v);else if(ve=="number"&&!A._useTypedArrays&&!O)for(K=0;K<V;K++)U[K]=0;return U}function x(c,v,O,V){return A._charsWritten=se(function(U){for(var K=[],re=0;re<U.length;re++)K.push(255&U.charCodeAt(re));return K}(v),c,O,V)}function R(c,v,O,V){return A._charsWritten=se(function(U){for(var K,re,ve=[],ue=0;ue<U.length;ue++)re=U.charCodeAt(ue),K=re>>8,re=re%256,ve.push(re),ve.push(K);return ve}(v),c,O,V)}function D(c,v,O){var V="";O=Math.min(c.length,O);for(var U=v;U<O;U++)V+=String.fromCharCode(c[U]);return V}function P(c,v,O,K){K||(Y(typeof O=="boolean","missing or invalid endian"),Y(v!=null,"missing offset"),Y(v+1<c.length,"Trying to read beyond buffer length"));var U,K=c.length;if(!(K<=v))return O?(U=c[v],v+1<K&&(U|=c[v+1]<<8)):(U=c[v]<<8,v+1<K&&(U|=c[v+1])),U}function Q(c,v,O,K){K||(Y(typeof O=="boolean","missing or invalid endian"),Y(v!=null,"missing offset"),Y(v+3<c.length,"Trying to read beyond buffer length"));var U,K=c.length;if(!(K<=v))return O?(v+2<K&&(U=c[v+2]<<16),v+1<K&&(U|=c[v+1]<<8),U|=c[v],v+3<K&&(U+=c[v+3]<<24>>>0)):(v+1<K&&(U=c[v+1]<<16),v+2<K&&(U|=c[v+2]<<8),v+3<K&&(U|=c[v+3]),U+=c[v]<<24>>>0),U}function w(c,v,O,V){if(V||(Y(typeof O=="boolean","missing or invalid endian"),Y(v!=null,"missing offset"),Y(v+1<c.length,"Trying to read beyond buffer length")),!(c.length<=v))return V=P(c,v,O,!0),32768&V?-1*(65535-V+1):V}function S(c,v,O,V){if(V||(Y(typeof O=="boolean","missing or invalid endian"),Y(v!=null,"missing offset"),Y(v+3<c.length,"Trying to read beyond buffer length")),!(c.length<=v))return V=Q(c,v,O,!0),2147483648&V?-1*(4294967295-V+1):V}function p(c,v,O,V){return V||(Y(typeof O=="boolean","missing or invalid endian"),Y(v+3<c.length,"Trying to read beyond buffer length")),M.read(c,v,O,23,4)}function _(c,v,O,V){return V||(Y(typeof O=="boolean","missing or invalid endian"),Y(v+7<c.length,"Trying to read beyond buffer length")),M.read(c,v,O,52,8)}function h(c,v,O,V,U){if(U||(Y(v!=null,"missing value"),Y(typeof V=="boolean","missing or invalid endian"),Y(O!=null,"missing offset"),Y(O+1<c.length,"trying to write beyond buffer length"),Ie(v,65535)),U=c.length,!(U<=O))for(var K=0,re=Math.min(U-O,2);K<re;K++)c[O+K]=(v&255<<8*(V?K:1-K))>>>8*(V?K:1-K)}function b(c,v,O,V,U){if(U||(Y(v!=null,"missing value"),Y(typeof V=="boolean","missing or invalid endian"),Y(O!=null,"missing offset"),Y(O+3<c.length,"trying to write beyond buffer length"),Ie(v,4294967295)),U=c.length,!(U<=O))for(var K=0,re=Math.min(U-O,4);K<re;K++)c[O+K]=v>>>8*(V?K:3-K)&255}function B(c,v,O,V,U){U||(Y(v!=null,"missing value"),Y(typeof V=="boolean","missing or invalid endian"),Y(O!=null,"missing offset"),Y(O+1<c.length,"Trying to write beyond buffer length"),Ue(v,32767,-32768)),c.length<=O||h(c,0<=v?v:65535+v+1,O,V,U)}function ie(c,v,O,V,U){U||(Y(v!=null,"missing value"),Y(typeof V=="boolean","missing or invalid endian"),Y(O!=null,"missing offset"),Y(O+3<c.length,"Trying to write beyond buffer length"),Ue(v,2147483647,-2147483648)),c.length<=O||b(c,0<=v?v:4294967295+v+1,O,V,U)}function ne(c,v,O,V,U){U||(Y(v!=null,"missing value"),Y(typeof V=="boolean","missing or invalid endian"),Y(O!=null,"missing offset"),Y(O+3<c.length,"Trying to write beyond buffer length"),je(v,34028234663852886e22,-34028234663852886e22)),c.length<=O||M.write(c,v,O,V,23,4)}function F(c,v,O,V,U){U||(Y(v!=null,"missing value"),Y(typeof V=="boolean","missing or invalid endian"),Y(O!=null,"missing offset"),Y(O+7<c.length,"Trying to write beyond buffer length"),je(v,17976931348623157e292,-17976931348623157e292)),c.length<=O||M.write(c,v,O,V,52,8)}r.Buffer=A,r.SlowBuffer=A,r.INSPECT_MAX_BYTES=50,A.poolSize=8192,A._useTypedArrays=function(){try{var c=new ArrayBuffer(0),v=new Uint8Array(c);return v.foo=function(){return 42},v.foo()===42&&typeof v.subarray=="function"}catch{return!1}}(),A.isEncoding=function(c){switch(String(c).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},A.isBuffer=function(c){return!(c==null||!c._isBuffer)},A.byteLength=function(c,v){var O;switch(c+="",v||"utf8"){case"hex":O=c.length/2;break;case"utf8":case"utf-8":O=ae(c).length;break;case"ascii":case"binary":case"raw":O=c.length;break;case"base64":O=fe(c).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":O=2*c.length;break;default:throw new Error("Unknown encoding")}return O},A.concat=function(c,v){if(Y(J(c),`Usage: Buffer.concat(list, [totalLength])
list should be an Array.`),c.length===0)return new A(0);if(c.length===1)return c[0];if(typeof v!="number")for(U=v=0;U<c.length;U++)v+=c[U].length;for(var O=new A(v),V=0,U=0;U<c.length;U++){var K=c[U];K.copy(O,V),V+=K.length}return O},A.prototype.write=function(c,v,O,V){isFinite(v)?isFinite(O)||(V=O,O=void 0):(ue=V,V=v,v=O,O=ue),v=Number(v)||0;var U,K,re,ve,ue=this.length-v;switch((!O||ue<(O=Number(O)))&&(O=ue),V=String(V||"utf8").toLowerCase()){case"hex":U=function(Ve,Ae,Ce,we){Ce=Number(Ce)||0;var _e=Ve.length-Ce;(!we||_e<(we=Number(we)))&&(we=_e),Y((_e=Ae.length)%2==0,"Invalid hex string"),_e/2<we&&(we=_e/2);for(var Qe=0;Qe<we;Qe++){var nt=parseInt(Ae.substr(2*Qe,2),16);Y(!isNaN(nt),"Invalid hex string"),Ve[Ce+Qe]=nt}return A._charsWritten=2*Qe,Qe}(this,c,v,O);break;case"utf8":case"utf-8":K=this,re=v,ve=O,U=A._charsWritten=se(ae(c),K,re,ve);break;case"ascii":case"binary":U=x(this,c,v,O);break;case"base64":K=this,re=v,ve=O,U=A._charsWritten=se(fe(c),K,re,ve);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":U=R(this,c,v,O);break;default:throw new Error("Unknown encoding")}return U},A.prototype.toString=function(c,v,O){var V,U,K,re,ve=this;if(c=String(c||"utf8").toLowerCase(),v=Number(v)||0,(O=O!==void 0?Number(O):ve.length)===v)return"";switch(c){case"hex":V=function(ue,Ve,Ae){var Ce=ue.length;(!Ve||Ve<0)&&(Ve=0),(!Ae||Ae<0||Ce<Ae)&&(Ae=Ce);for(var we="",_e=Ve;_e<Ae;_e++)we+=te(ue[_e]);return we}(ve,v,O);break;case"utf8":case"utf-8":V=function(ue,Ve,Ae){var Ce="",we="";Ae=Math.min(ue.length,Ae);for(var _e=Ve;_e<Ae;_e++)ue[_e]<=127?(Ce+=me(we)+String.fromCharCode(ue[_e]),we=""):we+="%"+ue[_e].toString(16);return Ce+me(we)}(ve,v,O);break;case"ascii":case"binary":V=D(ve,v,O);break;case"base64":U=ve,re=O,V=(K=v)===0&&re===U.length?T.fromByteArray(U):T.fromByteArray(U.slice(K,re));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":V=function(ue,Ve,Ae){for(var Ce=ue.slice(Ve,Ae),we="",_e=0;_e<Ce.length;_e+=2)we+=String.fromCharCode(Ce[_e]+256*Ce[_e+1]);return we}(ve,v,O);break;default:throw new Error("Unknown encoding")}return V},A.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},A.prototype.copy=function(c,v,O,V){if(v=v||0,(V=V||V===0?V:this.length)!==(O=O||0)&&c.length!==0&&this.length!==0){Y(O<=V,"sourceEnd < sourceStart"),Y(0<=v&&v<c.length,"targetStart out of bounds"),Y(0<=O&&O<this.length,"sourceStart out of bounds"),Y(0<=V&&V<=this.length,"sourceEnd out of bounds"),V>this.length&&(V=this.length);var U=(V=c.length-v<V-O?c.length-v+O:V)-O;if(U<100||!A._useTypedArrays)for(var K=0;K<U;K++)c[K+v]=this[K+O];else c._set(this.subarray(O,O+U),v)}},A.prototype.slice=function(c,v){var O=this.length;if(c=oe(c,O,0),v=oe(v,O,O),A._useTypedArrays)return A._augment(this.subarray(c,v));for(var V=v-c,U=new A(V,void 0,!0),K=0;K<V;K++)U[K]=this[K+c];return U},A.prototype.get=function(c){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(c)},A.prototype.set=function(c,v){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(c,v)},A.prototype.readUInt8=function(c,v){if(v||(Y(c!=null,"missing offset"),Y(c<this.length,"Trying to read beyond buffer length")),!(c>=this.length))return this[c]},A.prototype.readUInt16LE=function(c,v){return P(this,c,!0,v)},A.prototype.readUInt16BE=function(c,v){return P(this,c,!1,v)},A.prototype.readUInt32LE=function(c,v){return Q(this,c,!0,v)},A.prototype.readUInt32BE=function(c,v){return Q(this,c,!1,v)},A.prototype.readInt8=function(c,v){if(v||(Y(c!=null,"missing offset"),Y(c<this.length,"Trying to read beyond buffer length")),!(c>=this.length))return 128&this[c]?-1*(255-this[c]+1):this[c]},A.prototype.readInt16LE=function(c,v){return w(this,c,!0,v)},A.prototype.readInt16BE=function(c,v){return w(this,c,!1,v)},A.prototype.readInt32LE=function(c,v){return S(this,c,!0,v)},A.prototype.readInt32BE=function(c,v){return S(this,c,!1,v)},A.prototype.readFloatLE=function(c,v){return p(this,c,!0,v)},A.prototype.readFloatBE=function(c,v){return p(this,c,!1,v)},A.prototype.readDoubleLE=function(c,v){return _(this,c,!0,v)},A.prototype.readDoubleBE=function(c,v){return _(this,c,!1,v)},A.prototype.writeUInt8=function(c,v,O){O||(Y(c!=null,"missing value"),Y(v!=null,"missing offset"),Y(v<this.length,"trying to write beyond buffer length"),Ie(c,255)),v>=this.length||(this[v]=c)},A.prototype.writeUInt16LE=function(c,v,O){h(this,c,v,!0,O)},A.prototype.writeUInt16BE=function(c,v,O){h(this,c,v,!1,O)},A.prototype.writeUInt32LE=function(c,v,O){b(this,c,v,!0,O)},A.prototype.writeUInt32BE=function(c,v,O){b(this,c,v,!1,O)},A.prototype.writeInt8=function(c,v,O){O||(Y(c!=null,"missing value"),Y(v!=null,"missing offset"),Y(v<this.length,"Trying to write beyond buffer length"),Ue(c,127,-128)),v>=this.length||(0<=c?this.writeUInt8(c,v,O):this.writeUInt8(255+c+1,v,O))},A.prototype.writeInt16LE=function(c,v,O){B(this,c,v,!0,O)},A.prototype.writeInt16BE=function(c,v,O){B(this,c,v,!1,O)},A.prototype.writeInt32LE=function(c,v,O){ie(this,c,v,!0,O)},A.prototype.writeInt32BE=function(c,v,O){ie(this,c,v,!1,O)},A.prototype.writeFloatLE=function(c,v,O){ne(this,c,v,!0,O)},A.prototype.writeFloatBE=function(c,v,O){ne(this,c,v,!1,O)},A.prototype.writeDoubleLE=function(c,v,O){F(this,c,v,!0,O)},A.prototype.writeDoubleBE=function(c,v,O){F(this,c,v,!1,O)},A.prototype.fill=function(c,v,O){if(v=v||0,O=O||this.length,Y(typeof(c=typeof(c=c||0)=="string"?c.charCodeAt(0):c)=="number"&&!isNaN(c),"value is not a number"),Y(v<=O,"end < start"),O!==v&&this.length!==0){Y(0<=v&&v<this.length,"start out of bounds"),Y(0<=O&&O<=this.length,"end out of bounds");for(var V=v;V<O;V++)this[V]=c}},A.prototype.inspect=function(){for(var c=[],v=this.length,O=0;O<v;O++)if(c[O]=te(this[O]),O===r.INSPECT_MAX_BYTES){c[O+1]="...";break}return"<Buffer "+c.join(" ")+">"},A.prototype.toArrayBuffer=function(){if(typeof Uint8Array>"u")throw new Error("Buffer.toArrayBuffer not supported in this browser");if(A._useTypedArrays)return new A(this).buffer;for(var c=new Uint8Array(this.length),v=0,O=c.length;v<O;v+=1)c[v]=this[v];return c.buffer};var H=A.prototype;function oe(c,v,O){return typeof c!="number"?O:v<=(c=~~c)?v:0<=c||0<=(c+=v)?c:0}function ge(c){return(c=~~Math.ceil(+c))<0?0:c}function J(c){return(Array.isArray||function(v){return Object.prototype.toString.call(v)==="[object Array]"})(c)}function te(c){return c<16?"0"+c.toString(16):c.toString(16)}function ae(c){for(var v=[],O=0;O<c.length;O++){var V=c.charCodeAt(O);if(V<=127)v.push(c.charCodeAt(O));else for(var U=O,K=(55296<=V&&V<=57343&&O++,encodeURIComponent(c.slice(U,O+1)).substr(1).split("%")),re=0;re<K.length;re++)v.push(parseInt(K[re],16))}return v}function fe(c){return T.toByteArray(c)}function se(c,v,O,V){for(var U=0;U<V&&!(U+O>=v.length||U>=c.length);U++)v[U+O]=c[U];return U}function me(c){try{return decodeURIComponent(c)}catch{return String.fromCharCode(65533)}}function Ie(c,v){Y(typeof c=="number","cannot write a non-number as a number"),Y(0<=c,"specified a negative value for writing an unsigned value"),Y(c<=v,"value is larger than maximum value for type"),Y(Math.floor(c)===c,"value has a fractional component")}function Ue(c,v,O){Y(typeof c=="number","cannot write a non-number as a number"),Y(c<=v,"value larger than maximum allowed value"),Y(O<=c,"value smaller than minimum allowed value"),Y(Math.floor(c)===c,"value has a fractional component")}function je(c,v,O){Y(typeof c=="number","cannot write a non-number as a number"),Y(c<=v,"value larger than maximum allowed value"),Y(O<=c,"value smaller than minimum allowed value")}function Y(c,v){if(!c)throw new Error(v||"Failed assertion")}A._augment=function(c){return c._isBuffer=!0,c._get=c.get,c._set=c.set,c.get=H.get,c.set=H.set,c.write=H.write,c.toString=H.toString,c.toLocaleString=H.toString,c.toJSON=H.toJSON,c.copy=H.copy,c.slice=H.slice,c.readUInt8=H.readUInt8,c.readUInt16LE=H.readUInt16LE,c.readUInt16BE=H.readUInt16BE,c.readUInt32LE=H.readUInt32LE,c.readUInt32BE=H.readUInt32BE,c.readInt8=H.readInt8,c.readInt16LE=H.readInt16LE,c.readInt16BE=H.readInt16BE,c.readInt32LE=H.readInt32LE,c.readInt32BE=H.readInt32BE,c.readFloatLE=H.readFloatLE,c.readFloatBE=H.readFloatBE,c.readDoubleLE=H.readDoubleLE,c.readDoubleBE=H.readDoubleBE,c.writeUInt8=H.writeUInt8,c.writeUInt16LE=H.writeUInt16LE,c.writeUInt16BE=H.writeUInt16BE,c.writeUInt32LE=H.writeUInt32LE,c.writeUInt32BE=H.writeUInt32BE,c.writeInt8=H.writeInt8,c.writeInt16LE=H.writeInt16LE,c.writeInt16BE=H.writeInt16BE,c.writeInt32LE=H.writeInt32LE,c.writeInt32BE=H.writeInt32BE,c.writeFloatLE=H.writeFloatLE,c.writeFloatBE=H.writeFloatBE,c.writeDoubleLE=H.writeDoubleLE,c.writeDoubleBE=H.writeDoubleBE,c.fill=H.fill,c.inspect=H.inspect,c.toArrayBuffer=H.toArrayBuffer,c}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:10,lYpoI2:11}],4:[function(t,i,r){(function(s,o,T,y,g,d,E,N,W){var T=t("buffer").Buffer,M=4,A=new T(M);A.fill(0),i.exports={hash:function(x,R,D,P){for(var Q=R(function(h,b){h.length%M!=0&&(B=h.length+(M-h.length%M),h=T.concat([h,A],B));for(var B,ie=[],ne=b?h.readInt32BE:h.readInt32LE,F=0;F<h.length;F+=M)ie.push(ne.call(h,F));return ie}(x=T.isBuffer(x)?x:new T(x),P),8*x.length),R=P,w=new T(D),S=R?w.writeInt32BE:w.writeInt32LE,p=0;p<Q.length;p++)S.call(w,Q[p],4*p,!0);return w}}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],5:[function(t,i,r){(function(s,o,T,y,g,d,E,N,W){var T=t("buffer").Buffer,M=t("./sha"),A=t("./sha256"),x=t("./rng"),R={sha1:M,sha256:A,md5:t("./md5")},D=64,P=new T(D);function Q(h,b){var B=R[h=h||"sha1"],ie=[];return B||w("algorithm:",h,"is not yet supported"),{update:function(ne){return T.isBuffer(ne)||(ne=new T(ne)),ie.push(ne),ne.length,this},digest:function(ne){var F=T.concat(ie),F=b?function(H,oe,ge){T.isBuffer(oe)||(oe=new T(oe)),T.isBuffer(ge)||(ge=new T(ge)),oe.length>D?oe=H(oe):oe.length<D&&(oe=T.concat([oe,P],D));for(var J=new T(D),te=new T(D),ae=0;ae<D;ae++)J[ae]=54^oe[ae],te[ae]=92^oe[ae];return ge=H(T.concat([J,ge])),H(T.concat([te,ge]))}(B,b,F):B(F);return ie=null,ne?F.toString(ne):F}}}function w(){var h=[].slice.call(arguments).join(" ");throw new Error([h,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join(`
`))}P.fill(0),r.createHash=function(h){return Q(h)},r.createHmac=Q,r.randomBytes=function(h,b){if(!b||!b.call)return new T(x(h));try{b.call(this,void 0,new T(x(h)))}catch(B){b(B)}};var S,p=["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],_=function(h){r[h]=function(){w("sorry,",h,"is not implemented yet")}};for(S in p)_(p[S])}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:11}],6:[function(t,i,r){(function(s,o,f,y,g,d,E,N,W){var T=t("./helpers");function M(w,S){w[S>>5]|=128<<S%32,w[14+(S+64>>>9<<4)]=S;for(var p=1732584193,_=-271733879,h=-1732584194,b=271733878,B=0;B<w.length;B+=16){var ie=p,ne=_,F=h,H=b,p=x(p,_,h,b,w[B+0],7,-680876936),b=x(b,p,_,h,w[B+1],12,-389564586),h=x(h,b,p,_,w[B+2],17,606105819),_=x(_,h,b,p,w[B+3],22,-1044525330);p=x(p,_,h,b,w[B+4],7,-176418897),b=x(b,p,_,h,w[B+5],12,1200080426),h=x(h,b,p,_,w[B+6],17,-1473231341),_=x(_,h,b,p,w[B+7],22,-45705983),p=x(p,_,h,b,w[B+8],7,1770035416),b=x(b,p,_,h,w[B+9],12,-1958414417),h=x(h,b,p,_,w[B+10],17,-42063),_=x(_,h,b,p,w[B+11],22,-1990404162),p=x(p,_,h,b,w[B+12],7,1804603682),b=x(b,p,_,h,w[B+13],12,-40341101),h=x(h,b,p,_,w[B+14],17,-1502002290),p=R(p,_=x(_,h,b,p,w[B+15],22,1236535329),h,b,w[B+1],5,-165796510),b=R(b,p,_,h,w[B+6],9,-1069501632),h=R(h,b,p,_,w[B+11],14,643717713),_=R(_,h,b,p,w[B+0],20,-373897302),p=R(p,_,h,b,w[B+5],5,-701558691),b=R(b,p,_,h,w[B+10],9,38016083),h=R(h,b,p,_,w[B+15],14,-660478335),_=R(_,h,b,p,w[B+4],20,-405537848),p=R(p,_,h,b,w[B+9],5,568446438),b=R(b,p,_,h,w[B+14],9,-1019803690),h=R(h,b,p,_,w[B+3],14,-187363961),_=R(_,h,b,p,w[B+8],20,1163531501),p=R(p,_,h,b,w[B+13],5,-1444681467),b=R(b,p,_,h,w[B+2],9,-51403784),h=R(h,b,p,_,w[B+7],14,1735328473),p=D(p,_=R(_,h,b,p,w[B+12],20,-1926607734),h,b,w[B+5],4,-378558),b=D(b,p,_,h,w[B+8],11,-2022574463),h=D(h,b,p,_,w[B+11],16,1839030562),_=D(_,h,b,p,w[B+14],23,-35309556),p=D(p,_,h,b,w[B+1],4,-1530992060),b=D(b,p,_,h,w[B+4],11,1272893353),h=D(h,b,p,_,w[B+7],16,-155497632),_=D(_,h,b,p,w[B+10],23,-1094730640),p=D(p,_,h,b,w[B+13],4,681279174),b=D(b,p,_,h,w[B+0],11,-358537222),h=D(h,b,p,_,w[B+3],16,-722521979),_=D(_,h,b,p,w[B+6],23,76029189),p=D(p,_,h,b,w[B+9],4,-640364487),b=D(b,p,_,h,w[B+12],11,-421815835),h=D(h,b,p,_,w[B+15],16,530742520),p=P(p,_=D(_,h,b,p,w[B+2],23,-995338651),h,b,w[B+0],6,-198630844),b=P(b,p,_,h,w[B+7],10,1126891415),h=P(h,b,p,_,w[B+14],15,-1416354905),_=P(_,h,b,p,w[B+5],21,-57434055),p=P(p,_,h,b,w[B+12],6,1700485571),b=P(b,p,_,h,w[B+3],10,-1894986606),h=P(h,b,p,_,w[B+10],15,-1051523),_=P(_,h,b,p,w[B+1],21,-2054922799),p=P(p,_,h,b,w[B+8],6,1873313359),b=P(b,p,_,h,w[B+15],10,-30611744),h=P(h,b,p,_,w[B+6],15,-1560198380),_=P(_,h,b,p,w[B+13],21,1309151649),p=P(p,_,h,b,w[B+4],6,-145523070),b=P(b,p,_,h,w[B+11],10,-1120210379),h=P(h,b,p,_,w[B+2],15,718787259),_=P(_,h,b,p,w[B+9],21,-343485551),p=Q(p,ie),_=Q(_,ne),h=Q(h,F),b=Q(b,H)}return Array(p,_,h,b)}function A(w,S,p,_,h,b){return Q((S=Q(Q(S,w),Q(_,b)))<<h|S>>>32-h,p)}function x(w,S,p,_,h,b,B){return A(S&p|~S&_,w,S,h,b,B)}function R(w,S,p,_,h,b,B){return A(S&_|p&~_,w,S,h,b,B)}function D(w,S,p,_,h,b,B){return A(S^p^_,w,S,h,b,B)}function P(w,S,p,_,h,b,B){return A(p^(S|~_),w,S,h,b,B)}function Q(w,S){var p=(65535&w)+(65535&S);return(w>>16)+(S>>16)+(p>>16)<<16|65535&p}i.exports=function(w){return T.hash(w,M,16)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],7:[function(t,i,r){(function(s,o,f,y,g,d,E,N,W){i.exports=function(T){for(var M,A=new Array(T),x=0;x<T;x++)!(3&x)&&(M=4294967296*Math.random()),A[x]=M>>>((3&x)<<3)&255;return A}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],8:[function(t,i,r){(function(s,o,f,y,g,d,E,N,W){var T=t("./helpers");function M(R,D){R[D>>5]|=128<<24-D%32,R[15+(D+64>>9<<4)]=D;for(var P,Q,w,S=Array(80),p=1732584193,_=-271733879,h=-1732584194,b=271733878,B=-1009589776,ie=0;ie<R.length;ie+=16){for(var ne=p,F=_,H=h,oe=b,ge=B,J=0;J<80;J++){S[J]=J<16?R[ie+J]:x(S[J-3]^S[J-8]^S[J-14]^S[J-16],1);var te=A(A(x(p,5),(te=_,Q=h,w=b,(P=J)<20?te&Q|~te&w:!(P<40)&&P<60?te&Q|te&w|Q&w:te^Q^w)),A(A(B,S[J]),(P=J)<20?1518500249:P<40?1859775393:P<60?-1894007588:-899497514)),B=b,b=h,h=x(_,30),_=p,p=te}p=A(p,ne),_=A(_,F),h=A(h,H),b=A(b,oe),B=A(B,ge)}return Array(p,_,h,b,B)}function A(R,D){var P=(65535&R)+(65535&D);return(R>>16)+(D>>16)+(P>>16)<<16|65535&P}function x(R,D){return R<<D|R>>>32-D}i.exports=function(R){return T.hash(R,M,20,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],9:[function(t,i,r){(function(s,o,f,y,g,d,E,N,W){function T(D,P){var Q=(65535&D)+(65535&P);return(D>>16)+(P>>16)+(Q>>16)<<16|65535&Q}function M(D,P){var Q,w=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),S=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),p=new Array(64);D[P>>5]|=128<<24-P%32,D[15+(P+64>>9<<4)]=P;for(var _,h,b=0;b<D.length;b+=16){for(var B=S[0],ie=S[1],ne=S[2],F=S[3],H=S[4],oe=S[5],ge=S[6],J=S[7],te=0;te<64;te++)p[te]=te<16?D[te+b]:T(T(T((h=p[te-2],x(h,17)^x(h,19)^R(h,10)),p[te-7]),(h=p[te-15],x(h,7)^x(h,18)^R(h,3))),p[te-16]),Q=T(T(T(T(J,x(h=H,6)^x(h,11)^x(h,25)),H&oe^~H&ge),w[te]),p[te]),_=T(x(_=B,2)^x(_,13)^x(_,22),B&ie^B&ne^ie&ne),J=ge,ge=oe,oe=H,H=T(F,Q),F=ne,ne=ie,ie=B,B=T(Q,_);S[0]=T(B,S[0]),S[1]=T(ie,S[1]),S[2]=T(ne,S[2]),S[3]=T(F,S[3]),S[4]=T(H,S[4]),S[5]=T(oe,S[5]),S[6]=T(ge,S[6]),S[7]=T(J,S[7])}return S}var A=t("./helpers"),x=function(D,P){return D>>>P|D<<32-P},R=function(D,P){return D>>>P};i.exports=function(D){return A.hash(D,M,32,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],10:[function(t,i,r){(function(s,o,f,y,g,d,E,N,W){r.read=function(T,M,A,x,b){var D,P,Q=8*b-x-1,w=(1<<Q)-1,S=w>>1,p=-7,_=A?b-1:0,h=A?-1:1,b=T[M+_];for(_+=h,D=b&(1<<-p)-1,b>>=-p,p+=Q;0<p;D=256*D+T[M+_],_+=h,p-=8);for(P=D&(1<<-p)-1,D>>=-p,p+=x;0<p;P=256*P+T[M+_],_+=h,p-=8);if(D===0)D=1-S;else{if(D===w)return P?NaN:1/0*(b?-1:1);P+=Math.pow(2,x),D-=S}return(b?-1:1)*P*Math.pow(2,D-x)},r.write=function(T,M,A,x,R,B){var P,Q,w=8*B-R-1,S=(1<<w)-1,p=S>>1,_=R===23?Math.pow(2,-24)-Math.pow(2,-77):0,h=x?0:B-1,b=x?1:-1,B=M<0||M===0&&1/M<0?1:0;for(M=Math.abs(M),isNaN(M)||M===1/0?(Q=isNaN(M)?1:0,P=S):(P=Math.floor(Math.log(M)/Math.LN2),M*(x=Math.pow(2,-P))<1&&(P--,x*=2),2<=(M+=1<=P+p?_/x:_*Math.pow(2,1-p))*x&&(P++,x/=2),S<=P+p?(Q=0,P=S):1<=P+p?(Q=(M*x-1)*Math.pow(2,R),P+=p):(Q=M*Math.pow(2,p-1)*Math.pow(2,R),P=0));8<=R;T[A+h]=255&Q,h+=b,Q/=256,R-=8);for(P=P<<R|Q,w+=R;0<w;T[A+h]=255&P,h+=b,P/=256,w-=8);T[A+h-b]|=128*B}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/ieee754/index.js","/node_modules/gulp-browserify/node_modules/ieee754")},{buffer:3,lYpoI2:11}],11:[function(t,i,r){(function(s,o,f,y,g,d,E,N,W){var T,M,A;function x(){}(s=i.exports={}).nextTick=(M=typeof window<"u"&&window.setImmediate,A=typeof window<"u"&&window.postMessage&&window.addEventListener,M?function(R){return window.setImmediate(R)}:A?(T=[],window.addEventListener("message",function(R){var D=R.source;D!==window&&D!==null||R.data!=="process-tick"||(R.stopPropagation(),0<T.length&&T.shift()())},!0),function(R){T.push(R),window.postMessage("process-tick","*")}):function(R){setTimeout(R,0)}),s.title="browser",s.browser=!0,s.env={},s.argv=[],s.on=x,s.addListener=x,s.once=x,s.off=x,s.removeListener=x,s.removeAllListeners=x,s.emit=x,s.binding=function(R){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(R){throw new Error("process.chdir is not supported")}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:11}]},{},[1])(1)})})(rr);var ga=rr.exports;const rn=Ls(ga);class ma{cache;useHash;constructor(e){this.cache={},this.useHash=e}cacheValue(e,t){this.cache[this.useHash?rn(e):String(e)]=t}deleteValue(e){delete this.cache[this.useHash?rn(e):String(e)]}getValue(e){return this.cache[this.useHash?rn(e):String(e)]}isCached(e){return(this.useHash?rn(e):String(e))in this.cache}invalidate(e){e&&Object.entries(this.cache).forEach(([t,i])=>e(t,i)),this.cache={}}}function on(n,e){return(n.x-e.x)*(n.x-e.x)+(n.y-e.y)*(n.y-e.y)}function Es(n,e){return n.x==e.x&&n.y==e.y}function an(n,e,t){return t===void 0&&(t=.01),Math.abs(n-e)<=t}function li(n,e){return(n%e+e)%e}async function ya(){await q.contextMenu.create({id:`${L.EXTENSIONID}/toggle-vision-menu`,icons:[{icon:"/no-vision.svg",label:"Enable Vision",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${L.EXTENSIONID}/hasVision`],value:void 0}]}},{icon:"/icon.svg",label:"Disable Vision",filter:{every:[{key:"layer",value:"CHARACTER"}]}}],async onClick(n){await q.scene.items.updateItems(n.items,e=>{for(const t of e)t.metadata[`${L.EXTENSIONID}/hasVision`]&&t.layer=="CHARACTER"?delete t.metadata[`${L.EXTENSIONID}/hasVision`]:t.layer=="CHARACTER"&&(t.metadata[`${L.EXTENSIONID}/hasVision`]=!0,t.metadata[`${L.EXTENSIONID}/visionRange`]||(t.metadata[`${L.EXTENSIONID}/visionRange`]=L.VISIONDEFAULT))})}}),await q.contextMenu.create({id:`${L.EXTENSIONID}/toggle-vision-line`,icons:[{icon:"/icon.svg",label:"Disable Vision Line",filter:{some:[{key:["metadata",`${L.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${L.EXTENSIONID}/disabled`],value:void 0,coordinator:"||"},{key:["metadata",`${L.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${L.ARMINDOID}/disabled`],value:void 0}]}},{icon:"/no-vision.svg",label:"Enable Vision Line",filter:{every:[{key:["metadata",`${L.EXTENSIONID}/isVisionLine`],value:!0}]}}],async onClick(n){await q.scene.items.updateItems(n.items,e=>{for(const t of e)t.metadata[`${L.EXTENSIONID}/isVisionLine`]&&t.metadata[`${L.EXTENSIONID}/disabled`]?delete t.metadata[`${L.EXTENSIONID}/disabled`]:t.metadata[`${L.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${L.EXTENSIONID}/disabled`]=!0)})}}),await q.contextMenu.create({id:`${L.EXTENSIONID}/switch-one-sided-type`,icons:[{icon:"/two-sided.svg",label:"Two-sided",filter:{some:[{key:["metadata",`${L.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${L.EXTENSIONID}/oneSided`],value:void 0,coordinator:"||"},{key:["metadata",`${L.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${L.ARMINDOID}/oneSided`],value:void 0}]}},{icon:"/left-sided.svg",label:"One-sided left",filter:{some:[{key:["metadata",`${L.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${L.EXTENSIONID}/oneSided`],value:"left",coordinator:"||"},{key:["metadata",`${L.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${L.ARMINDOID}/oneSided`],value:"left"}]}},{icon:"/right-sided.svg",label:"One-sided right",filter:{some:[{key:["metadata",`${L.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${L.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(n){await q.scene.items.updateItems(n.items,e=>{for(const t of e)(t.metadata[`${L.EXTENSIONID}/isVisionLine`]||t.metadata[`${L.ARMINDOID}/isVisionLine`])&&(t.metadata[`${L.EXTENSIONID}/oneSided`]=="right"||t.metadata[`${L.ARMINDOID}/oneSided`]=="right")?(delete t.metadata[`${L.EXTENSIONID}/oneSided`],delete t.metadata[`${L.ARMINDOID}/oneSided`]):(t.metadata[`${L.EXTENSIONID}/isVisionLine`]||t.metadata[`${L.ARMINDOID}/isVisionLine`])&&(t.metadata[`${L.EXTENSIONID}/oneSided`]=="left"||t.metadata[`${L.ARMINDOID}/oneSided`]=="left")?(t.metadata[`${L.EXTENSIONID}/oneSided`]="right",t.metadata[`${L.ARMINDOID}/oneSided`]="right"):(t.metadata[`${L.EXTENSIONID}/isVisionLine`]||t.metadata[`${L.ARMINDOID}/isVisionLine`])&&(t.metadata[`${L.EXTENSIONID}/oneSided`]="left",t.metadata[`${L.ARMINDOID}/oneSided`]="left")})}})}async function va(){await q.tool.create({id:`${L.EXTENSIONID}/vision-tool`,icons:[{icon:"/icon.svg",label:"Setup Vision"}],async onClick(){await q.tool.activateTool(`${L.EXTENSIONID}/vision-tool`)}})}async function _a(){await q.tool.createMode({id:`${L.EXTENSIONID}/add-vision-polygon-mode`,icons:[{icon:"/object.svg",label:"Add Obstruction Object",filter:{activeTools:[`${L.EXTENSIONID}/vision-tool`]}}],onToolClick:oi.onToolClick,onToolMove:oi.onToolMove,onKeyDown:oi.onKeyDown}),await q.tool.createMode({id:`${L.EXTENSIONID}/add-vision-line-mode`,icons:[{icon:"/line.svg",label:"Add Obstruction Line",filter:{activeTools:[`${L.EXTENSIONID}/vision-tool`]}}],onToolClick:ai.onToolClick,onToolMove:ai.onToolMove,onKeyDown:ai.onKeyDown})}function Ea(n){for(const[e,t]of Object.entries(n)){const i=document.getElementById(e);i&&(i.innerText=t)}}var Ze,mt=!1;const At=new ma(!1);async function Oa(n){if(mt=!0,Ze||(Ze=await aa({locateFile:()=>la})),!await q.scene.isReady()){At.invalidate((F,H)=>H.shadowPath.delete()),mt=!1;return}const e=await q.scene.local.getItems(),{awaitTimer:t,computeTimer:i,metadata:r,size:s,offset:o,scale:f,visionShapes:y,tokensWithVision:g,invalidateCache:d}=n.detail,[E,N]=s;let W=0,T=0;if(d&&At.invalidate((F,H)=>H.shadowPath.delete()),i.resume(),!(r[`${L.EXTENSIONID}/visionEnabled`]===!0)||g.length==0){await q.scene.local.deleteItems(e.filter(wi).map(F=>F.id)),mt=!1;return}const A=[];for(const F of y)for(let H=0;H<F.points.length-1;H++)A.push({startPosition:{x:F.points[H].x*F.scale.x+F.position.x,y:F.points[H].y*F.scale.y+F.position.y},endPosition:{x:F.points[H+1].x*F.scale.x+F.position.x,y:F.points[H+1].y*F.scale.y+F.position.y},originalShape:F,oneSided:F.metadata[`${L.EXTENSIONID}/oneSided`]});const x=[],R=[],D=Z.players.filter(F=>F.role=="GM");for(const F of g){const H=Z.userId===F.createdUserId,oe=D.some(J=>J.id==F.createdUserId);if(!H&&Z.role!=="GM"&&!oe)continue;const ge=At.getValue(F.id);if(x.push([]),!(ge!==void 0&&Es(ge.player.position,F.position)))for(const J of A){const te=(F.position.x-J.startPosition.x)*(J.endPosition.y-J.startPosition.y)-(F.position.y-J.startPosition.y)*(J.endPosition.x-J.startPosition.x);if(J.oneSided!==void 0&&(J.oneSided=="right"&&te>0||J.oneSided=="left"&&te<0))continue;const ae={x:J.startPosition.x-F.position.x,y:J.startPosition.y-F.position.y},fe={x:J.endPosition.x-F.position.x,y:J.endPosition.y-F.position.y};var P={x:0,y:0},Q={x:0,y:0},w=0,S=0,p=0,_=0;//! This is probably not required if we later compute the intersection
//! (using PathKit) of these polygons with a base rectangle the size of
//! our background image
ae.x<0?w=o[0]*f[0]:w=(E+o[0])*f[0],ae.y<0?S=o[1]*f[1]:S=(N+o[1])*f[1],fe.x<0?p=o[0]*f[0]:p=(E+o[0])*f[0],fe.y<0?_=o[1]*f[1]:_=(N+o[1])*f[1];const se=[],me=[];if(ae.x!=0){const O=ae.y/ae.x,V=J.startPosition.y-O*J.startPosition.x;se.push({x:w,y:O*w+V})}if(ae.y!=0){const O=ae.x/ae.y,V=O*J.startPosition.y-J.startPosition.x;se.push({x:O*S-V,y:S})}if(fe.x!=0){const O=fe.y/fe.x,V=J.endPosition.y-O*J.endPosition.x;me.push({x:p,y:O*p+V})}if(fe.y!=0){const O=fe.x/fe.y,V=O*J.endPosition.y-J.endPosition.x;me.push({x:O*_-V,y:_})}se.length==1||on(se[0],J.startPosition)<on(se[1],J.startPosition)?P=se[0]:P=se[1],me.length==1||on(me[0],J.endPosition)<on(me[1],J.endPosition)?Q=me[0]:Q=me[1];const Ie=[{x:J.startPosition.x,y:J.startPosition.y},P,Q,{x:J.endPosition.x,y:J.endPosition.y}],Ue=[{x:(E+o[0])*f[0],y:o[1]*f[1]},{x:(E+o[0])*f[0],y:(N+o[1])*f[1]},{x:o[0]*f[0],y:(N+o[1])*f[1]},{x:o[0]*f[0],y:o[1]*f[1]}],je=[0,0];let Y=0;for(const O of[P,Q])an(O.y,o[1]*f[1])?je[Y]=0:an(O.y,(N+o[1])*f[1])?je[Y]=2:an(O.x,o[0]*f[0])?je[Y]=3:an(O.x,(E+o[0])*f[0])&&(je[Y]=1),Y++;let c=Math.sign(te);c=c==0?1:-c;const v=c==1?je[1]:li(je[1]-1,4);for(let O=je[0]+(c==1?0:-1);li(O,4)!=v;O+=c)Ie.splice(Ie.length-2,0,Ue[li(O,4)]);x[x.length-1].push({pointset:Ie,fromShape:J.originalShape})}}if(x.length==0){mt=!1;return}const h={};for(let F=0;F<x.length;F++){const H=g[F];let oe=At.getValue(H.id);if(oe!==void 0&&Es(oe.player.position,H.position)){h[F]=oe.shadowPath.copy(),W++;continue}T++;const ge=x[F],J=new Ze.SkOpBuilder,te=Ze.NewPath().rect(o[0],o[1],s[0],s[1]);J.add(te,Ze.PathOp.UNION),te.delete();for(const fe of ge){const se=fe.fromShape,me=Ze.NewPath();me.moveTo(fe.pointset[0].x,fe.pointset[0].y);for(let Ie=1;Ie<fe.pointset.length;Ie++)me.lineTo(fe.pointset[Ie].x,fe.pointset[Ie].y);if(se.style.closed!=!1){const Ie=Ze.NewPath();Ie.moveTo(se.points[0].x*se.scale.x+se.position.x,se.points[0].y*se.scale.y+se.position.y);for(let Ue=1;Ue<se.points.length-1;Ue++)Ie.lineTo(se.points[Ue].x*se.scale.x+se.position.x,se.points[Ue].y*se.scale.y+se.position.y);me.op(Ie,Ze.PathOp.DIFFERENCE),Ie.delete()}J.add(me,Ze.PathOp.DIFFERENCE),me.delete()}const ae=J.resolve();if(!ae){console.error("Couldn't compute fog");return}if(J.delete(),ae!==void 0){ae.simplify(),h[F]=ae;let fe=At.getValue(H.id);fe!==void 0&&fe.shadowPath.delete(),At.cacheValue(H.id,{shadowPath:ae.copy(),player:H})}}for(let F=0;F<g.length;F++){const H=g[F],oe=H.metadata[`${L.EXTENSIONID}/visionRange`],ge=Z.userId===g[F].createdUserId,J=D.some(te=>te.id==g[F].createdUserId);if(oe){if(!ge&&Z.role!=="GM"&&!J)continue;const te=Z.gridDpi*(oe/Z.gridScale+.5),ae=Ze.NewPath().ellipse(H.position.x,H.position.y,te,te,0,0,2*Math.PI);h[F].op(ae,Ze.PathOp.INTERSECT),ae.delete();const fe=Z.players.find(se=>se.id===H.createdUserId);if(fe&&Z.role==="GM"){const se=Rt().strokeColor(fe.color).fillOpacity(0).position({x:H.position.x,y:H.position.y}).width(te*2).height(te*2).shapeType("CIRCLE").metadata({[`${L.EXTENSIONID}/isIndicatorRing`]:!0}).build();R.push(se)}}}const b=[];for(const F of Object.values(h))b.push({cmds:F.toCmds(),visible:!1,zIndex:3}),F.delete();i.pause(),t.resume();const B=[q.scene.local.deleteItems(e.filter(ta).map(F=>F.id)),q.scene.local.addItems(b.map(F=>{const H=Qo().commands(F.cmds).locked(!0).visible(F.visible).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${L.EXTENSIONID}/isVisionFog`]:!0}).build();return H.zIndex=F.zIndex,H})),q.scene.local.deleteItems(e.filter(wi).map(F=>F.id))];R.length>0&&B.push(q.scene.local.addItems(R)),Z.fog.filled||B.push(q.scene.fog.setFilled(!0)),await Promise.all(B);const[ie,ne]=[t.stop(),i.stop()];Ea({compute_time:`${ne} ms`,communication_time:`${ie} ms`,cache_hits:W,cache_misses:T}),mt=!1}document.addEventListener("updateVision",Oa);let ui,Os,Dt=[],ws,ci;async function Lt(){if(mt||!await q.scene.isReady())return;const[n,e]=[new _s,new _s];n.start(),n.pause(),e.start();const t=Z.players.filter(A=>A.role=="GM"),i=Z.items.filter(A=>A.layer=="CHARACTER"&&t.some(x=>A.createdUserId===x.id)&&(A.metadata[`${L.EXTENSIONID}/hasVision`]||A.metadata[`${L.ARMINDOID}/hasVision`])),r=Z.role=="GM"?Z.items.filter(qs):Z.items.filter(ia).concat(i),s=Z.items.filter(na),o=Z.items.filter(Zs)?.[0],f=Z.metadata[`${L.EXTENSIONID}/visionEnabled`]===!0;if(o===void 0)return;const y=[o.width*o.scale.x,o.height*o.scale.y],g=[o.scale.x,o.scale.y],d=[o.position.x,o.position.y];if(Z.role=="GM"){const A=document.getElementById("mapHeight"),x=document.getElementById("mapWidth");x.value=(Math.round(y[0])/Z.gridDpi).toString(),A.value=(Math.round(y[1])/Z.gridDpi).toString()}const E=JSON.stringify(s),N=JSON.stringify(r),W=JSON.stringify(o);if(W==ci&&f==ws&&ui==E&&Os==N&&y[0]==Dt[0]&&y[1]==Dt[1])return;let T=!1;(W!=ci||ui!=E||y[0]!=Dt[0]||y[1]!=Dt[1])&&(T=!0),ci=W,Os=N,ui=E,Dt=y,ws=f,e.pause();const M=new CustomEvent("updateVision",{detail:{awaitTimer:n,computeTimer:e,allItems:Z.items,metadata:Z.metadata,size:y,offset:d,scale:g,tokensWithVision:r,visionShapes:s,invalidateCache:T}});mt||document.dispatchEvent(M)}function di(n,e){n.split(/\s+/).forEach(t=>{e(t)})}class wa{constructor(){this._events=void 0,this._events={}}on(e,t){di(e,i=>{const r=this._events[i]||[];r.push(t),this._events[i]=r})}off(e,t){var i=arguments.length;if(i===0){this._events={};return}di(e,r=>{if(i===1){delete this._events[r];return}const s=this._events[r];s!==void 0&&(s.splice(s.indexOf(t),1),this._events[r]=s)})}trigger(e,...t){var i=this;di(e,r=>{const s=i._events[r];s!==void 0&&s.forEach(o=>{o.apply(i,t)})})}}function Ia(n){return n.plugins={},class extends n{constructor(...e){super(...e),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(e,t){n.plugins[e]={name:e,fn:t}}initializePlugins(e){var t,i;const r=this,s=[];if(Array.isArray(e))e.forEach(o=>{typeof o=="string"?s.push(o):(r.plugins.settings[o.name]=o.options,s.push(o.name))});else if(e)for(t in e)e.hasOwnProperty(t)&&(r.plugins.settings[t]=e[t],s.push(t));for(;i=s.shift();)r.require(i)}loadPlugin(e){var t=this,i=t.plugins,r=n.plugins[e];if(!n.plugins.hasOwnProperty(e))throw new Error('Unable to find "'+e+'" plugin');i.requested[e]=!0,i.loaded[e]=r.fn.apply(t,[t.plugins.settings[e]||{}]),i.names.push(e)}require(e){var t=this,i=t.plugins;if(!t.plugins.loaded.hasOwnProperty(e)){if(i.requested[e])throw new Error('Plugin has circular dependency ("'+e+'")');t.loadPlugin(e)}return i.loaded[e]}}}/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const Dn=n=>(n=n.filter(Boolean),n.length<2?n[0]||"":Aa(n)==1?"["+n.join("")+"]":"(?:"+n.join("|")+")"),or=n=>{if(!Ta(n))return n.join("");let e="",t=0;const i=()=>{t>1&&(e+="{"+t+"}")};return n.forEach((r,s)=>{if(r===n[s-1]){t++;return}i(),e+=r,t=1}),i(),e},ar=n=>{let e=Pi(n);return Dn(e)},Ta=n=>new Set(n).size!==n.length,Gt=n=>(n+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),Aa=n=>n.reduce((e,t)=>Math.max(e,ba(t)),0),ba=n=>Pi(n).length,Pi=n=>Array.from(n);/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const lr=n=>{if(n.length===1)return[[n]];let e=[];const t=n.substring(1);return lr(t).forEach(function(r){let s=r.slice(0);s[0]=n.charAt(0)+s[0],e.push(s),s=r.slice(0),s.unshift(n.charAt(0)),e.push(s)}),e};/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const Sa=[[0,65535]],Ca="[̀-ͯ·ʾʼ]";let bn,ur;const Ra=3,Mi={},Is={"/":"⁄∕",0:"߀",a:"ⱥɐɑ",aa:"ꜳ",ae:"æǽǣ",ao:"ꜵ",au:"ꜷ",av:"ꜹꜻ",ay:"ꜽ",b:"ƀɓƃ",c:"ꜿƈȼↄ",d:"đɗɖᴅƌꮷԁɦ",e:"ɛǝᴇɇ",f:"ꝼƒ",g:"ǥɠꞡᵹꝿɢ",h:"ħⱨⱶɥ",i:"ɨı",j:"ɉȷ",k:"ƙⱪꝁꝃꝅꞣ",l:"łƚɫⱡꝉꝇꞁɭ",m:"ɱɯϻ",n:"ꞥƞɲꞑᴎлԉ",o:"øǿɔɵꝋꝍᴑ",oe:"œ",oi:"ƣ",oo:"ꝏ",ou:"ȣ",p:"ƥᵽꝑꝓꝕρ",q:"ꝗꝙɋ",r:"ɍɽꝛꞧꞃ",s:"ßȿꞩꞅʂ",t:"ŧƭʈⱦꞇ",th:"þ",tz:"ꜩ",u:"ʉ",v:"ʋꝟʌ",vy:"ꝡ",w:"ⱳ",y:"ƴɏỿ",z:"ƶȥɀⱬꝣ",hv:"ƕ"};for(let n in Is){let e=Is[n]||"";for(let t=0;t<e.length;t++){let i=e.substring(t,t+1);Mi[i]=n}}const Ba=new RegExp(Object.keys(Mi).join("|")+"|"+Ca,"gu"),Na=n=>{bn===void 0&&(bn=La(n||Sa))},Ts=(n,e="NFKD")=>n.normalize(e),Sn=n=>Pi(n).reduce((e,t)=>e+xa(t),""),xa=n=>(n=Ts(n).toLowerCase().replace(Ba,e=>Mi[e]||""),Ts(n,"NFC"));function*ka(n){for(const[e,t]of n)for(let i=e;i<=t;i++){let r=String.fromCharCode(i),s=Sn(r);s!=r.toLowerCase()&&(s.length>Ra||s.length!=0&&(yield{folded:s,composed:r,code_point:i}))}}const Da=n=>{const e={},t=(i,r)=>{const s=e[i]||new Set,o=new RegExp("^"+ar(s)+"$","iu");r.match(o)||(s.add(Gt(r)),e[i]=s)};for(let i of ka(n))t(i.folded,i.folded),t(i.folded,i.composed);return e},La=n=>{const e=Da(n),t={};let i=[];for(let s in e){let o=e[s];o&&(t[s]=ar(o)),s.length>1&&i.push(Gt(s))}i.sort((s,o)=>o.length-s.length);const r=Dn(i);return ur=new RegExp("^"+r,"u"),t},Pa=(n,e=1)=>{let t=0;return n=n.map(i=>(bn[i]&&(t+=i.length),bn[i]||i)),t>=e?or(n):""},Ma=(n,e=1)=>(e=Math.max(e,n.length-1),Dn(lr(n).map(t=>Pa(t,e)))),As=(n,e=!0)=>{let t=n.length>1?1:0;return Dn(n.map(i=>{let r=[];const s=e?i.length():i.length()-1;for(let o=0;o<s;o++)r.push(Ma(i.substrs[o]||"",t));return or(r)}))},$a=(n,e)=>{for(const t of e){if(t.start!=n.start||t.end!=n.end||t.substrs.join("")!==n.substrs.join(""))continue;let i=n.parts;const r=o=>{for(const f of i){if(f.start===o.start&&f.substr===o.substr)return!1;if(!(o.length==1||f.length==1)&&(o.start<f.start&&o.end>f.start||f.start<o.start&&f.end>o.start))return!0}return!1};if(!(t.parts.filter(r).length>0))return!0}return!1};class Cn{constructor(){this.parts=[],this.substrs=[],this.start=0,this.end=0}add(e){e&&(this.parts.push(e),this.substrs.push(e.substr),this.start=Math.min(e.start,this.start),this.end=Math.max(e.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(e,t){let i=new Cn,r=JSON.parse(JSON.stringify(this.parts)),s=r.pop();for(const y of r)i.add(y);let o=t.substr.substring(0,e-s.start),f=o.length;return i.add({start:s.start,end:s.start+f,length:f,substr:o}),i}}const Fa=n=>{Na(),n=Sn(n);let e="",t=[new Cn];for(let i=0;i<n.length;i++){let s=n.substring(i).match(ur);const o=n.substring(i,i+1),f=s?s[0]:null;let y=[],g=new Set;for(const d of t){const E=d.last();if(!E||E.length==1||E.end<=i)if(f){const N=f.length;d.add({start:i,end:i+N,length:N,substr:f}),g.add("1")}else d.add({start:i,end:i+1,length:1,substr:o}),g.add("2");else if(f){let N=d.clone(i,E);const W=f.length;N.add({start:i,end:i+W,length:W,substr:f}),y.push(N)}else g.add("3")}if(y.length>0){y=y.sort((d,E)=>d.length()-E.length());for(let d of y)$a(d,t)||t.push(d);continue}if(i>0&&g.size==1&&!g.has("3")){e+=As(t,!1);let d=new Cn;const E=t[0];E&&d.add(E.last()),t=[d]}}return e+=As(t,!0),e};/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */const Va=(n,e)=>{if(n)return n[e]},Ua=(n,e)=>{if(n){for(var t,i=e.split(".");(t=i.shift())&&(n=n[t]););return n}},fi=(n,e,t)=>{var i,r;return!n||(n=n+"",e.regex==null)||(r=n.search(e.regex),r===-1)?0:(i=e.string.length/n.length,r===0&&(i+=.5),i*t)},hi=(n,e)=>{var t=n[e];if(typeof t=="function")return t;t&&!Array.isArray(t)&&(n[e]=[t])},$e=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},ja=(n,e)=>typeof n=="number"&&typeof e=="number"?n>e?1:n<e?-1:0:(n=Sn(n+"").toLowerCase(),e=Sn(e+"").toLowerCase(),n>e?1:e>n?-1:0);/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */class Ga{constructor(e,t){this.items=void 0,this.settings=void 0,this.items=e,this.settings=t||{diacritics:!0}}tokenize(e,t,i){if(!e||!e.length)return[];const r=[],s=e.split(/\s+/);var o;return i&&(o=new RegExp("^("+Object.keys(i).map(Gt).join("|")+"):(.*)$")),s.forEach(f=>{let y,g=null,d=null;o&&(y=f.match(o))&&(g=y[1],f=y[2]),f.length>0&&(this.settings.diacritics?d=Fa(f)||null:d=Gt(f),d&&t&&(d="\\b"+d)),r.push({string:f,regex:d?new RegExp(d,"iu"):null,field:g})}),r}getScoreFunction(e,t){var i=this.prepareSearch(e,t);return this._getScoreFunction(i)}_getScoreFunction(e){const t=e.tokens,i=t.length;if(!i)return function(){return 0};const r=e.options.fields,s=e.weights,o=r.length,f=e.getAttrFn;if(!o)return function(){return 1};const y=function(){return o===1?function(g,d){const E=r[0].field;return fi(f(d,E),g,s[E]||1)}:function(g,d){var E=0;if(g.field){const N=f(d,g.field);!g.regex&&N?E+=1/o:E+=fi(N,g,1)}else $e(s,(N,W)=>{E+=fi(f(d,W),g,N)});return E/o}}();return i===1?function(g){return y(t[0],g)}:e.options.conjunction==="and"?function(g){var d,E=0;for(let N of t){if(d=y(N,g),d<=0)return 0;E+=d}return E/i}:function(g){var d=0;return $e(t,E=>{d+=y(E,g)}),d/i}}getSortFunction(e,t){var i=this.prepareSearch(e,t);return this._getSortFunction(i)}_getSortFunction(e){var t,i=[];const r=this,s=e.options,o=!e.query&&s.sort_empty?s.sort_empty:s.sort;if(typeof o=="function")return o.bind(this);const f=function(d,E){return d==="$score"?E.score:e.getAttrFn(r.items[E.id],d)};if(o)for(let g of o)(e.query||g.field!=="$score")&&i.push(g);if(e.query){t=!0;for(let g of i)if(g.field==="$score"){t=!1;break}t&&i.unshift({field:"$score",direction:"desc"})}else i=i.filter(g=>g.field!=="$score");return i.length?function(g,d){var E,N;for(let W of i)if(N=W.field,E=(W.direction==="desc"?-1:1)*ja(f(N,g),f(N,d)),E)return E;return 0}:null}prepareSearch(e,t){const i={};var r=Object.assign({},t);if(hi(r,"sort"),hi(r,"sort_empty"),r.fields){hi(r,"fields");const s=[];r.fields.forEach(o=>{typeof o=="string"&&(o={field:o,weight:1}),s.push(o),i[o.field]="weight"in o?o.weight:1}),r.fields=s}return{options:r,query:e.toLowerCase().trim(),tokens:this.tokenize(e,r.respect_word_boundaries,i),total:0,items:[],weights:i,getAttrFn:r.nesting?Ua:Va}}search(e,t){var i=this,r,s;s=this.prepareSearch(e,t),t=s.options,e=s.query;const o=t.score||i._getScoreFunction(s);e.length?$e(i.items,(y,g)=>{r=o(y),(t.filter===!1||r>0)&&s.items.push({score:r,id:g})}):$e(i.items,(y,g)=>{s.items.push({score:1,id:g})});const f=i._getSortFunction(s);return f&&s.items.sort(f),s.total=s.items.length,typeof t.limit=="number"&&(s.items=s.items.slice(0,t.limit)),s}}const bt=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},Se=n=>{if(n.jquery)return n[0];if(n instanceof HTMLElement)return n;if(cr(n)){var e=document.createElement("template");return e.innerHTML=n.trim(),e.content.firstChild}return document.querySelector(n)},cr=n=>typeof n=="string"&&n.indexOf("<")>-1,Ha=n=>n.replace(/['"\\]/g,"\\$&"),pi=(n,e)=>{var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!1),n.dispatchEvent(t)},ln=(n,e)=>{Object.assign(n.style,e)},Me=(n,...e)=>{var t=dr(e);n=fr(n),n.map(i=>{t.map(r=>{i.classList.add(r)})})},ot=(n,...e)=>{var t=dr(e);n=fr(n),n.map(i=>{t.map(r=>{i.classList.remove(r)})})},dr=n=>{var e=[];return bt(n,t=>{typeof t=="string"&&(t=t.trim().split(/[\11\12\14\15\40]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},fr=n=>(Array.isArray(n)||(n=[n]),n),fn=(n,e,t)=>{if(!(t&&!t.contains(n)))for(;n&&n.matches;){if(n.matches(e))return n;n=n.parentNode}},bs=(n,e=0)=>e>0?n[n.length-1]:n[0],Wa=n=>Object.keys(n).length===0,Rn=(n,e)=>{if(!n)return-1;e=e||n.nodeName;for(var t=0;n=n.previousElementSibling;)n.matches(e)&&t++;return t},Ee=(n,e)=>{bt(e,(t,i)=>{t==null?n.removeAttribute(i):n.setAttribute(i,""+t)})},Ii=(n,e)=>{n.parentNode&&n.parentNode.replaceChild(e,n)},Ya=(n,e)=>{if(e===null)return;if(typeof e=="string"){if(!e.length)return;e=new RegExp(e,"i")}const t=s=>{var o=s.data.match(e);if(o&&s.data.length>0){var f=document.createElement("span");f.className="highlight";var y=s.splitText(o.index);y.splitText(o[0].length);var g=y.cloneNode(!0);return f.appendChild(g),Ii(y,f),1}return 0},i=s=>{s.nodeType===1&&s.childNodes&&!/(script|style)/i.test(s.tagName)&&(s.className!=="highlight"||s.tagName!=="SPAN")&&Array.from(s.childNodes).forEach(o=>{r(o)})},r=s=>s.nodeType===3?t(s):(i(s),0);r(n)},Xa=n=>{var e=n.querySelectorAll("span.highlight");Array.prototype.forEach.call(e,function(t){var i=t.parentNode;i.replaceChild(t.firstChild,t),i.normalize()})},Ka=65,za=13,hr=27,Ti=37,qa=38,pr=39,Za=40,Ss=8,Qa=46,Ai=9,Ja=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),un=Ja?"metaKey":"ctrlKey";var Cs={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(n){return n.length>0},render:{}};const Ye=n=>typeof n>"u"||n===null?null:hn(n),hn=n=>typeof n=="boolean"?n?"1":"0":n+"",pn=n=>(n+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),el=(n,e)=>{var t;return function(i,r){var s=this;t&&(s.loading=Math.max(s.loading-1,0),clearTimeout(t)),t=setTimeout(function(){t=null,s.loadedSearches[i]=!0,n.call(s,i,r)},e)}},Rs=(n,e,t)=>{var i,r=n.trigger,s={};n.trigger=function(){var o=arguments[0];if(e.indexOf(o)!==-1)s[o]=arguments;else return r.apply(n,arguments)},t.apply(n,[]),n.trigger=r;for(i of e)i in s&&r.apply(n,s[i])},tl=n=>({start:n.selectionStart||0,length:(n.selectionEnd||0)-(n.selectionStart||0)}),he=(n,e=!1)=>{n&&(n.preventDefault(),e&&n.stopPropagation())},Oe=(n,e,t,i)=>{n.addEventListener(e,t,i)},ht=(n,e)=>{if(!e||!e[n])return!1;var t=(e.altKey?1:0)+(e.ctrlKey?1:0)+(e.shiftKey?1:0)+(e.metaKey?1:0);return t===1},gi=(n,e)=>{const t=n.getAttribute("id");return t||(n.setAttribute("id",e),e)},Bs=n=>n.replace(/[\\"']/g,"\\$&"),pt=(n,e)=>{e&&n.append(e)};function Ns(n,e){var t=Object.assign({},Cs,e),i=t.dataAttr,r=t.labelField,s=t.valueField,o=t.disabledField,f=t.optgroupField,y=t.optgroupLabelField,g=t.optgroupValueField,d=n.tagName.toLowerCase(),E=n.getAttribute("placeholder")||n.getAttribute("data-placeholder");if(!E&&!t.allowEmptyOption){let M=n.querySelector('option[value=""]');M&&(E=M.textContent)}var N={placeholder:E,options:[],optgroups:[],items:[],maxItems:null},W=()=>{var M,A=N.options,x={},R=1,D=w=>{var S=Object.assign({},w.dataset),p=i&&S[i];return typeof p=="string"&&p.length&&(S=Object.assign(S,JSON.parse(p))),S},P=(w,S)=>{var p=Ye(w.value);if(p!=null&&!(!p&&!t.allowEmptyOption)){if(x.hasOwnProperty(p)){if(S){var _=x[p][f];_?Array.isArray(_)?_.push(S):x[p][f]=[_,S]:x[p][f]=S}}else{var h=D(w);h[r]=h[r]||w.textContent,h[s]=h[s]||p,h[o]=h[o]||w.disabled,h[f]=h[f]||S,h.$option=w,x[p]=h,A.push(h)}w.selected&&N.items.push(p)}},Q=w=>{var S,p;p=D(w),p[y]=p[y]||w.getAttribute("label")||"",p[g]=p[g]||R++,p[o]=p[o]||w.disabled,N.optgroups.push(p),S=p[g],bt(w.children,_=>{P(_,S)})};N.maxItems=n.hasAttribute("multiple")?null:1,bt(n.children,w=>{M=w.tagName.toLowerCase(),M==="optgroup"?Q(w):M==="option"&&P(w)})},T=()=>{const M=n.getAttribute(i);if(M)N.options=JSON.parse(M),bt(N.options,x=>{N.items.push(x[s])});else{var A=n.value.trim()||"";if(!t.allowEmptyOption&&!A.length)return;const x=A.split(t.delimiter);bt(x,R=>{const D={};D[r]=R,D[s]=R,N.options.push(D)}),N.items=x}};return d==="select"?W():T(),Object.assign({},Cs,N,e)}var xs=0;class Fe extends Ia(wa){constructor(e,t){super(),this.control_input=void 0,this.wrapper=void 0,this.dropdown=void 0,this.control=void 0,this.dropdown_content=void 0,this.focus_node=void 0,this.order=0,this.settings=void 0,this.input=void 0,this.tabIndex=void 0,this.is_select_tag=void 0,this.rtl=void 0,this.inputId=void 0,this._destroy=void 0,this.sifter=void 0,this.isOpen=!1,this.isDisabled=!1,this.isRequired=void 0,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.currentResults=void 0,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],xs++;var i,r=Se(e);if(r.tomselect)throw new Error("Tom Select already initialized on this element");r.tomselect=this;var s=window.getComputedStyle&&window.getComputedStyle(r,null);i=s.getPropertyValue("direction");const o=Ns(r,t);this.settings=o,this.input=r,this.tabIndex=r.tabIndex||0,this.is_select_tag=r.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(i),this.inputId=gi(r,"tomselect-"+xs),this.isRequired=r.required,this.sifter=new Ga(this.options,{diacritics:o.diacritics}),o.mode=o.mode||(o.maxItems===1?"single":"multi"),typeof o.hideSelected!="boolean"&&(o.hideSelected=o.mode==="multi"),typeof o.hidePlaceholder!="boolean"&&(o.hidePlaceholder=o.mode!=="multi");var f=o.createFilter;typeof f!="function"&&(typeof f=="string"&&(f=new RegExp(f)),f instanceof RegExp?o.createFilter=A=>f.test(A):o.createFilter=A=>this.settings.duplicates||!this.options[A]),this.initializePlugins(o.plugins),this.setupCallbacks(),this.setupTemplates();const y=Se("<div>"),g=Se("<div>"),d=this._render("dropdown"),E=Se('<div role="listbox" tabindex="-1">'),N=this.input.getAttribute("class")||"",W=o.mode;var T;if(Me(y,o.wrapperClass,N,W),Me(g,o.controlClass),pt(y,g),Me(d,o.dropdownClass,W),o.copyClassesToDropdown&&Me(d,N),Me(E,o.dropdownContentClass),pt(d,E),Se(o.dropdownParent||y).appendChild(d),cr(o.controlInput)){T=Se(o.controlInput);var M=["autocorrect","autocapitalize","autocomplete"];$e(M,A=>{r.getAttribute(A)&&Ee(T,{[A]:r.getAttribute(A)})}),T.tabIndex=-1,g.appendChild(T),this.focus_node=T}else o.controlInput?(T=Se(o.controlInput),this.focus_node=T):(T=Se("<input/>"),this.focus_node=g);this.wrapper=y,this.dropdown=d,this.dropdown_content=E,this.control=g,this.control_input=T,this.setup()}setup(){const e=this,t=e.settings,i=e.control_input,r=e.dropdown,s=e.dropdown_content,o=e.wrapper,f=e.control,y=e.input,g=e.focus_node,d={passive:!0},E=e.inputId+"-ts-dropdown";Ee(s,{id:E}),Ee(g,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":E});const N=gi(g,e.inputId+"-ts-control"),W="label[for='"+Ha(e.inputId)+"']",T=document.querySelector(W),M=e.focus.bind(e);if(T){Oe(T,"click",M),Ee(T,{for:N});const R=gi(T,e.inputId+"-ts-label");Ee(g,{"aria-labelledby":R}),Ee(s,{"aria-labelledby":R})}if(o.style.width=y.style.width,e.plugins.names.length){const R="plugin-"+e.plugins.names.join(" plugin-");Me([o,r],R)}(t.maxItems===null||t.maxItems>1)&&e.is_select_tag&&Ee(y,{multiple:"multiple"}),t.placeholder&&Ee(i,{placeholder:t.placeholder}),!t.splitOn&&t.delimiter&&(t.splitOn=new RegExp("\\s*"+Gt(t.delimiter)+"+\\s*")),t.load&&t.loadThrottle&&(t.load=el(t.load,t.loadThrottle)),e.control_input.type=y.type,Oe(r,"mousemove",()=>{e.ignoreHover=!1}),Oe(r,"mouseenter",R=>{var D=fn(R.target,"[data-selectable]",r);D&&e.onOptionHover(R,D)},{capture:!0}),Oe(r,"click",R=>{const D=fn(R.target,"[data-selectable]");D&&(e.onOptionSelect(R,D),he(R,!0))}),Oe(f,"click",R=>{var D=fn(R.target,"[data-ts-item]",f);if(D&&e.onItemSelect(R,D)){he(R,!0);return}i.value==""&&(e.onClick(),he(R,!0))}),Oe(g,"keydown",R=>e.onKeyDown(R)),Oe(i,"keypress",R=>e.onKeyPress(R)),Oe(i,"input",R=>e.onInput(R)),Oe(g,"blur",R=>e.onBlur(R)),Oe(g,"focus",R=>e.onFocus(R)),Oe(i,"paste",R=>e.onPaste(R));const A=R=>{const D=R.composedPath()[0];if(!o.contains(D)&&!r.contains(D)){e.isFocused&&e.blur(),e.inputState();return}D==i&&e.isOpen?R.stopPropagation():he(R,!0)},x=()=>{e.isOpen&&e.positionDropdown()};Oe(document,"mousedown",A),Oe(window,"scroll",x,d),Oe(window,"resize",x,d),this._destroy=()=>{document.removeEventListener("mousedown",A),window.removeEventListener("scroll",x),window.removeEventListener("resize",x),T&&T.removeEventListener("click",M)},this.revertSettings={innerHTML:y.innerHTML,tabIndex:y.tabIndex},y.tabIndex=-1,y.insertAdjacentElement("afterend",e.wrapper),e.sync(!1),t.items=[],delete t.optgroups,delete t.options,Oe(y,"invalid",()=>{e.isValid&&(e.isValid=!1,e.isInvalid=!0,e.refreshState())}),e.updateOriginalInput(),e.refreshItems(),e.close(!1),e.inputState(),e.isSetup=!0,y.disabled?e.disable():e.enable(),e.on("change",this.onChange),Me(y,"tomselected","ts-hidden-accessible"),e.trigger("initialize"),t.preload===!0&&e.preload()}setupOptions(e=[],t=[]){this.addOptions(e),$e(t,i=>{this.registerOptionGroup(i)})}setupTemplates(){var e=this,t=e.settings.labelField,i=e.settings.optgroupLabelField,r={optgroup:s=>{let o=document.createElement("div");return o.className="optgroup",o.appendChild(s.options),o},optgroup_header:(s,o)=>'<div class="optgroup-header">'+o(s[i])+"</div>",option:(s,o)=>"<div>"+o(s[t])+"</div>",item:(s,o)=>"<div>"+o(s[t])+"</div>",option_create:(s,o)=>'<div class="create">Add <strong>'+o(s.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};e.settings.render=Object.assign({},r,e.settings.render)}setupCallbacks(){var e,t,i={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in i)t=this.settings[i[e]],t&&this.on(e,t)}sync(e=!0){const t=this,i=e?Ns(t.input,{delimiter:t.settings.delimiter}):t.settings;t.setupOptions(i.options,i.optgroups),t.setValue(i.items||[],!0),t.lastQuery=null}onClick(){var e=this;if(e.activeItems.length>0){e.clearActiveItems(),e.focus();return}e.isFocused&&e.isOpen?e.blur():e.focus()}onMouseDown(){}onChange(){pi(this.input,"input"),pi(this.input,"change")}onPaste(e){var t=this;if(t.isInputHidden||t.isLocked){he(e);return}t.settings.splitOn&&setTimeout(()=>{var i=t.inputValue();if(i.match(t.settings.splitOn)){var r=i.trim().split(t.settings.splitOn);$e(r,s=>{Ye(s)&&(this.options[s]?t.addItem(s):t.createItem(s))})}},0)}onKeyPress(e){var t=this;if(t.isLocked){he(e);return}var i=String.fromCharCode(e.keyCode||e.which);if(t.settings.create&&t.settings.mode==="multi"&&i===t.settings.delimiter){t.createItem(),he(e);return}}onKeyDown(e){var t=this;if(t.ignoreHover=!0,t.isLocked){e.keyCode!==Ai&&he(e);return}switch(e.keyCode){case Ka:if(ht(un,e)&&t.control_input.value==""){he(e),t.selectAll();return}break;case hr:t.isOpen&&(he(e,!0),t.close()),t.clearActiveItems();return;case Za:if(!t.isOpen&&t.hasOptions)t.open();else if(t.activeOption){let i=t.getAdjacent(t.activeOption,1);i&&t.setActiveOption(i)}he(e);return;case qa:if(t.activeOption){let i=t.getAdjacent(t.activeOption,-1);i&&t.setActiveOption(i)}he(e);return;case za:t.canSelect(t.activeOption)?(t.onOptionSelect(e,t.activeOption),he(e)):(t.settings.create&&t.createItem()||document.activeElement==t.control_input&&t.isOpen)&&he(e);return;case Ti:t.advanceSelection(-1,e);return;case pr:t.advanceSelection(1,e);return;case Ai:t.settings.selectOnTab&&(t.canSelect(t.activeOption)&&(t.onOptionSelect(e,t.activeOption),he(e)),t.settings.create&&t.createItem()&&he(e));return;case Ss:case Qa:t.deleteSelection(e);return}t.isInputHidden&&!ht(un,e)&&he(e)}onInput(e){var t=this;if(!t.isLocked){var i=t.inputValue();t.lastValue!==i&&(t.lastValue=i,t.settings.shouldLoad.call(t,i)&&t.load(i),t.refreshOptions(),t.trigger("type",i))}}onOptionHover(e,t){this.ignoreHover||this.setActiveOption(t,!1)}onFocus(e){var t=this,i=t.isFocused;if(t.isDisabled){t.blur(),he(e);return}t.ignoreFocus||(t.isFocused=!0,t.settings.preload==="focus"&&t.preload(),i||t.trigger("focus"),t.activeItems.length||(t.showInput(),t.refreshOptions(!!t.settings.openOnFocus)),t.refreshState())}onBlur(e){if(document.hasFocus()!==!1){var t=this;if(t.isFocused){t.isFocused=!1,t.ignoreFocus=!1;var i=()=>{t.close(),t.setActiveItem(),t.setCaret(t.items.length),t.trigger("blur")};t.settings.create&&t.settings.createOnBlur?t.createItem(null,i):i()}}}onOptionSelect(e,t){var i,r=this;t.parentElement&&t.parentElement.matches("[data-disabled]")||(t.classList.contains("create")?r.createItem(null,()=>{r.settings.closeAfterSelect&&r.close()}):(i=t.dataset.value,typeof i<"u"&&(r.lastQuery=null,r.addItem(i),r.settings.closeAfterSelect&&r.close(),!r.settings.hideSelected&&e.type&&/click/.test(e.type)&&r.setActiveOption(t))))}canSelect(e){return!!(this.isOpen&&e&&this.dropdown_content.contains(e))}onItemSelect(e,t){var i=this;return!i.isLocked&&i.settings.mode==="multi"?(he(e),i.setActiveItem(t,e),!0):!1}canLoad(e){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(e))}load(e){const t=this;if(!t.canLoad(e))return;Me(t.wrapper,t.settings.loadingClass),t.loading++;const i=t.loadCallback.bind(t);t.settings.load.call(t,e,i)}loadCallback(e,t){const i=this;i.loading=Math.max(i.loading-1,0),i.lastQuery=null,i.clearActiveOption(),i.setupOptions(e,t),i.refreshOptions(i.isFocused&&!i.isInputHidden),i.loading||ot(i.wrapper,i.settings.loadingClass),i.trigger("load",e,t)}preload(){var e=this.wrapper.classList;e.contains("preloaded")||(e.add("preloaded"),this.load(""))}setTextboxValue(e=""){var t=this.control_input,i=t.value!==e;i&&(t.value=e,pi(t,"update"),this.lastValue=e)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(e,t){var i=t?[]:["change"];Rs(this,i,()=>{this.clear(t),this.addItems(e,t)})}setMaxItems(e){e===0&&(e=null),this.settings.maxItems=e,this.refreshState()}setActiveItem(e,t){var i=this,r,s,o,f,y,g;if(i.settings.mode!=="single"){if(!e){i.clearActiveItems(),i.isFocused&&i.showInput();return}if(r=t&&t.type.toLowerCase(),r==="click"&&ht("shiftKey",t)&&i.activeItems.length){for(g=i.getLastActive(),o=Array.prototype.indexOf.call(i.control.children,g),f=Array.prototype.indexOf.call(i.control.children,e),o>f&&(y=o,o=f,f=y),s=o;s<=f;s++)e=i.control.children[s],i.activeItems.indexOf(e)===-1&&i.setActiveItemClass(e);he(t)}else r==="click"&&ht(un,t)||r==="keydown"&&ht("shiftKey",t)?e.classList.contains("active")?i.removeActiveItem(e):i.setActiveItemClass(e):(i.clearActiveItems(),i.setActiveItemClass(e));i.hideInput(),i.isFocused||i.focus()}}setActiveItemClass(e){const t=this,i=t.control.querySelector(".last-active");i&&ot(i,"last-active"),Me(e,"active last-active"),t.trigger("item_select",e),t.activeItems.indexOf(e)==-1&&t.activeItems.push(e)}removeActiveItem(e){var t=this.activeItems.indexOf(e);this.activeItems.splice(t,1),ot(e,"active")}clearActiveItems(){ot(this.activeItems,"active"),this.activeItems=[]}setActiveOption(e,t=!0){e!==this.activeOption&&(this.clearActiveOption(),e&&(this.activeOption=e,Ee(this.focus_node,{"aria-activedescendant":e.getAttribute("id")}),Ee(e,{"aria-selected":"true"}),Me(e,"active"),t&&this.scrollToOption(e)))}scrollToOption(e,t){if(!e)return;const i=this.dropdown_content,r=i.clientHeight,s=i.scrollTop||0,o=e.offsetHeight,f=e.getBoundingClientRect().top-i.getBoundingClientRect().top+s;f+o>r+s?this.scroll(f-r+o,t):f<s&&this.scroll(f,t)}scroll(e,t){const i=this.dropdown_content;t&&(i.style.scrollBehavior=t),i.scrollTop=e,i.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(ot(this.activeOption,"active"),Ee(this.activeOption,{"aria-selected":null})),this.activeOption=null,Ee(this.focus_node,{"aria-activedescendant":null})}selectAll(){const e=this;if(e.settings.mode==="single")return;const t=e.controlChildren();t.length&&(e.hideInput(),e.close(),e.activeItems=t,$e(t,i=>{e.setActiveItemClass(i)}))}inputState(){var e=this;e.control.contains(e.control_input)&&(Ee(e.control_input,{placeholder:e.settings.placeholder}),e.activeItems.length>0||!e.isFocused&&e.settings.hidePlaceholder&&e.items.length>0?(e.setTextboxValue(),e.isInputHidden=!0):(e.settings.hidePlaceholder&&e.items.length>0&&Ee(e.control_input,{placeholder:""}),e.isInputHidden=!1),e.wrapper.classList.toggle("input-hidden",e.isInputHidden))}hideInput(){this.inputState()}showInput(){this.inputState()}inputValue(){return this.control_input.value.trim()}focus(){var e=this;e.isDisabled||(e.ignoreFocus=!0,e.control_input.offsetWidth?e.control_input.focus():e.focus_node.focus(),setTimeout(()=>{e.ignoreFocus=!1,e.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(e){return this.sifter.getScoreFunction(e,this.getSearchOptions())}getSearchOptions(){var e=this.settings,t=e.sortField;return typeof e.sortField=="string"&&(t=[{field:e.sortField}]),{fields:e.searchField,conjunction:e.searchConjunction,sort:t,nesting:e.nesting}}search(e){var t,i,r=this,s=this.getSearchOptions();if(r.settings.score&&(i=r.settings.score.call(r,e),typeof i!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return e!==r.lastQuery?(r.lastQuery=e,t=r.sifter.search(e,Object.assign(s,{score:i})),r.currentResults=t):t=Object.assign({},r.currentResults),r.settings.hideSelected&&(t.items=t.items.filter(o=>{let f=Ye(o.id);return!(f&&r.items.indexOf(f)!==-1)})),t}refreshOptions(e=!0){var t,i,r,s,o,f,y,g,d,E;const N={},W=[];var T=this,M=T.inputValue();const A=M===T.lastQuery||M==""&&T.lastQuery==null;var x=T.search(M),R=null,D=T.settings.shouldOpen||!1,P=T.dropdown_content;for(A&&(R=T.activeOption,R&&(d=R.closest("[data-group]"))),s=x.items.length,typeof T.settings.maxOptions=="number"&&(s=Math.min(s,T.settings.maxOptions)),s>0&&(D=!0),t=0;t<s;t++){let w=x.items[t];if(!w)continue;let S=w.id,p=T.options[S];if(p===void 0)continue;let _=hn(S),h=T.getOption(_,!0);for(T.settings.hideSelected||h.classList.toggle("selected",T.items.includes(_)),o=p[T.settings.optgroupField]||"",f=Array.isArray(o)?o:[o],i=0,r=f&&f.length;i<r;i++){o=f[i],T.optgroups.hasOwnProperty(o)||(o="");let b=N[o];b===void 0&&(b=document.createDocumentFragment(),W.push(o)),i>0&&(h=h.cloneNode(!0),Ee(h,{id:p.$id+"-clone-"+i,"aria-selected":null}),h.classList.add("ts-cloned"),ot(h,"active"),T.activeOption&&T.activeOption.dataset.value==S&&d&&d.dataset.group===o.toString()&&(R=h)),b.appendChild(h),N[o]=b}}T.settings.lockOptgroupOrder&&W.sort((w,S)=>{const p=T.optgroups[w],_=T.optgroups[S],h=p&&p.$order||0,b=_&&_.$order||0;return h-b}),y=document.createDocumentFragment(),$e(W,w=>{let S=N[w];if(!S||!S.children.length)return;let p=T.optgroups[w];if(p!==void 0){let _=document.createDocumentFragment(),h=T.render("optgroup_header",p);pt(_,h),pt(_,S);let b=T.render("optgroup",{group:p,options:_});pt(y,b)}else pt(y,S)}),P.innerHTML="",pt(P,y),T.settings.highlight&&(Xa(P),x.query.length&&x.tokens.length&&$e(x.tokens,w=>{Ya(P,w.regex)}));var Q=w=>{let S=T.render(w,{input:M});return S&&(D=!0,P.insertBefore(S,P.firstChild)),S};if(T.loading?Q("loading"):T.settings.shouldLoad.call(T,M)?x.items.length===0&&Q("no_results"):Q("not_loading"),g=T.canCreate(M),g&&(E=Q("option_create")),T.hasOptions=x.items.length>0||g,D){if(x.items.length>0){if(!R&&T.settings.mode==="single"&&T.items[0]!=null&&(R=T.getOption(T.items[0])),!P.contains(R)){let w=0;E&&!T.settings.addPrecedence&&(w=1),R=T.selectable()[w]}}else E&&(R=E);e&&!T.isOpen&&(T.open(),T.scrollToOption(R,"auto")),T.setActiveOption(R)}else T.clearActiveOption(),e&&T.isOpen&&T.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(e,t=!1){const i=this;if(Array.isArray(e))return i.addOptions(e,t),!1;const r=Ye(e[i.settings.valueField]);return r===null||i.options.hasOwnProperty(r)?!1:(e.$order=e.$order||++i.order,e.$id=i.inputId+"-opt-"+e.$order,i.options[r]=e,i.lastQuery=null,t&&(i.userOptions[r]=t,i.trigger("option_add",r,e)),r)}addOptions(e,t=!1){$e(e,i=>{this.addOption(i,t)})}registerOption(e){return this.addOption(e)}registerOptionGroup(e){var t=Ye(e[this.settings.optgroupValueField]);return t===null?!1:(e.$order=e.$order||++this.order,this.optgroups[t]=e,t)}addOptionGroup(e,t){var i;t[this.settings.optgroupValueField]=e,(i=this.registerOptionGroup(t))&&this.trigger("optgroup_add",i,t)}removeOptionGroup(e){this.optgroups.hasOwnProperty(e)&&(delete this.optgroups[e],this.clearCache(),this.trigger("optgroup_remove",e))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(e,t){const i=this;var r,s;const o=Ye(e),f=Ye(t[i.settings.valueField]);if(o===null)return;const y=i.options[o];if(y==null)return;if(typeof f!="string")throw new Error("Value must be set in option data");const g=i.getOption(o),d=i.getItem(o);if(t.$order=t.$order||y.$order,delete i.options[o],i.uncacheValue(f),i.options[f]=t,g){if(i.dropdown_content.contains(g)){const E=i._render("option",t);Ii(g,E),i.activeOption===g&&i.setActiveOption(E)}g.remove()}d&&(s=i.items.indexOf(o),s!==-1&&i.items.splice(s,1,f),r=i._render("item",t),d.classList.contains("active")&&Me(r,"active"),Ii(d,r)),i.lastQuery=null}removeOption(e,t){const i=this;e=hn(e),i.uncacheValue(e),delete i.userOptions[e],delete i.options[e],i.lastQuery=null,i.trigger("option_remove",e),i.removeItem(e,t)}clearOptions(e){const t=(e||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const i={};$e(this.options,(r,s)=>{t(r,s)&&(i[s]=r)}),this.options=this.sifter.items=i,this.lastQuery=null,this.trigger("option_clear")}clearFilter(e,t){return this.items.indexOf(t)>=0}getOption(e,t=!1){const i=Ye(e);if(i===null)return null;const r=this.options[i];if(r!=null){if(r.$div)return r.$div;if(t)return this._render("option",r)}return null}getAdjacent(e,t,i="option"){var r=this,s;if(!e)return null;i=="item"?s=r.controlChildren():s=r.dropdown_content.querySelectorAll("[data-selectable]");for(let o=0;o<s.length;o++)if(s[o]==e)return t>0?s[o+1]:s[o-1];return null}getItem(e){if(typeof e=="object")return e;var t=Ye(e);return t!==null?this.control.querySelector(`[data-value="${Bs(t)}"]`):null}addItems(e,t){var i=this,r=Array.isArray(e)?e:[e];r=r.filter(o=>i.items.indexOf(o)===-1);const s=r[r.length-1];r.forEach(o=>{i.isPending=o!==s,i.addItem(o,t)})}addItem(e,t){var i=t?[]:["change","dropdown_close"];Rs(this,i,()=>{var r,s;const o=this,f=o.settings.mode,y=Ye(e);if(!(y&&o.items.indexOf(y)!==-1&&(f==="single"&&o.close(),f==="single"||!o.settings.duplicates))&&!(y===null||!o.options.hasOwnProperty(y))&&(f==="single"&&o.clear(t),!(f==="multi"&&o.isFull()))){if(r=o._render("item",o.options[y]),o.control.contains(r)&&(r=r.cloneNode(!0)),s=o.isFull(),o.items.splice(o.caretPos,0,y),o.insertAtCaret(r),o.isSetup){if(!o.isPending&&o.settings.hideSelected){let g=o.getOption(y),d=o.getAdjacent(g,1);d&&o.setActiveOption(d)}!o.isPending&&!o.settings.closeAfterSelect&&o.refreshOptions(o.isFocused&&f!=="single"),o.settings.closeAfterSelect!=!1&&o.isFull()?o.close():o.isPending||o.positionDropdown(),o.trigger("item_add",y,r),o.isPending||o.updateOriginalInput({silent:t})}(!o.isPending||!s&&o.isFull())&&(o.inputState(),o.refreshState())}})}removeItem(e=null,t){const i=this;if(e=i.getItem(e),!e)return;var r,s;const o=e.dataset.value;r=Rn(e),e.remove(),e.classList.contains("active")&&(s=i.activeItems.indexOf(e),i.activeItems.splice(s,1),ot(e,"active")),i.items.splice(r,1),i.lastQuery=null,!i.settings.persist&&i.userOptions.hasOwnProperty(o)&&i.removeOption(o,t),r<i.caretPos&&i.setCaret(i.caretPos-1),i.updateOriginalInput({silent:t}),i.refreshState(),i.positionDropdown(),i.trigger("item_remove",o,e)}createItem(e=null,t=()=>{}){arguments.length===3&&(t=arguments[2]),typeof t!="function"&&(t=()=>{});var i=this,r=i.caretPos,s;if(e=e||i.inputValue(),!i.canCreate(e))return t(),!1;i.lock();var o=!1,f=y=>{if(i.unlock(),!y||typeof y!="object")return t();var g=Ye(y[i.settings.valueField]);if(typeof g!="string")return t();i.setTextboxValue(),i.addOption(y,!0),i.setCaret(r),i.addItem(g),t(y),o=!0};return typeof i.settings.create=="function"?s=i.settings.create.call(this,e,f):s={[i.settings.labelField]:e,[i.settings.valueField]:e},o||f(s),!0}refreshItems(){var e=this;e.lastQuery=null,e.isSetup&&e.addItems(e.items),e.updateOriginalInput(),e.refreshState()}refreshState(){const e=this;e.refreshValidityState();const t=e.isFull(),i=e.isLocked;e.wrapper.classList.toggle("rtl",e.rtl);const r=e.wrapper.classList;r.toggle("focus",e.isFocused),r.toggle("disabled",e.isDisabled),r.toggle("required",e.isRequired),r.toggle("invalid",!e.isValid),r.toggle("locked",i),r.toggle("full",t),r.toggle("input-active",e.isFocused&&!e.isInputHidden),r.toggle("dropdown-active",e.isOpen),r.toggle("has-options",Wa(e.options)),r.toggle("has-items",e.items.length>0)}refreshValidityState(){var e=this;e.input.validity&&(e.isValid=e.input.validity.valid,e.isInvalid=!e.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(e={}){const t=this;var i,r;const s=t.input.querySelector('option[value=""]');if(t.is_select_tag){let g=function(d,E,N){return d||(d=Se('<option value="'+pn(E)+'">'+pn(N)+"</option>")),d!=s&&t.input.append(d),f.push(d),(d!=s||y>0)&&(d.selected=!0),d};var o=g;const f=[],y=t.input.querySelectorAll("option:checked").length;t.input.querySelectorAll("option:checked").forEach(d=>{d.selected=!1}),t.items.length==0&&t.settings.mode=="single"?g(s,"",""):t.items.forEach(d=>{if(i=t.options[d],r=i[t.settings.labelField]||"",f.includes(i.$option)){const E=t.input.querySelector(`option[value="${Bs(d)}"]:not(:checked)`);g(E,d,r)}else i.$option=g(i.$option,d,r)})}else t.input.value=t.getValue();t.isSetup&&(e.silent||t.trigger("change",t.getValue()))}open(){var e=this;e.isLocked||e.isOpen||e.settings.mode==="multi"&&e.isFull()||(e.isOpen=!0,Ee(e.focus_node,{"aria-expanded":"true"}),e.refreshState(),ln(e.dropdown,{visibility:"hidden",display:"block"}),e.positionDropdown(),ln(e.dropdown,{visibility:"visible",display:"block"}),e.focus(),e.trigger("dropdown_open",e.dropdown))}close(e=!0){var t=this,i=t.isOpen;e&&(t.setTextboxValue(),t.settings.mode==="single"&&t.items.length&&t.hideInput()),t.isOpen=!1,Ee(t.focus_node,{"aria-expanded":"false"}),ln(t.dropdown,{display:"none"}),t.settings.hideSelected&&t.clearActiveOption(),t.refreshState(),i&&t.trigger("dropdown_close",t.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var e=this.control,t=e.getBoundingClientRect(),i=e.offsetHeight+t.top+window.scrollY,r=t.left+window.scrollX;ln(this.dropdown,{width:t.width+"px",top:i+"px",left:r+"px"})}}clear(e){var t=this;if(t.items.length){var i=t.controlChildren();$e(i,r=>{t.removeItem(r,!0)}),t.showInput(),e||t.updateOriginalInput(),t.trigger("clear")}}insertAtCaret(e){const t=this,i=t.caretPos,r=t.control;r.insertBefore(e,r.children[i]||null),t.setCaret(i+1)}deleteSelection(e){var t,i,r,s,o=this;t=e&&e.keyCode===Ss?-1:1,i=tl(o.control_input);const f=[];if(o.activeItems.length)s=bs(o.activeItems,t),r=Rn(s),t>0&&r++,$e(o.activeItems,y=>f.push(y));else if((o.isFocused||o.settings.mode==="single")&&o.items.length){const y=o.controlChildren();let g;t<0&&i.start===0&&i.length===0?g=y[o.caretPos-1]:t>0&&i.start===o.inputValue().length&&(g=y[o.caretPos]),g!==void 0&&f.push(g)}if(!o.shouldDelete(f,e))return!1;for(he(e,!0),typeof r<"u"&&o.setCaret(r);f.length;)o.removeItem(f.pop());return o.showInput(),o.positionDropdown(),o.refreshOptions(!1),!0}shouldDelete(e,t){const i=e.map(r=>r.dataset.value);return!(!i.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(i,t)===!1)}advanceSelection(e,t){var i,r,s=this;s.rtl&&(e*=-1),!s.inputValue().length&&(ht(un,t)||ht("shiftKey",t)?(i=s.getLastActive(e),i?i.classList.contains("active")?r=s.getAdjacent(i,e,"item"):r=i:e>0?r=s.control_input.nextElementSibling:r=s.control_input.previousElementSibling,r&&(r.classList.contains("active")&&s.removeActiveItem(i),s.setActiveItemClass(r))):s.moveCaret(e))}moveCaret(e){}getLastActive(e){let t=this.control.querySelector(".last-active");if(t)return t;var i=this.control.querySelectorAll(".active");if(i)return bs(i,e)}setCaret(e){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.isLocked=!0,this.refreshState()}unlock(){this.isLocked=!1,this.refreshState()}disable(){var e=this;e.input.disabled=!0,e.control_input.disabled=!0,e.focus_node.tabIndex=-1,e.isDisabled=!0,this.close(),e.lock()}enable(){var e=this;e.input.disabled=!1,e.control_input.disabled=!1,e.focus_node.tabIndex=e.tabIndex,e.isDisabled=!1,e.unlock()}destroy(){var e=this,t=e.revertSettings;e.trigger("destroy"),e.off(),e.wrapper.remove(),e.dropdown.remove(),e.input.innerHTML=t.innerHTML,e.input.tabIndex=t.tabIndex,ot(e.input,"tomselected","ts-hidden-accessible"),e._destroy(),delete e.input.tomselect}render(e,t){var i,r;const s=this;if(typeof this.settings.render[e]!="function"||(r=s.settings.render[e].call(this,t,pn),!r))return null;if(r=Se(r),e==="option"||e==="option_create"?t[s.settings.disabledField]?Ee(r,{"aria-disabled":"true"}):Ee(r,{"data-selectable":""}):e==="optgroup"&&(i=t.group[s.settings.optgroupValueField],Ee(r,{"data-group":i}),t.group[s.settings.disabledField]&&Ee(r,{"data-disabled":""})),e==="option"||e==="item"){const o=hn(t[s.settings.valueField]);Ee(r,{"data-value":o}),e==="item"?(Me(r,s.settings.itemClass),Ee(r,{"data-ts-item":""})):(Me(r,s.settings.optionClass),Ee(r,{role:"option",id:t.$id}),t.$div=r,s.options[o]=t)}return r}_render(e,t){const i=this.render(e,t);if(i==null)throw"HTMLElement expected";return i}clearCache(){$e(this.options,e=>{e.$div&&(e.$div.remove(),delete e.$div)})}uncacheValue(e){const t=this.getOption(e);t&&t.remove()}canCreate(e){return this.settings.create&&e.length>0&&this.settings.createFilter.call(this,e)}hook(e,t,i){var r=this,s=r[t];r[t]=function(){var o,f;return e==="after"&&(o=s.apply(r,arguments)),f=i.apply(r,arguments),e==="instead"?f:(e==="before"&&(o=s.apply(r,arguments)),o)}}}function nl(){Oe(this.input,"change",()=>{this.sync()})}function il(){var n=this,e=n.onOptionSelect;n.settings.hideSelected=!1;var t=function(r){setTimeout(()=>{var s=r.querySelector("input");s instanceof HTMLInputElement&&(r.classList.contains("selected")?s.checked=!0:s.checked=!1)},1)};n.hook("after","setupTemplates",()=>{var i=n.settings.render.option;n.settings.render.option=(r,s)=>{var o=Se(i.call(n,r,s)),f=document.createElement("input");f.addEventListener("click",function(g){he(g)}),f.type="checkbox";const y=Ye(r[n.settings.valueField]);return y&&n.items.indexOf(y)>-1&&(f.checked=!0),o.prepend(f),o}}),n.on("item_remove",i=>{var r=n.getOption(i);r&&(r.classList.remove("selected"),t(r))}),n.on("item_add",i=>{var r=n.getOption(i);r&&t(r)}),n.hook("instead","onOptionSelect",(i,r)=>{if(r.classList.contains("selected")){r.classList.remove("selected"),n.removeItem(r.dataset.value),n.refreshOptions(),he(i,!0);return}e.call(n,i,r),t(r)})}function sl(n){const e=this,t=Object.assign({className:"clear-button",title:"Clear All",html:i=>`<div class="${i.className}" title="${i.title}">&#10799;</div>`},n);e.on("initialize",()=>{var i=Se(t.html(t));i.addEventListener("click",r=>{e.isDisabled||(e.clear(),e.settings.mode==="single"&&e.settings.allowEmptyOption&&e.addItem(""),r.preventDefault(),r.stopPropagation())}),e.control.appendChild(i)})}function rl(){var n=this;if(!$.fn.sortable)throw new Error('The "drag_drop" plugin requires jQuery UI "sortable".');if(n.settings.mode==="multi"){var e=n.lock,t=n.unlock;n.hook("instead","lock",()=>{var i=$(n.control).data("sortable");return i&&i.disable(),e.call(n)}),n.hook("instead","unlock",()=>{var i=$(n.control).data("sortable");return i&&i.enable(),t.call(n)}),n.on("initialize",()=>{var i=$(n.control).sortable({items:"[data-value]",forcePlaceholderSize:!0,disabled:n.isLocked,start:(r,s)=>{s.placeholder.css("width",s.helper.css("width")),i.css({overflow:"visible"})},stop:()=>{i.css({overflow:"hidden"});var r=[];i.children("[data-value]").each(function(){this.dataset.value&&r.push(this.dataset.value)}),n.setValue(r)}})})}}function ol(n){const e=this,t=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:i=>'<div class="'+i.headerClass+'"><div class="'+i.titleRowClass+'"><span class="'+i.labelClass+'">'+i.title+'</span><a class="'+i.closeClass+'">&times;</a></div></div>'},n);e.on("initialize",()=>{var i=Se(t.html(t)),r=i.querySelector("."+t.closeClass);r&&r.addEventListener("click",s=>{he(s,!0),e.close()}),e.dropdown.insertBefore(i,e.dropdown.firstChild)})}function al(){var n=this;n.hook("instead","setCaret",e=>{n.settings.mode==="single"||!n.control.contains(n.control_input)?e=n.items.length:(e=Math.max(0,Math.min(n.items.length,e)),e!=n.caretPos&&!n.isPending&&n.controlChildren().forEach((t,i)=>{i<e?n.control_input.insertAdjacentElement("beforebegin",t):n.control.appendChild(t)})),n.caretPos=e}),n.hook("instead","moveCaret",e=>{if(!n.isFocused)return;const t=n.getLastActive(e);if(t){const i=Rn(t);n.setCaret(e>0?i+1:i),n.setActiveItem(),ot(t,"last-active")}else n.setCaret(n.caretPos+e)})}function ll(){const n=this;n.settings.shouldOpen=!0,n.hook("before","setup",()=>{n.focus_node=n.control,Me(n.control_input,"dropdown-input");const e=Se('<div class="dropdown-input-wrap">');e.append(n.control_input),n.dropdown.insertBefore(e,n.dropdown.firstChild);const t=Se('<input class="items-placeholder" tabindex="-1" />');t.placeholder=n.settings.placeholder||"",n.control.append(t)}),n.on("initialize",()=>{n.control_input.addEventListener("keydown",t=>{switch(t.keyCode){case hr:n.isOpen&&(he(t,!0),n.close()),n.clearActiveItems();return;case Ai:n.focus_node.tabIndex=-1;break}return n.onKeyDown.call(n,t)}),n.on("blur",()=>{n.focus_node.tabIndex=n.isDisabled?-1:n.tabIndex}),n.on("dropdown_open",()=>{n.control_input.focus()});const e=n.onBlur;n.hook("instead","onBlur",t=>{if(!(t&&t.relatedTarget==n.control_input))return e.call(n)}),Oe(n.control_input,"blur",()=>n.onBlur()),n.hook("before","close",()=>{n.isOpen&&n.focus_node.focus({preventScroll:!0})})})}function ul(){var n=this;n.on("initialize",()=>{var e=document.createElement("span"),t=n.control_input;e.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",n.wrapper.appendChild(e);var i=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const s of i)e.style[s]=t.style[s];var r=()=>{e.textContent=t.value,t.style.width=e.clientWidth+"px"};r(),n.on("update item_add item_remove",r),Oe(t,"input",r),Oe(t,"keyup",r),Oe(t,"blur",r),Oe(t,"update",r)})}function cl(){var n=this,e=n.deleteSelection;this.hook("instead","deleteSelection",t=>n.activeItems.length?e.call(n,t):!1)}function dl(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}function fl(){var n=this,e=n.onKeyDown;n.hook("instead","onKeyDown",t=>{var i,r,s,o;if(!n.isOpen||!(t.keyCode===Ti||t.keyCode===pr))return e.call(n,t);n.ignoreHover=!0,o=fn(n.activeOption,"[data-group]"),i=Rn(n.activeOption,"[data-selectable]"),o&&(t.keyCode===Ti?o=o.previousSibling:o=o.nextSibling,o&&(s=o.querySelectorAll("[data-selectable]"),r=s[Math.min(s.length-1,i)],r&&n.setActiveOption(r)))})}function hl(n){const e=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},n);var t=this;if(e.append){var i='<a href="javascript:void(0)" class="'+e.className+'" tabindex="-1" title="'+pn(e.title)+'">'+e.label+"</a>";t.hook("after","setupTemplates",()=>{var r=t.settings.render.item;t.settings.render.item=(s,o)=>{var f=Se(r.call(t,s,o)),y=Se(i);return f.appendChild(y),Oe(y,"mousedown",g=>{he(g,!0)}),Oe(y,"click",g=>{he(g,!0),!t.isLocked&&t.shouldDelete([f],g)&&(t.removeItem(f),t.refreshOptions(!1),t.inputState())}),f}})}}function pl(n){const e=this,t=Object.assign({text:i=>i[e.settings.labelField]},n);e.on("item_remove",function(i){if(e.isFocused&&e.control_input.value.trim()===""){var r=e.options[i];r&&e.setTextboxValue(t.text.call(e,r))}})}function gl(){const n=this,e=n.canLoad,t=n.clearActiveOption,i=n.loadCallback;var r={},s,o=!1,f,y=[];if(n.settings.shouldLoadMore||(n.settings.shouldLoadMore=()=>{if(s.clientHeight/(s.scrollHeight-s.scrollTop)>.9)return!0;if(n.activeOption){var N=n.selectable(),W=Array.from(N).indexOf(n.activeOption);if(W>=N.length-2)return!0}return!1}),!n.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";n.settings.sortField=[{field:"$order"},{field:"$score"}];const g=E=>typeof n.settings.maxOptions=="number"&&s.children.length>=n.settings.maxOptions?!1:!!(E in r&&r[E]),d=(E,N)=>n.items.indexOf(N)>=0||y.indexOf(N)>=0;n.setNextUrl=(E,N)=>{r[E]=N},n.getUrl=E=>{if(E in r){const N=r[E];return r[E]=!1,N}return r={},n.settings.firstUrl.call(n,E)},n.hook("instead","clearActiveOption",()=>{if(!o)return t.call(n)}),n.hook("instead","canLoad",E=>E in r?g(E):e.call(n,E)),n.hook("instead","loadCallback",(E,N)=>{if(!o)n.clearOptions(d);else if(f){const W=E[0];W!==void 0&&(f.dataset.value=W[n.settings.valueField])}i.call(n,E,N),o=!1}),n.hook("after","refreshOptions",()=>{const E=n.lastValue;var N;g(E)?(N=n.render("loading_more",{query:E}),N&&(N.setAttribute("data-selectable",""),f=N)):E in r&&!s.querySelector(".no-results")&&(N=n.render("no_more_results",{query:E})),N&&(Me(N,n.settings.optionClass),s.append(N))}),n.on("initialize",()=>{y=Object.keys(n.options),s=n.dropdown_content,n.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},n.settings.render),s.addEventListener("scroll",()=>{n.settings.shouldLoadMore.call(n)&&g(n.lastValue)&&(o||(o=!0,n.load.call(n,n.lastValue)))})})}Fe.define("change_listener",nl);Fe.define("checkbox_options",il);Fe.define("clear_button",sl);Fe.define("drag_drop",rl);Fe.define("dropdown_header",ol);Fe.define("caret_position",al);Fe.define("dropdown_input",ll);Fe.define("input_autogrow",ul);Fe.define("no_backspace_delete",cl);Fe.define("no_active_items",dl);Fe.define("optgroup_columns",fl);Fe.define("remove_button",hl);Fe.define("restore_on_backspace",pl);Fe.define("virtual_scroll",gl);async function ml(n){const t=(await q.scene.local.getItems(r=>r.layer==="CHARACTER")).map(r=>r.id);let i=!1;for(const r of n){const s=r.metadata[`${L.EXTENSIONID}/metadata_ghosts`];if(s?.length>0){i=!0;const o=s.map(y=>y.id);for(const y of s){const g=y.metadata[`${L.EXTENSIONID}/viewers`];g&&(g.includes(Z.userId)?await q.scene.local.addItems([y]):t.includes(y.id)&&await q.scene.local.deleteItems([y.id]))}const f=t.filter(y=>!o.includes(y));f?.length>0&&await q.scene.local.deleteItems(f)}}i||await q.scene.local.deleteItems(t)}async function yl(){q.scene.local.onChange(async n=>{const e=n.filter(i=>i.layer=="CHARACTER");if(e.length===0)return;const t={};t[`${L.EXTENSIONID}/metadata_ghosts`]=e,await q.player.setMetadata(t)}),await q.contextMenu.create({id:`${L.EXTENSIONID}/context-menu`,icons:[{icon:"/ghost.svg",label:"Spectre",filter:{every:[{key:"layer",value:"CHARACTER"}]}}],async onClick(n){document.getElementById("spectreWarning").style.display="none";for(const e of n.items){const t=e,i=t.text?.plainText||t.name;await q.scene.items.deleteItems([t.id]),await q.scene.local.addItems([t]),Z.ghosts.push(t);const r=document.getElementById("ghostList"),s=document.createElement("tr");s.id=`tr-${t.id}`,s.className="ghost-table-entry",s.innerHTML=`<td class="token-name">${i}</td>
<td><select id="select-${t.id}" multiple autocomplete="off" /></td>
<td>&nbsp;&nbsp;&nbsp<input type="button" class="mysteryButton" id="deleteGhost-${t.id}" value="Delete"/></td>`,r.appendChild(s);const o=document.getElementById(`select-${t.id}`);for(const g of Z.players){const d=document.createElement("option");d.value=g.id,d.text=g.name,o.appendChild(d)}const f={plugins:{remove_button:{title:"Remove this item"}},allowEmptyOption:!0,placeholder:"Choose..",maxItems:null,create:!1,onDelete:async function(g,d){const E=d.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.id.slice(3);await q.scene.local.updateItems([E],N=>{const W=N[0].metadata[`${L.EXTENSIONID}/viewers`],T=W.findIndex(M=>M==g);W.splice(T,1),N[0].metadata[`${L.EXTENSIONID}/viewers`]=W})},onItemAdd:async function(g,d){const E=d.parentElement.parentElement.parentElement.parentElement.id.slice(3);await q.scene.local.updateItems([E],N=>{const W=N[0].metadata[`${L.EXTENSIONID}/viewers`];W?(W.push(g),N[0].metadata[`${L.EXTENSIONID}/viewers`]=W):N[0].metadata[`${L.EXTENSIONID}/viewers`]=[g]})}};new Fe(`#select-${t.id}`,f);const y=document.getElementById(`deleteGhost-${t.id}`);y.onclick=async()=>{const g=Z.ghosts.findIndex(d=>d.id===t.id);Z.ghosts.splice(g,1),s.remove(),await q.scene.local.updateItems([t.id],d=>{d[0].metadata[`${L.EXTENSIONID}/viewers`]=[]}),await q.scene.local.deleteItems([t.id])}}}})}const Ln=document.getElementById("app");Ln.innerHTML=`
  <div>
    <div>
      <div class="title">Smoke! ˣ Dynamic Fog&nbsp;&nbsp;</div>
      <input type="checkbox" id="vision_checkbox" class="large">
    </div>
    <hr>
    <div style="text-align: center;">
      <p><span id="map_size">Boundary Size: 
      <input type="number" id="mapWidth" name="Width" min="10" max="500"/> x 
      <input type="number" id="mapHeight" name="Height" min="10" max="500"/>
      <input type="button" id="mapSubmit" value="Update"/></span></p>
      <hr>
      <div class="visionTitle">Vision Radius</div>
      <p id="no_tokens_message">Enable vision on your character tokens.</p>
      <div id="token_list_div" style="display: block;">
        <table style="margin: auto; padding: 0;"><tbody id="token_list">
        </tbody></table>
      </div>
      </div>
      <hr>
      <div class="visionTitle">Spectres!</div>
      <div id="ghostContainer" style="display: block;">
      <div id="spectreWarning">Turning a token into a Spectre is one-way. You'll need to drag a new token in if you want it normal.</br>
      Enable vision here after it's been Spectred.</div>
        <table style="margin: auto; padding: 0; width: 100%">
        <colgroup>
            <col style="width: 50%;">
            <col style="width: 25%;">
            <col style="width: 25%;">
        </colgroup>
        <tbody id="ghostList">
        </tbody></table>
    <div id="debug_div" style="display: none;">
      <br><hr><br>
      <h2>Debug</h2>
      <h3>Performance Info</h3>
      <ul>
        <li><p>Compute time: <span id=compute_time>N/A</span></p></li>
        <li><p>Communication time: <span id=communication_time>N/A</span></p></li>
        <li><p>Cache hits/misses: <span id=cache_hits>?</span>/<span id=cache_misses>?</span></p></li>
      </ul>
    </div>
  </div>
`;Ln.style.textAlign="left";Ln.parentElement.style.placeItems="start";const gr=document.getElementById("vision_checkbox"),vl=document.getElementById("token_list"),ks=document.getElementById("no_tokens_message"),_l=document.getElementById("mapHeight"),El=document.getElementById("mapWidth"),Ol=document.getElementById("mapSubmit");async function wl(){gr.addEventListener("click",async n=>{if(!Z.ready||!n.target){n.preventDefault();return}const e=n.target;await q.scene.setMetadata({[`${L.EXTENSIONID}/visionEnabled`]:e.checked})},!1)}function gn(n){const e=n.filter(qs);Z.metadata&&(gr.checked=Z.metadata[`${L.EXTENSIONID}/visionEnabled`]==!0),e.length>0?ks.style.display="none":ks.style.display="block";const t=document.getElementsByClassName("token-table-entry"),i=[];for(const r of t){const s=r.id.slice(3);e.find(o=>o.id===s)===void 0&&i.push(r)}for(const r of i)r.remove();for(const r of e){const s=document.getElementById(`tr-${r.id}`);if(s){const o=s.getElementsByClassName("token-name")[0],f=s.getElementsByClassName("token-vision-range")[0],y=s.getElementsByClassName("unlimited-vision")[0];o&&(o.innerText=r.name),f&&(y.checked||(f.value=r.metadata[`${L.EXTENSIONID}/visionRange`]?r.metadata[`${L.EXTENSIONID}/visionRange`]:L.VISIONDEFAULT)),y&&(y.checked=!r.metadata[`${L.EXTENSIONID}/visionRange`]),y.checked?f.setAttribute("disabled","disabled"):f.removeAttribute("disabled")}else{const o=document.createElement("tr");o.id=`tr-${r.id}`,o.className="token-table-entry",o.innerHTML=`<td class="token-name">${r.name}</td><td><input class="token-vision-range" type="number" value=${L.VISIONDEFAULT}><span class="unit">ft</span></td><td>&nbsp;&nbsp;&infin;&nbsp<input type="checkbox" class="unlimited-vision"></td>`,vl.appendChild(o);const f=o.getElementsByClassName("token-vision-range")[0],y=o.getElementsByClassName("unlimited-vision")[0];f.addEventListener("change",async g=>{if(!g||!g.target)return;const d=g.target,E=parseInt(d.value);E<0&&(d.value="0"),E>999&&(d.value="999"),await q.scene.items.updateItems([r],N=>{N[0].metadata[`${L.EXTENSIONID}/visionRange`]=E})},!1),y.addEventListener("click",async g=>{if(!g||!g.target)return;let d=0;g.target.checked?f.setAttribute("disabled","disabled"):(d=parseInt(f.value),f.removeAttribute("disabled")),await q.scene.items.updateItems([r],N=>{N[0].metadata[`${L.EXTENSIONID}/visionRange`]=d})},!1)}}}async function Ds(n){let e,t;[Z.items,Z.metadata,Z.gridDpi,Z.gridScale,e,t]=await Promise.all([q.scene.items.getItems(),q.scene.getMetadata(),q.scene.grid.getDpi(),q.scene.grid.getScale(),q.scene.fog.getFilled(),q.scene.fog.getColor()]),await q.scene.items.deleteItems(Z.items.filter(wi).map(s=>s.id)),Z.gridScale=Z.gridScale.parsed.multiplier,Z.fog={filled:e,style:{color:t,strokeWidth:5}};let i;if(Z.items.filter(ea).length==0){const s=Z.items.filter(f=>f.layer=="MAP"&&f.type=="IMAGE"),o=s.map(f=>f.image.width*f.image.height/Math.pow(f.grid.dpi,2));i=s[o.indexOf(Math.max(...o))]}let r;Z.items.filter(Zs).length==0&&(r=Rt().width(Z.gridDpi*30).height(Z.gridDpi*30).shapeType("RECTANGLE").visible(!0).locked(!1).strokeColor("pink").fillOpacity(0).strokeDash([200,500]).strokeWidth(50).build(),r.metadata[`${L.EXTENSIONID}/isBackgroundImage`]=!0,r.id=L.GRIDID,Z.items.push(r)),n=="GM"&&(r&&await q.scene.items.addItems([r]),Ol.onclick=async()=>{await q.scene.items.updateItems([L.GRIDID],s=>{for(const o of s){const f=o;f.width=Z.gridDpi*+El.value,f.height=Z.gridDpi*+_l.value}})},gn(Z.items),i!==void 0&&await q.scene.items.updateItems([i],s=>{s[0].metadata[`${L.EXTENSIONID}/isBackgroundImage`]=!0}))}q.onReady(async()=>{await q.player.getRole().then(async n=>{n=="GM"?(Z.role="GM",await wl(),await ya(),await va(),await _a(),await yl()):(Ln.innerHTML="Configuration is GM-Access only.",await q.action.setHeight(90),await q.action.setWidth(320)),q.scene.fog.onChange(e=>{Z.fog=e}),q.scene.items.onChange(e=>{const t=e;Z.items=t,Z.ready&&(n=="GM"&&gn(t),Lt())}),Z.userId=await q.player.getId(),Z.players=await q.party.getPlayers(),q.party.onChange(e=>{Z.players=e,n==="PLAYER"&&ml(e)}),q.scene.grid.onChange(e=>{Z.gridDpi=e.dpi,Z.gridScale=parseInt(e.scale),Z.ready&&Lt()}),q.scene.onMetadataChange(e=>{Z.metadata=e,Z.ready&&Lt()}),q.scene.onReadyChange(e=>{Z.ready=e,e?(Ds(n),Lt()):n=="GM"&&gn([])}),Z.ready=await q.scene.isReady(),Z.ready?(Ds(n),Lt()):n=="GM"&&gn([])})});
